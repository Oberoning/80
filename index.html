<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ã‚ªãƒ¬ã‚ªãƒ¬Ultimate">
<title>ä¿ºã®ã‚ªãƒ¬ãƒ³ã‚¸ã‚³ãƒ¼ãƒˆ - v71.0 Ultimate Manual</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">

<script>
  // === ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ (SVG Data URI) ===
  const ICON_SVG = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23ff9f43%22 stroke=%22%23333%22 stroke-width=%223%22/><path d=%22M50 3 C50 3 80 20 80 50 C80 80 50 97 50 97 M3 50 C3 50 20 20 50 20 C80 20 97 50 97 50 M3 50 C3 50 20 80 50 80 C80 80 97 50 97 50%22 stroke=%22white%22 stroke-width=%224%22 fill=%22none%22/></svg>`;
  
  const link1 = document.createElement('link');
  link1.rel = 'icon';
  link1.href = ICON_SVG;
  document.head.appendChild(link1);

  const link2 = document.createElement('link');
  link2.rel = 'apple-touch-icon';
  link2.href = ICON_SVG;
  document.head.appendChild(link2);
</script>
<style>
  /* === UI Design: Canva-like Pop Style === */
  :root {
    --bg-color: #fff9f0; 
    --bg-dot: #ffeaa7;
    --text: #2d3436;
    --border-color: #2d3436; 
    
    --main: #48dbfb; 
    --accent: #ff9f43; 
    --win: #feca57; 
    --lose: #ff6b6b; 
    --ok: #1dd1a1; 
    
    --c-oh: #54a0ff;
    --c-mb: #1dd1a1;
    --c-s: #feca57;
    --c-l: #ff9f43;
  }

  body {
    font-family: "Zen Maru Gothic", sans-serif;
    background-color: var(--bg-color);
    background-image: radial-gradient(var(--bg-dot) 20%, transparent 20%);
    background-size: 20px 20px;
    color: var(--text);
    margin: 0;
    padding: 15px;
    padding-bottom: 140px;
    user-select: none;
    line-height: 1.6;
    -webkit-tap-highlight-color: transparent;
    overflow-x: hidden;
  }
  
  button {
    cursor: pointer;
    font-family: inherit;
    font-weight: bold;
    border: none;
    touch-action: manipulation;
    transition: all 0.1s;
  }
  
  button:active {
    transform: translateY(4px);
    box-shadow: none !important;
  }
  
  .view {
    display: none;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  .active {
    display: block;
  }
  
  @keyframes popIn {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .btn {
    width: 100%;
    padding: 16px;
    border-radius: 16px;
    color: #fff;
    font-size: 1.1rem;
    margin-top: 12px;
    border: 3px solid var(--border-color);
    box-shadow: 4px 4px 0 var(--border-color);
    text-shadow: 1px 1px 0 var(--border-color);
  }
  
  .btn-m { background: var(--main); }
  .btn-g { background: var(--ok); }
  .btn-r { background: var(--lose); }
  .btn-y { background: var(--accent); }
  .btn-s { background: #95a5a6; } 

  .header {
    background: #fff;
    padding: 20px;
    border-radius: 20px;
    margin-bottom: 20px;
    border: 3px solid var(--border-color);
    text-align: center;
    box-shadow: 6px 6px 0 rgba(0,0,0,0.1);
    position: relative;
  }
  
  /* Buttons in Header */
  #btn-config {
    position: absolute;
    top: -10px;
    left: -10px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #fff;
    color: var(--text);
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    border: 3px solid var(--border-color);
    box-shadow: 3px 3px 0 var(--border-color);
  }
  
  #btn-sound {
    position: absolute;
    top: -10px;
    left: -10px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #fff;
    color: var(--text);
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    border: 3px solid var(--border-color);
    box-shadow: 3px 3px 0 var(--border-color);
  }
  #btn-sound.on {
    background: var(--accent);
    color: #fff;
  }

  /* Note Button */
  #btn-note {
    position: absolute;
    top: 45px;
    right: 60px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #feca57;
    color: #fff;
    font-weight: bold;
    border: 3px solid var(--border-color);
    box-shadow: 3px 3px 0 var(--border-color);
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .cal {
    background: #fff;
    padding: 8px;
    border-radius: 12px;
    margin: 15px 0;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    border: 2px dashed #bdc3c7;
  }
  
  .day {
    padding: 6px 0;
    font-size: 0.8rem;
    color: #bdc3c7;
    position: relative;
    border-radius: 8px;
    background: #f4f6f9;
    text-align: center;
    font-weight: bold;
  }
  
  .day.today {
    background: var(--main);
    color: #fff;
    border: 2px solid var(--border-color);
    transform: scale(1.1);
  }
  
  .day.match {
    background: var(--lose);
    color: #fff;
    border: 2px solid var(--border-color);
  }
  
  .mark {
    font-size: 0.5rem;
    line-height: 1;
    position: absolute;
    bottom: 2px;
    left: 0;
    right: 0;
    color: #fff;
    text-shadow: 1px 1px 0 #000;
  }

  .card {
    background: #fff;
    padding: 15px;
    border-radius: 16px;
    margin-bottom: 20px;
    position: relative;
    border: 3px solid var(--border-color);
    box-shadow: 6px 6px 0 rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow: hidden;
  }
  
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: 10px;
    background: #ccc;
    border-right: 3px solid var(--border-color);
  }
  .card[data-pos="OH"]::before { background: var(--c-oh); }
  .card[data-pos="MB"]::before { background: var(--c-mb); }
  .card[data-pos="S"]::before { background: var(--c-s); }
  .card[data-pos="L"]::before { background: var(--c-l); }

  .c-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
    padding-left: 15px;
  }
  
  .c-name {
    font-size: 1.3rem;
    font-weight: 900;
    color: var(--text);
    letter-spacing: -0.05em;
  }
  
  .c-meta {
    font-size: 0.85rem;
    color: #7f8c8d;
    display: flex;
    align-items: center;
    gap: 8px;
    padding-left: 15px;
  }
  
  .badge {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 20px;
    color: #fff;
    vertical-align: middle;
    font-weight: bold;
    border: 2px solid var(--border-color);
  }
  
  .st { background: var(--accent); }
  .li { background: var(--ok); }
  
  .c-ovr {
    background: var(--text);
    color: #fff;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 900;
    font-size: 1rem;
    transform: rotate(3deg);
  }

  .stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 12px;
    background: #f0f4f8;
    padding: 10px;
    border-radius: 12px;
    margin: 6px 0;
    border: 2px solid #e0e6ed;
    padding-left: 20px;
  }
  
  .s-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    align-items: center;
    border-bottom: 2px dashed #cbd5e0;
    padding-bottom: 2px;
  }
  
  .rnk {
    display: inline-block;
    width: 26px;
    text-align: center;
    border-radius: 50%;
    font-size: 0.8rem;
    margin-right: 6px;
    color: #fff;
    font-weight: 900;
    border: 2px solid var(--border-color);
    box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
  }
  
  .r-SS { background: linear-gradient(45deg, #ff9f43, #feca57); } 
  .r-S { background: #feca57; color: #000; } 
  .r-A { background: #ff9f43; }
  .r-B { background: #ff6b6b; }
  .r-C { background: #54a0ff; }
  .r-D { background: #1dd1a1; }
  .r-E { background: #00d2d3; }
  .r-F { background: #8395a7; }
  .r-G { background: #c8d6e5; }

  .up-3 { color: var(--accent); font-weight: 900; font-size: 0.8rem; }
  .up-2 { color: var(--ok); font-weight: 900; font-size: 0.8rem; }
  .up-1 { color: var(--main); font-size: 0.7rem; }

  .c-apt {
    display: flex;
    gap: 8px;
    margin-bottom: 4px;
    padding: 8px;
    background: #fff;
    border-radius: 10px;
    border: 2px dashed var(--border-color);
    font-size: 0.8rem;
    justify-content: space-around;
    font-weight: bold;
  }
  .apt-item { color: #95a5a6; }
  .apt-val { color: var(--text); margin-left: 2px; }
  .apt-val.high { color: var(--lose); font-weight: 900; border-bottom: 3px solid var(--lose); }

  .c-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding-top: 4px;
  }
  
  .sk-tag {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 20px;
    color: #fff;
    font-weight: bold;
    border: 2px solid var(--border-color);
    box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
  }
  
  .sk-p { background: var(--c-oh); }
  .sk-n { background: var(--lose); }

  .c-btm {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin-top: 8px;
  }
  
  .c-menu-btn {
    font-size: 0.75rem;
    padding: 10px 2px;
    background: #fff;
    color: var(--text);
    border-radius: 8px;
    text-align: center;
    border: 2px solid #eee;
    font-weight: bold;
  }
  
  .c-menu-btn.active {
    background: var(--accent);
    color: #fff;
    border-color: var(--border-color);
    box-shadow: 2px 2px 0 var(--border-color);
    transform: translate(-1px, -1px);
  }
  
  .c-pos-btn {
    flex: 1;
    font-size: 0.75rem;
    padding: 8px;
    background: #fff;
    border-radius: 8px;
    text-align: center;
    border: 2px solid #eee;
    font-weight: bold;
  }
  
  .c-pos-btn.active {
    background: var(--main);
    color: #fff;
    border-color: var(--border-color);
    box-shadow: 2px 2px 0 var(--border-color);
  }

  #ui-match {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(44, 62, 80, 0.95);
    z-index: 2000;
    overflow-y: auto;
    padding: 10px;
    backdrop-filter: blur(8px);
  }
  
  .m-container {
    max-width: 600px;
    margin: 0 auto;
  }
  
  .court {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    background: var(--accent);
    padding: 10px;
    border-radius: 12px;
    border: 4px solid #fff;
    margin-bottom: 10px;
    transition: transform 0.1s;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
  }
  
  .pos {
    cursor: pointer;
    background: #fff;
    color: var(--text);
    padding: 8px 2px;
    text-align: center;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: bold;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1);
    border: 2px solid #eee;
  }
  
  .pos.back {
    background: #ecf0f1;
    color: #7f8c8d;
  }
  
  .score {
    text-align: center;
    font-size: 4rem;
    font-weight: 900;
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-bottom: 5px;
    color: #fff;
    text-shadow: 4px 4px 0 var(--border-color);
    font-family: "Zen Maru Gothic";
  }
  
  .sc-my { color: var(--main); }
  .sc-opp { color: var(--lose); }
  
  .log {
    height: 150px;
    overflow-y: auto;
    background: rgba(0,0,0,0.5);
    border: 2px solid #fff;
    padding: 10px;
    font-size: 0.9rem;
    font-family: "Zen Maru Gothic", sans-serif;
    margin-bottom: 10px;
    border-radius: 12px;
    color: #fff;
    transition: background 0.2s;
  }
  
  .l-row {
    border-bottom: 1px dashed rgba(255,255,255,0.3);
    padding: 4px 0;
  }
  
  .cmds {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .cmd {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    color: var(--text);
    text-align: left;
    border: 3px solid var(--border-color);
    box-shadow: 4px 4px 0 var(--border-color);
  }
  
  .cmd:active {
    transform: translate(4px, 4px);
    box-shadow: none;
    background: #f0f0f0;
  }
  
  .cmd b {
    display: block;
    font-size: 1.1rem;
    color: var(--main);
  }
  
  .cmd span {
    font-size: 0.8rem;
    color: #7f8c8d;
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(4px);
  }
  
  .modal-content {
    background: #fff;
    width: 100%;
    max-width: 500px;
    padding: 25px;
    border-radius: 24px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    max-height: 80vh;
    overflow-y: auto;
    border: 4px solid var(--border-color);
  }
  
  select {
    width: 100%;
    padding: 12px;
    background: #f4f6f9;
    color: var(--text);
    border: 2px solid var(--border-color);
    margin-top: 5px;
    border-radius: 12px;
    font-size: 1rem;
    font-family: inherit;
    font-weight: bold;
  }
  
  .court-edit {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    background: var(--text);
    padding: 15px;
    border-radius: 16px;
    border: 3px solid #fff;
    margin-bottom: 15px;
  }
  
  .pos-edit {
    background: #fff;
    padding: 8px;
    border-radius: 8px;
    text-align: center;
    font-size: 0.8rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 80px;
    border: 2px solid #eee;
  }
  
  .pos-edit label {
    font-weight: 900;
    color: #7f8c8d;
    font-size: 0.75rem;
    margin-bottom: 4px;
    display: block;
  }
  
  .pos-edit select {
    width: 100%;
    font-size: 0.8rem;
    padding: 4px;
    margin-top: 0;
    border: 1px solid #ccc;
  }
  
  .pos-edit.back {
    background: #ecf0f1;
  }

  #v-prologue {
    background: var(--text);
    color: #fff;
    text-align: center;
    padding: 40px;
    line-height: 2.2;
    display: none;
    position: fixed;
    inset: 0;
    z-index: 5000;
  }
  
  #v-prologue.active {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  
  .prologue-text {
    opacity: 0;
    animation: fadeIn 3s forwards;
    font-size: 1.1rem;
    font-weight: bold;
  }
  
  .p-sub {
    color: #bdc3c7;
    font-size: 0.8rem;
    margin-top: 30px;
    opacity: 0;
    animation: fadeIn 3s 2s forwards;
  }
  
  .p-title {
    font-size: 3rem;
    font-weight: 900;
    color: var(--accent);
    margin-top: 40px;
    opacity: 0;
    animation: fadeIn 3s 4s forwards;
    letter-spacing: 0.1em;
    text-shadow: 4px 4px 0 #fff;
  }
  
  .p-start {
    margin-top: 40px;
    font-size: 1.2rem;
    color: #fff;
    border-bottom: 3px solid var(--accent);
    cursor: pointer;
    opacity: 0;
    animation: fadeIn 1s 5s forwards;
    padding-bottom: 5px;
  }
  
  @keyframes fadeIn {
    to { opacity: 1; }
  }
  
  .help-sec {
    margin-bottom: 15px;
    border-bottom: 2px dashed #eee;
    padding-bottom: 15px;
  }
  
  .help-sec h4 {
    margin: 0 0 8px 0;
    color: var(--text);
    font-size: 1.1rem;
    background: var(--win);
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    border: 2px solid var(--border-color);
  }
  
  .help-sec p {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text);
    line-height: 1.6;
  }
  
  /* v71.0: Help Table Styles */
  .help-tbl { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 5px; }
  .help-tbl th { background: #eee; padding: 4px; border: 1px solid #ccc; text-align: center; }
  .help-tbl td { padding: 4px; border: 1px solid #ccc; }
  
  details {
    margin-bottom: 12px;
    border: 2px solid #eee;
    border-radius: 12px;
    padding: 12px;
    background: #f9f9f9;
  }
  summary {
    font-weight: 900;
    cursor: pointer;
    color: var(--text);
    list-style: none;
    position: relative;
    padding-left: 20px;
  }
  summary::before {
    content: "â–¶";
    position: absolute;
    left: 0;
    color: var(--accent);
    font-size: 0.8em;
    top: 2px;
    transition: transform 0.2s;
  }
  details[open] summary::before {
    transform: rotate(90deg);
  }
  details p {
    margin-top: 10px;
    color: var(--text);
    font-size: 0.85rem;
    line-height: 1.8;
    margin-bottom: 0;
  }

  @keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
  }
  .shake { animation: shake 0.5s; }
  
  @keyframes flash {
    0% { background: rgba(255,255,255,0); }
    20% { background: rgba(255,255,255,0.8); }
    100% { background: rgba(255,255,255,0); }
  }
  .flash-fx { animation: flash 0.3s; position:fixed; inset:0; z-index:9999; pointer-events:none; }

  .log-big { font-size: 1.1em; font-weight: 900; color: var(--win) !important; text-shadow: 2px 2px 0 #000; margin: 4px 0; }
  
  .bad-flow { box-shadow: 0 0 20px var(--lose); border-color: var(--lose); animation: pulseBad 1s infinite; }
  .good-flow { box-shadow: 0 0 20px var(--win); border-color: var(--win); animation: pulseGood 1s infinite; }
  
  @keyframes pulseGood { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
  @keyframes pulseBad { 0% { transform: rotate(0deg); } 25% { transform: rotate(-1deg); } 75% { transform: rotate(1deg); } 100% { transform: rotate(0deg); } }
  
  #btn-to {
    background: #2c3e50; color: #fff; padding: 6px 15px; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; width: auto; display: inline-block; border: 2px solid #fff; box-shadow: 0 4px 0 #000;
  }
  #btn-to:active { transform: translateY(4px); box-shadow: none; }
  
  #btn-auto {
    background: #95a5a6; color: #fff; padding: 6px 15px; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; margin-left: 10px; width: auto; display: inline-block; border: 2px solid #fff; box-shadow: 0 4px 0 #000;
  }
  #btn-auto.active {
    background: var(--win); color: #000; font-weight: 900;
  }
  #btn-auto:active { transform: translateY(4px); box-shadow: none; }
  
  /* v70.0: Skill Note Styles */
  .note-tab { display:flex; gap:5px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px; }
  .tab-btn { flex:1; padding:8px; font-size:0.75rem; border-radius:8px; border:1px solid #ccc; background:#fff; color:var(--text); white-space:nowrap; }
  .tab-btn.active { background:var(--main); color:#fff; border-color:var(--border-color); font-weight:bold; }
  .sk-list { display:grid; grid-template-columns:1fr; gap:8px; }
  .sk-item { padding:10px; border:2px solid #eee; border-radius:8px; background:#fdfdfd; }
  .sk-item.unlocked { border-color:var(--accent); }
  .sk-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .sk-n-txt { font-weight:900; font-size:0.9rem; }
  .sk-desc { font-size:0.8rem; color:#7f8c8d; line-height:1.4; }
</style>
</head>
<body>
<div id="flash-layer"></div>
<div class="container">
  <button id="btn-config" onclick="ShowConfig()">âš™ï¸</button>
  <button id="btn-sound" onclick="Sound.toggleMute()" style="right:10px; left:auto;">ğŸ”‡</button>
  <button id="btn-note" onclick="ShowSkillNote()">ğŸ“–</button>

  <div id="v-prologue" class="view" onclick="StartGame()">
    <div class="prologue-text">
      ã•ã‚ã€è¡Œã“ã†ã€‚<br>
      ã‚ªãƒ¬ãƒ³ã‚¸ã‚³ãƒ¼ãƒˆã¯é ããªã„ã€‚<br>
      ã“ã®ä¸€è©¦åˆã€ã“ã®ä¸€æœ¬ã®å…ˆã«ã‚ã‚‹ã€‚<br><br>
      è¿·ã†ãªã€ä¸‹ã‚’å‘ããªã€ä¸Šã‚’è¦‹ã‚ã€‚<br>
      ã‚³ãƒ¼ãƒˆã«ç«‹ã¤ã®ã¯ã€<br>
      ä»Šæ—¥ã€æœ€å¾Œã¾ã§æˆ¦ã„æŠœã„ãŸä¿ºãŸã¡ã ã€‚<br>
      æ˜¥é«˜ã¸ã€è¡Œããã€‚<br>
    </div>
    <div class="p-sub">âˆ’ã“ã‚Œã¯ã€ã‚ã‚‹1äººã®ç›£ç£ã®è‹¦ã—ãã¦ã€çœ©ã—ã„ç‰©èªâˆ’</div>
    <div class="p-title">ä¿ºã®ã‚ªãƒ¬ãƒ³ã‚¸ã‚³ãƒ¼ãƒˆ</div>
    <div class="p-start">TAP TO START</div>
  </div>

  <div id="v-scout" class="view">
    <div class="header">
      <h1 style="margin:0; color:var(--text);">ğŸŒ¸ ãƒãƒ¬ãƒ¼éƒ¨ å…¥å­¦å¼</h1>
      <p style="color:#7f8c8d;">æ–°å…¥éƒ¨å“¡ãŒå…¥éƒ¨ã‚’å¸Œæœ›ã—ã¦ã„ã¾ã™</p>
      <div style="font-size:1rem; margin:10px 0; font-weight:bold;">ç¾åœ¨ã®éƒ¨å“¡æ•°: <span id="cnt-mem" style="color:var(--main); font-size:1.5em;">0</span>å</div>
      <button class="btn btn-m" onclick="CommitEnlist()">å…¥éƒ¨ã‚’æ‰¿èªã—ã¦é–‹å§‹ (åˆè¨ˆ8å)</button>
    </div>
    <div id="list-scout"></div>
  </div>
  
  <div id="v-scout-select" class="view">
    <div class="header">
      <h1 style="margin:0; color:var(--text);">ğŸ” ç§‹ã®ã‚¹ã‚«ã‚¦ãƒˆæ´»å‹•</h1>
      <p style="color:#7f8c8d;">æœ‰åŠ›é¸æ‰‹ã‚’å‹§èª˜ã«è¡Œãã¾ã™ (Lv.<span id="sc-lv"></span>)</p>
      <div style="font-size:1rem; margin:10px 0; font-weight:bold;">ç²å¾—å¯èƒ½æ : æ®‹ã‚Š<span id="sc-slot" style="color:var(--main); font-size:1.5em;"></span>å</div>
      <p style="font-size:0.8rem; color:var(--lose); font-weight:bold;">â€»èƒ½åŠ›ã¯æ¨å®šå€¤ã§ã™ã€‚å®Ÿéš›ã®èƒ½åŠ›ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
      <button class="btn btn-g" onclick="FinishScout()">ã‚¹ã‚«ã‚¦ãƒˆæ´»å‹•ã‚’çµ‚äº†ã™ã‚‹</button>
    </div>
    <div id="list-scout-cand"></div>
  </div>

  <div id="v-main" class="view">
    <div class="header">
      <button id="btn-help" onclick="ShowHelp()" style="position:absolute; top:45px; right:10px; width:40px; height:40px; border-radius:50%; background:#95a5a6; color:#fff; font-weight:bold; border:3px solid var(--border-color); box-shadow:3px 3px 0 var(--border-color); font-size:1.2rem;">?</button>
      <div id="txt-msg" style="color:var(--accent); font-weight:900; min-height:1.2em; font-size:1.2rem; padding-right:40px;"></div>
      <div class="cal">
        <div style="grid-column:span 7; display:flex; justify-content:space-between; font-size:0.9rem; color:#95a5a6; font-weight:bold; margin-bottom:5px;">
          <span id="txt-m">4æœˆ</span> <span>IH(5/10) æ˜¥(10/13) æ–°(1/10)</span>
        </div>
        <div id="cal-days" style="display:contents;"></div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
        <div id="txt-d" style="font-size:1.5rem; font-weight:900; color:var(--text);"></div>
        <div style="display:flex; gap:10px;">
          <button onclick="ShowOrder()" style="padding:10px 20px; background:var(--main); border-radius:12px; color:#fff; font-size:0.9rem; border:2px solid var(--border-color); box-shadow:3px 3px 0 var(--border-color); font-weight:bold;">ã‚ªãƒ¼ãƒ€ãƒ¼</button>
          <button onclick="PracticeM()" style="padding:10px 20px; background:var(--accent); border-radius:12px; color:#fff; font-size:0.9rem; border:2px solid var(--border-color); box-shadow:3px 3px 0 var(--border-color); font-weight:bold;">ç·´ç¿’è©¦åˆ</button>
        </div>
      </div>
      <button id="btn-act" class="btn btn-g" onclick="NextDay()">3æ—¥é–“ æŒ‡å°ã‚’é€²ã‚ã‚‹</button>
    </div>
    <div id="list-team"></div>
  </div>

  <div id="ui-match-brief" class="modal">
    <div class="modal-content" style="max-width:500px; text-align:center;">
      <h2 style="color:var(--accent); margin-bottom:10px;">MATCH BRIEFING</h2>
      <div style="background:#f4f6f9; padding:15px; border-radius:12px; margin-bottom:20px; border:2px solid #ccc;">
        <div id="brief-info" style="font-size:1.2rem; font-weight:bold;"></div>
        <div id="brief-power" style="margin-top:10px; color:var(--lose); font-weight:900;"></div>
      </div>
      <p>è©¦åˆé–‹å§‹å‰ã«ã‚¹ã‚¿ãƒ¡ãƒ³ã¨èª¿å­ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
      <button class="btn btn-m" onclick="ShowOrder()">ğŸ“‹ ã‚¹ã‚¿ãƒ¡ãƒ³ç·¨æˆ (èª¿å­ç¢ºèª)</button>
      <button class="btn btn-y" onclick="RealStartMatch()">ğŸ”¥ è©¦åˆé–‹å§‹ (Kick Off)</button>
    </div>
  </div>

  <div id="ui-match">
    <div class="m-container">
      <div id="m-info" style="text-align:center; color:#fff; font-size:0.9rem; margin-bottom:5px; font-weight:900; text-shadow:2px 2px 0 #000;"></div>
      <div id="m-court" class="court"></div>
      <div class="score">
        <span class="sc-my" id="s-my">0</span>-
        <span class="sc-opp" id="s-opp">0</span>
      </div>
      <div style="text-align:center; margin-bottom:5px;">
         <button id="btn-to" onclick="TimeOut()">âœ‹ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (æ®‹2)</button>
         <button id="btn-auto" onclick="ToggleAuto()">â–¶ ãŠã¾ã‹ã›</button>
      </div>
      <div id="m-state" style="text-align:center; color:#f1c40f; height:1.2em; font-size:0.9rem; font-weight:900; margin-bottom:5px; text-shadow:1px 1px 0 #000;"></div>
      <div id="m-log" class="log"></div>
      <div id="m-cmd" class="cmds"></div>
      <button id="btn-force" class="btn btn-r" style="display:none;" onclick="ForceNext()">âš  å¼·åˆ¶é€²è¡Œ</button>
      <div id="m-end" style="display:none;">
        <button id="btn-next-rd" class="btn btn-m" onclick="EndMatchUI()">æ¬¡ã®å›æˆ¦ã¸ (1é€±é–“å¾Œ)</button>
        <button class="btn btn-g" onclick="EndMatchUI()">ç·´ç¿’ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="ui-order" class="modal">
    <div class="modal-content" style="max-width:600px;">
      <h3 style="text-align:center; color:var(--text); margin-top:0; font-size:1.5rem;">ã‚¹ã‚¿ãƒ¡ãƒ³ç·¨æˆ</h3>
      <div id="ord-court" class="court-edit"></div>
      <div style="margin-top:20px; border-top:2px dashed #ccc; padding-top:15px;">
        <label style="color:var(--text); font-weight:900; font-size:1rem;">ãƒªãƒ™ãƒ­ (å®ˆå‚™å°‚é–€)</label>
        <select id="sel-lib"></select>
      </div>
      <button class="btn btn-g" onclick="CloseOrder()">æ±ºå®šã—ã¦æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="ui-detail" class="modal" onclick="CloseDetail()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div id="detail-card"></div>
      <button class="btn btn-m" onclick="CloseDetail()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="ui-help" class="modal" onclick="CloseHelp()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 style="text-align:center;color:var(--text);margin-top:0;border-bottom:3px solid var(--border-color);padding-bottom:10px; font-size:1.5rem;">ğŸ ç›£ç£ã®æ‰‹å¼•ã</h3>
      
      <div class="note-tab">
        <button class="tab-btn active" onclick="SwitchHelpTab('basic', this)">åŸºæœ¬</button>
        <button class="tab-btn" onclick="SwitchHelpTab('pos', this)">ãƒã‚¸ã‚·ãƒ§ãƒ³</button>
        <button class="tab-btn" onclick="SwitchHelpTab('train', this)">è‚²æˆ</button>
        <button class="tab-btn" onclick="SwitchHelpTab('match', this)">è©¦åˆ</button>
      </div>
      
      <div id="help-content" style="max-height:60vh; overflow-y:auto;">
         </div>

      <button class="btn btn-g" onclick="CloseHelp()" style="margin-top:15px;">ç†è§£ã—ãŸ</button>
    </div>
  </div>

  <div id="ui-config" class="modal" onclick="CloseConfig()">
    <div class="modal-content" style="max-width:400px; text-align:center;" onclick="event.stopPropagation()">
      <h3 style="margin-top:0;">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
      <p style="font-size:0.8rem; color:#7f8c8d;">Version 71.0 Ultimate Manual</p>
      <button class="btn btn-m" onclick="CheckUpdate()">ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ç¢ºèª</button>
      <button class="btn btn-r" onclick="HardReset()">âš  ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– (Reset)</button>
      <button class="btn btn-s" onclick="CloseConfig()" style="margin-top:20px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div id="ui-skill-note" class="modal" onclick="CloseSkillNote()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 style="text-align:center; margin-top:0;">ğŸ“– ç‰¹æ®Šèƒ½åŠ›ç ”ç©¶ãƒãƒ¼ãƒˆ</h3>
      <div class="note-tab">
        <button class="tab-btn active" onclick="SwitchSkillTab('atk', this)">æ”»æ’ƒ</button>
        <button class="tab-btn" onclick="SwitchSkillTab('blk', this)">å®ˆå‚™(ãƒ–ãƒ­)</button>
        <button class="tab-btn" onclick="SwitchSkillTab('rec', this)">å®ˆå‚™(ãƒ¬)</button>
        <button class="tab-btn" onclick="SwitchSkillTab('tos', this)">ãƒˆã‚¹</button>
        <button class="tab-btn" onclick="SwitchSkillTab('srv', this)">ã‚µãƒ¼ãƒ–</button>
      </div>
      <div id="skill-list" class="sk-list"></div>
      <button class="btn btn-s" onclick="CloseSkillNote()" style="margin-top:15px;">é–‰ã˜ã‚‹</button>
    </div>
  </div>

</div>

<script>
// ==========================================
// ğŸµ Sound Engine (v70.2 Full Uncompressed)
// ==========================================
const Sound = (function() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const masterGain = ctx.createGain();
  masterGain.gain.value = 0.3; 
  masterGain.connect(ctx.destination);

  let isMuted = true;
  let isPlaying = false;
  let timerID = null;
  let nextTime = 0;
  let tick = 0;
  let currentBgmType = null;

  function playEPiano(freq, t, dur) {
    if (isMuted) return;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const pan = ctx.createStereoPanner();
    
    osc.type = 'sine';
    osc.frequency.value = freq;
    
    const lfo = ctx.createOscillator();
    lfo.frequency.value = 4;
    const lfoGain = ctx.createGain();
    lfoGain.gain.value = 0.1;
    lfo.connect(lfoGain);
    lfoGain.connect(gain.gain);
    lfo.start(t);

    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.6, t + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.01, t + dur * 1.5);
    
    pan.pan.value = Math.sin(t) * 0.3;

    osc.connect(gain);
    gain.connect(pan);
    pan.connect(masterGain);
    
    osc.start(t);
    osc.stop(t + dur * 2);
  }

  function playGuitar(freq, t, dur) {
    if (isMuted) return;
    const osc = ctx.createOscillator();
    const filter = ctx.createBiquadFilter();
    const gain = ctx.createGain();
    
    osc.type = 'sawtooth';
    osc.frequency.value = freq;
    
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(freq * 4, t);
    filter.frequency.exponentialRampToValueAtTime(freq, t + 0.1);

    gain.gain.setValueAtTime(0.4, t);
    gain.gain.exponentialRampToValueAtTime(0.01, t + dur);

    osc.connect(filter);
    filter.connect(gain);
    gain.connect(masterGain);
    
    osc.start(t);
    osc.stop(t + dur);
  }

  function playLead(freq, t, dur) {
    if (isMuted) return;
    const osc1 = ctx.createOscillator();
    const osc2 = ctx.createOscillator();
    const gain = ctx.createGain();
    
    osc1.type = 'sawtooth';
    osc2.type = 'square';
    
    osc1.frequency.value = freq;
    osc2.frequency.value = freq * 1.003;
    
    gain.gain.setValueAtTime(0.3, t);
    gain.gain.exponentialRampToValueAtTime(0.01, t + dur * 0.9);

    osc1.connect(gain);
    osc2.connect(gain);
    gain.connect(masterGain);
    
    osc1.start(t);
    osc1.stop(t + dur);
    osc2.start(t);
    osc2.stop(t + dur);
  }

  function playBass(freq, t, dur) {
    if (isMuted) return;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    
    osc.type = 'square';
    osc.frequency.value = freq;
    
    gain.gain.setValueAtTime(0.5, t);
    gain.gain.exponentialRampToValueAtTime(0.01, t + dur);

    osc.connect(gain);
    gain.connect(masterGain);
    
    osc.start(t);
    osc.stop(t + dur);
  }

  function playDrum(type, t) {
    if (isMuted) return;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    
    if (type === 'K') {
      osc.frequency.setValueAtTime(150, t);
      osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
      gain.gain.setValueAtTime(1, t);
      gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
      osc.connect(gain);
      gain.connect(masterGain);
      osc.start(t);
      osc.stop(t + 0.5);
    } else if (type === 'S') {
      const buf = ctx.createBuffer(1, ctx.sampleRate * 0.1, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
      const src = ctx.createBufferSource();
      src.buffer = buf;
      
      gain.gain.setValueAtTime(0.5, t);
      gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
      
      src.connect(gain);
      gain.connect(masterGain);
      src.start(t);
    }
  }

  // Note Data
  const F = { 
    A2:110.0, C3:130.8, D3:146.8, E3:164.8, F3:174.6, G3:196.0, 
    A3:220.0, B3:246.9, C4:261.6, D4:293.7, E4:329.6, F4:349.2, G4:392.0, GS4:415.3, 
    A4:440.0, B4:493.9, C5:523.3, D5:587.3, E5:659.3, F5:698.5, G5:784.0, A5:880.0, x:0 
  };
  
  const Daily = {
    tempo: 110, len: 64,
    mel: [F.A4,F.x, F.G4,F.x, F.F4,F.x, F.G4,F.x, F.E4,F.x, F.x,F.x, F.D4,F.E4, F.F4,F.G4, F.A4,F.x, F.C5,F.x, F.B4,F.x, F.G4,F.x, F.A4,F.x, F.x,F.x, F.x,F.x, F.x,F.x, F.F4,F.x, F.A4,F.x, F.G4,F.x, F.C5,F.x, F.B4,F.x, F.G4,F.x, F.E4,F.x, F.C4,F.x, F.D4,F.x, F.x,F.x, F.E4,F.x, F.x,F.x, F.C4,F.x, F.x,F.x, F.x,F.x, F.x,F.x],
    arp: [F.F3,F.A3,F.C4,F.A3, F.G3,F.B3,F.D4,F.B3, F.E3,F.G3,F.B3,F.G3, F.A3,F.C4,F.E4,F.C4, F.F3,F.A3,F.C4,F.A3, F.G3,F.B3,F.D4,F.B3, F.A3,F.C4,F.E4,F.C4, F.A3,F.C4,F.E4,F.C4, F.F3,F.A3,F.C4,F.A3, F.G3,F.B3,F.D4,F.B3, F.E3,F.G3,F.B3,F.G3, F.A3,F.C4,F.E4,F.C4, F.D3,F.F3,F.A3,F.F3, F.G3,F.B3,F.D4,F.B3, F.C3,F.E3,F.G3,F.E3, F.C3,F.E3,F.G3,F.E3],
    bass: [F.F3,0,0,0, F.G3,0,0,0, F.E3,0,0,0, F.A3,0,0,0, F.F3,0,0,0, F.G3,0,0,0, F.A3,0,0,0, 0,0,0,0, F.F3,0,0,0, F.G3,0,0,0, F.E3,0,0,0, F.A3,0,0,0, F.D3,0,0,0, F.G3,0,0,0, F.C3,0,0,0, 0,0,0,0],
    drm: ['K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0, 'K',0,0,0]
  };
  const Match = {
    tempo: 150, len: 64,
    mel: [F.A4,F.x, F.A4,F.B4, F.C5,F.x, F.A4,F.x, F.E5,F.x, F.D5,F.x, F.C5,F.B4, F.A4,F.G4, F.F4,F.x, F.F4,F.G4, F.A4,F.x, F.F4,F.x, F.C5,F.x, F.B4,F.x, F.A4,F.G4, F.F4,F.E4, F.D4,F.x, F.F4,F.x, F.A4,F.x, F.D5,F.x, F.B4,F.x, F.G4,F.x, F.D4,F.x, F.B3,F.x, F.E4,F.x, F.GS4,F.x, F.B4,F.x, F.E5,F.x, F.A4,F.x, F.x,F.x, F.x,F.x, F.x,F.x],
    bass: [F.A3,F.A2, F.A3,F.A2, F.A3,F.A2, F.A3,F.A2, F.A3,F.A2, F.A3,F.A2, F.A3,F.A2, F.A3,F.A2, F.F3,F.F2, F.F3,F.F2, F.F3,F.F2, F.F3,F.F2, F.F3,F.F2, F.F3,F.F2, F.F3,F.F2, F.F3,F.F2, F.G3,F.G2, F.G3,F.G2, F.G3,F.G2, F.G3,F.G2, F.G3,F.G2, F.G3,F.G2, F.G3,F.G2, F.G3,F.G2, F.E3,F.E2, F.E3,F.E2, F.E3,F.E2, F.E3,F.E2, F.E3,F.E2, F.A3,F.A2, F.A3,F.A2, F.A3,F.x, F.A3,F.x],
    drm: ['K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K',0,'S',0, 'K','K','S','S', 'K',0,'S',0],
    arp: []
  };
  const Finals = {
    tempo: 178, len: 64,
    mel: [F.A4,F.x, F.A4,F.B4, F.C5,F.x, F.A4,F.x, F.E5,F.x, F.F5,F.E5, F.D5,F.C5, F.B4,F.G4, F.A4,F.x, F.A4,F.B4, F.C5,F.x, F.E5,F.x, F.F5,F.x, F.E5,F.D5, F.C5,F.B4, F.A4,F.G4, F.F4,F.x, F.A4,F.x, F.D5,F.x, F.A4,F.x, F.G4,F.x, F.B4,F.x, F.D5,F.x, F.G4,F.x, F.E4,F.x, F.GS4,F.x, F.B4,F.x, F.E5,F.x, F.A5,F.x, F.x,F.x, F.A5,F.x, F.x,F.x],
    bass: [F.A2,F.A2, F.A2,F.A2, F.A2,F.A2, F.A2,F.A2, F.G2,F.G2, F.G2,F.G2, F.G2,F.G2, F.G2,F.G2, F.F2,F.F2, F.F2,F.F2, F.F2,F.F2, F.F2,F.F2, F.E2,F.E2, F.E2,F.E2, F.E2,F.E2, F.E2,F.E2, F.D2,F.D2, F.D2,F.D2, F.D2,F.D2, F.D2,F.D2, F.G2,F.G2, F.G2,F.G2, F.G2,F.G2, F.G2,F.G2, F.E2,F.E2, F.E2,F.E2, F.E2,F.E2, F.E2,F.E2, F.A2,F.A2, F.A2,F.A2, F.A2,F.x, F.A2,F.x],
    arp: [F.A3,F.C4, F.E4,F.A4, F.A3,F.C4, F.E4,F.A4, F.A3,F.C4, F.E4,F.A4, F.A3,F.C4, F.E4,F.A4, F.F3,F.A3, F.C4,F.F4, F.F3,F.A3, F.C4,F.F4, F.F3,F.A3, F.C4,F.F4, F.F3,F.A3, F.C4,F.F4, F.D3,F.F3, F.A3,F.D4, F.D3,F.F3, F.A3,F.D4, F.G3,F.B3, F.D4,F.G4, F.G3,F.B3, F.D4,F.G4, F.E3,F.GS3, F.B3,F.E4, F.E3,F.GS3, F.B3,F.E4, F.A3,F.C4, F.E4,F.A4, F.A3,F.C4, F.E4,F.A4],
    drm: ['K',0,'S',0, 'K',0,'S',0, 'K','K','S',0, 'K',0,'S','S', 'K',0,'S',0, 'K',0,'S',0, 'K','K','S',0, 'K',0,'S','S', 'K',0,'S',0, 'K',0,'S',0, 'K','K','S',0, 'K',0,'S','S', 'K',0,'S',0, 'K',0,'S',0, 'K','K','S',0, 'K',0,'S',0]
  };

  function scheduler() {
    let song = Daily;
    if(currentBgmType === 'match') song = Match;
    if(currentBgmType === 'finals') song = Finals; 
    
    const noteLen = 60 / song.tempo / 4; 
    const lookahead = 0.1;
    
    while (nextTime < ctx.currentTime + lookahead) {
      const i = tick % song.len;
      
      if (song.mel && song.mel[i]) {
        if (currentBgmType === 'daily') playEPiano(song.mel[i], nextTime, noteLen * 2);
        else playLead(song.mel[i], nextTime, noteLen * 1.5);
      }
      if (song.bass && song.bass[i]) playBass(song.bass[i], nextTime, noteLen);
      if (song.arp && song.arp[i]) playGuitar(song.arp[i], nextTime, noteLen);
      if (song.drm && song.drm[i]) playDrum(song.drm[i], nextTime);
      
      nextTime += noteLen;
      tick++;
    }
    
    if (isPlaying) timerID = requestAnimationFrame(scheduler);
  }

  function playSE(type) {
    if (isMuted) return;
    if (ctx.state === 'suspended') ctx.resume();
    const t = ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(masterGain);
    
    if (type === 'whistle') {
      osc.type = 'triangle'; 
      osc.frequency.setValueAtTime(2000, t); 
      osc.frequency.linearRampToValueAtTime(1500, t + 0.1);
      gain.gain.setValueAtTime(0.5, t); 
      gain.gain.exponentialRampToValueAtTime(0.01, t + 0.8);
      osc.start(t); 
      osc.stop(t + 0.8);
    } else if (type === 'spike') {
      osc.type = 'sawtooth'; 
      osc.frequency.setValueAtTime(300, t); 
      osc.frequency.exponentialRampToValueAtTime(10, t + 0.2);
      gain.gain.setValueAtTime(0.8, t); 
      gain.gain.exponentialRampToValueAtTime(0.01, t + 0.2);
      osc.start(t); 
      osc.stop(t + 0.2);
    } else if (type === 'recv') {
      osc.type = 'sine'; 
      osc.frequency.setValueAtTime(150, t); 
      osc.frequency.linearRampToValueAtTime(100, t + 0.1);
      gain.gain.setValueAtTime(0.8, t); 
      gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);
      osc.start(t); 
      osc.stop(t + 0.15);
    }
  }

  return {
    init: function() { 
      if (ctx.state === 'suspended') ctx.resume(); 
      isMuted = false; 
      this.updateBtn(); 
    },
    toggleMute: function() { 
      isMuted = !isMuted; 
      if (!isMuted && ctx.state === 'suspended') ctx.resume(); 
      this.updateBtn(); 
    },
    updateBtn: function() { 
      const b = document.getElementById('btn-sound');
      if (b) {
        b.innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
        b.className = isMuted ? "" : "on";
      }
    },
    playBGM: function(t) {
      if (ctx.state === 'suspended') ctx.resume();
      if (isPlaying && currentBgmType === t) return;
      this.stopBGM();
      currentBgmType = t;
      isPlaying = true;
      tick = 0;
      nextTime = ctx.currentTime + 0.1;
      scheduler();
    },
    stopBGM: function() {
      isPlaying = false;
      if (timerID) cancelAnimationFrame(timerID);
    },
    playSE: playSE
  };
})();

// ==========================================
// å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿å®šç¾©
// ==========================================
const POS = ['OH', 'MB', 'S', 'L'];
const STATS = [
  {id:'pow', n:'ãƒ‘ãƒ¯ãƒ¼'}, {id:'jmp', n:'ãƒãƒ'}, {id:'spd', n:'ç¬ç™º'}, 
  {id:'tec', n:'æŠ€å·§'}, {id:'iq', n:'æ€è€ƒ'}, {id:'srv', n:'ã‚µãƒ¼ãƒ–'}, 
  {id:'rec', n:'å®ˆå‚™'}, {id:'tos', n:'ãƒˆã‚¹'}
];
const MENU = [
  {id:'spike', n:'ã‚¹ãƒ‘ã‚¤ã‚¯', s:['pow','jmp','tec']}, {id:'def', n:'ãƒ¬ã‚·ãƒ¼ãƒ–', s:['rec','spd','iq']}, 
  {id:'serve', n:'ã‚µãƒ¼ãƒ–', s:['srv','pow','tec']}, {id:'toss', n:'ãƒˆã‚¹', s:['tos','iq','tec']}, 
  {id:'study', n:'åº§å­¦', s:['iq','tos']}, {id:'block', n:'ãƒ–ãƒ­ãƒƒã‚¯', s:['jmp','pow','iq']}, 
  {id:'tact', n:'æˆ¦è¡“', s:['iq','rec']}, {id:'muscle', n:'ç­‹åŠ›', s:['pow']}, 
  {id:'condi', n:'èª¿æ•´', s:['pow','jmp','spd','srv','rec','tos','tec','iq']}, {id:'pos', n:'é©æ­£', s:[]}
];

const SKILLS = [
  {id:'muscle',n:'è„³ç­‹',t:'p', cat:'atk', desc:'ãƒ‘ãƒ¯ãƒ¼+10'},
  {id:'blockout',n:'ãƒ–ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã€‡',t:'p', cat:'atk', desc:'æ•µã®ãƒ–ãƒ­ãƒƒã‚¯è©•ä¾¡ã‚’0.9å€ã«ã—ã¦è¨ˆç®—'},
  {id:'feint',n:'ãƒ•ã‚§ã‚¤ãƒ³ãƒˆã€‡',t:'p', cat:'atk', desc:'æŠ€å·§+8ã€æ±ºå®šç‡ã•ã‚‰ã«+8%'},
  {id:'rebound',n:'ãƒªãƒã‚¦ãƒ³ãƒ‰ã€‡',t:'p', cat:'atk', desc:'ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã€40%ã®ç¢ºç‡ã§æ‹¾ã„ç›´ã™'},
  {id:'trust',n:'åœ§å€’çš„ä¿¡é ¼',t:'p', cat:'atk', desc:'ãƒãƒ¼ãƒ ãŒè² ã‘ã¦ã„ã‚‹æ™‚ã€å…¨èƒ½åŠ›+10'},
  {id:'straight',n:'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆæ‰“ã¡',t:'p', cat:'atk', desc:'æŠ€å·§+5ã€ãƒ‘ãƒ¯ãƒ¼+5'},
  {id:'inner',n:'ã‚¤ãƒ³ãƒŠãƒ¼æ‰“ã¡',t:'p', cat:'atk', desc:'æŠ€å·§+10'},
  {id:'backswing',n:'å¤§ããªãƒãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã‚°',t:'p', cat:'atk', desc:'ãƒãƒ+10'},
  {id:'wrist',n:'æ‰‹é¦–æ‰“ã¡',t:'p', cat:'atk', desc:'æŠ€å·§+10ã€ãƒãƒ+10ã€ãƒ‘ãƒ¯ãƒ¼-5'},
  {id:'turn',n:'ã‚¿ãƒ¼ãƒ³æ‰“ã¡',t:'p', cat:'atk', desc:'æŠ€å·§+8ã€ãƒãƒ+5'},
  {id:'circular',n:'ã‚µãƒ¼ã‚­ãƒ¥ãƒ©ãƒ¼',t:'p', cat:'atk', desc:'ãƒ‘ãƒ¯ãƒ¼+10ã€æ•µãƒ–ãƒ­ãƒƒã‚¯è©•ä¾¡-10'},
  {id:'yakult',n:'ãƒ¤ã‚¯ãƒ«ãƒˆã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼',t:'n', cat:'atk', desc:'ãƒãƒ-20'},
  {id:'fukashi',n:'ãƒ•ã‚«ã—ç™–',t:'n', cat:'atk', desc:'ãƒ‘ãƒ¯ãƒ¼+5ã ãŒã€ãƒŸã‚¹ç‡+10%'},
  {id:'under',n:'ä¸‹ã«æ‰“ã¡ã™ã',t:'n', cat:'atk', desc:'ã‚¹ãƒ‘ã‚¤ã‚¯ãƒŸã‚¹ç‡+5%'},

  {id:'commit',n:'ã‚³ãƒŸãƒƒãƒˆãƒ–ãƒ­ãƒƒã‚¯',t:'p', cat:'blk', desc:'æ€è€ƒ+10'},
  {id:'step',n:'å¤§ããªä¸€æ­©',t:'p', cat:'blk', desc:'ç¬ç™º+10'},
  {id:'lead',n:'ãƒªãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯',t:'p', cat:'blk', desc:'ç¬ç™º+10'},
  {id:'laststand',n:'æœ€å¾Œã®è¸ã‚“å¼µã‚Š',t:'p', cat:'blk', desc:'ãƒãƒãƒ»ãƒ‘ãƒ¯ãƒ¼ãƒ»æ€è€ƒãƒ»ç¬ç™ºãŒã™ã¹ã¦+5'},
  {id:'onetouch',n:'ãƒ¯ãƒ³ã‚¿ãƒƒãƒã€‡',t:'p', cat:'blk', desc:'ãƒ–ãƒ­ãƒƒã‚¯æ¥è§¦æ™‚ã€æ•µã‚¹ãƒ‘ã‚¤ã‚¯å¨åŠ›ã‚’50%ã«æ¸›è¡°'},
  {id:'mathoa',n:'ã‚¦ã‚ªãƒ¼ãƒ«ãƒ»ãƒã‚½ã‚¢',t:'p', cat:'blk', desc:'æ•µã‚¹ãƒ‘ã‚¤ã‚¯å¨åŠ›ã‚’è¨ˆç®—å‰ã«0.9å€ã«ã™ã‚‹(å¨åœ§)'},
  {id:'handbad',n:'æ‰‹ã®å‡ºã—æ–¹Ã—',t:'n', cat:'blk', desc:'ãƒãƒãƒ»ãƒ‘ãƒ¯ãƒ¼ãƒ»æ€è€ƒãƒ»ç¬ç™ºãŒã™ã¹ã¦-5'},
  {id:'blkskip',n:'ãƒ–ãƒ­ãƒƒã‚¯ã•ã¼ã‚Šç™–',t:'n', cat:'blk', desc:'10%ã®ç¢ºç‡ã§ãƒ–ãƒ­ãƒƒã‚¯ã«å‚åŠ ã—ãªã„'},

  {id:'srvrec',n:'ã‚µãƒ¼ãƒ–ãƒ¬ã‚·ãƒ¼ãƒ–ã€‡',t:'p', cat:'rec', desc:'å®ˆå‚™+10'},
  {id:'dig',n:'ãƒ‡ã‚£ã‚°ã€‡',t:'p', cat:'rec', desc:'å®ˆå‚™+5ã€ç¬ç™º+5ã€æ€è€ƒ+5'},
  {id:'overcut',n:'ãªã‚“ã‹ä¸ŠãŒã‚‹ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆ',t:'p', cat:'rec', desc:'å®ˆå‚™+10ã€‚å¤±æ•—æ™‚ã€5%ã§å¼·åˆ¶æˆåŠŸ'},
  {id:'readspk',n:'ã‚¹ãƒ‘ã‚¤ã‚¯ã‚³ãƒ¼ã‚¹èª­ã¿ã€‡',t:'p', cat:'rec', desc:'å®ˆå‚™+10'},
  {id:'firststep',n:'ç´ æ—©ã„ä¸€æ­©ç›®',t:'p', cat:'rec', desc:'ç¬ç™º+5'},
  {id:'flying',n:'ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ãƒ¬ã‚·ãƒ¼ãƒ–',t:'p', cat:'rec', desc:'å®ˆå‚™+3ã€ç¬ç™º+3'},
  {id:'pancake',n:'ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­',t:'p', cat:'rec', desc:'ãƒ¬ã‚·ãƒ¼ãƒ–å¤±æ•—æ™‚ã€5%ã§å¼·åˆ¶æˆåŠŸ(ç¥ãƒ—ãƒ¬ãƒ¼)'},
  {id:'reflex',n:'å…‰ã®åå°„é€Ÿåº¦',t:'p', cat:'rec', desc:'ç¬ç™º+10'},
  {id:'libero',n:'å°ã•ãã¦å¤§ããªå­˜åœ¨',t:'p', cat:'rec', desc:'ãƒªãƒ™ãƒ­æ™‚ã®ã¿ã€å®ˆå‚™ãƒ»ç¬ç™ºãƒ»æ€è€ƒ+5'},
  {id:'swingarm',n:'è…•ãµã‚Šãƒ¬ã‚·ãƒ¼ãƒ–',t:'n', cat:'rec', desc:'å®ˆå‚™ãƒ»ç¬ç™ºãƒ»æ€è€ƒ-5'},
  {id:'immobile',n:'å‹•ã‹ãªã„è„š',t:'n', cat:'rec', desc:'ç¬ç™º-10'},
  {id:'recskip',n:'ãƒ¬ã‚·ãƒ¼ãƒ–ã•ã¼ã‚Šç™–',t:'n', cat:'rec', desc:'5%ã®ç¢ºç‡ã§ãƒ¬ã‚·ãƒ¼ãƒ–åå¿œã—ãªã„'},

  {id:'soft',n:'ãµã‚“ã‚ã‚Šã‚¿ãƒƒãƒ',t:'p', cat:'tos', desc:'ãƒˆã‚¹+8ã€ãƒˆã‚¹ãƒŸã‚¹ç‡-5%'},
  {id:'onehand',n:'ãƒ¯ãƒ³ãƒãƒ³ãƒ‰ãƒˆã‚¹',t:'p', cat:'tos', desc:'5%ã®ç¢ºç‡ã§æ•µãƒ–ãƒ­ãƒƒã‚¯åŠ›ã‚’-5ã™ã‚‹'},
  {id:'brain',n:'ãƒãƒ¼ãƒ ã®è„³',t:'p', cat:'tos', desc:'ãƒˆã‚¹+10'},
  {id:'cover',n:'ä¸Šã«ã‚ã’ã‚Œã°ã‚«ãƒãƒ¼ã™ã‚‹',t:'p', cat:'rec', desc:'ã‚»ãƒƒã‚¿ãƒ¼æ™‚ã€æ•µã‚¹ãƒ‘ã‚¤ã‚¯å¨åŠ›-5(ã‚«ãƒãƒ¼)'},
  {id:'dump',n:'ãƒ„ãƒ¼ã€‡',t:'p', cat:'atk', desc:'ãƒ„ãƒ¼ã‚¢ã‚¿ãƒƒã‚¯æ™‚ã€ãƒ‘ãƒ¯ãƒ¼+7ã€æŠ€å·§+7'},
  {id:'backtoss',n:'ãƒãƒƒã‚¯ãƒˆã‚¹ã€‡',t:'p', cat:'tos', desc:'ãƒãƒƒã‚¯ã‚¢ã‚¿ãƒƒã‚¯ã¸ã®ãƒˆã‚¹æˆåŠŸç‡UP'},
  {id:'dribble',n:'ãƒ‰ãƒªãƒ–ãƒ«ç™–',t:'n', cat:'tos', desc:'ãƒˆã‚¹ãƒŸã‚¹ç‡+5%'},
  {id:'monotone',n:'å˜èª¿ã™ãã‚‹ãƒˆã‚¹',t:'n', cat:'tos', desc:'ãƒˆã‚¹-10'},
  {id:'longbad',n:'é•·ã‚ã®ãƒˆã‚¹Ã—',t:'n', cat:'tos', desc:'ã‚ªãƒ¼ãƒ—ãƒ³ãƒˆã‚¹æ™‚ã€ãƒˆã‚¹-8'},

  {id:'spksrv',n:'ã‚¹ãƒ‘ã‚¤ã‚¯ã‚µãƒ¼ãƒ–',t:'p', cat:'srv', desc:'ã‚µãƒ¼ãƒ–ãƒ»ãƒ‘ãƒ¯ãƒ¼ãƒ»æŠ€å·§+10ã€‚ã‚¨ãƒ¼ã‚¹ç‡+2%ã€ãƒŸã‚¹ç‡+10%'},
  {id:'jmpfloat',n:'ã‚¸ãƒ£ãƒ³ãƒ—ãƒ•ãƒ­ãƒ¼ã‚¿ãƒ¼ã‚µãƒ¼ãƒ–',t:'p', cat:'srv', desc:'ã‚µãƒ¼ãƒ–ãƒ»ãƒ‘ãƒ¯ãƒ¼ãƒ»æŠ€å·§+5'},
  {id:'float',n:'ãƒ•ãƒ­ãƒ¼ã‚¿ãƒ¼ã‚µãƒ¼ãƒ–',t:'p', cat:'srv', desc:'ã‚µãƒ¼ãƒ–+5'},
  {id:'nospin',n:'ç„¡å›è»¢ã‚µãƒ¼ãƒ–',t:'p', cat:'srv', desc:'ãƒ‘ãƒ¯ãƒ¼+5'},
  {id:'netmid',n:'ãƒãƒƒãƒˆä¸­è…¹ã‚µãƒ¼ãƒ–',t:'n', cat:'srv', desc:'ã‚¨ãƒ¼ã‚¹ç‡-5%ã€ãƒŸã‚¹ç‡+10%'},
  {id:'pressbad',n:'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼Ã—',t:'n', cat:'srv', desc:'ã‚µãƒ¼ãƒ–ãƒ»ãƒ‘ãƒ¯ãƒ¼ãƒ»æŠ€å·§-10'},
  {id:'justin',n:'æ¥µç«¯ãªå…¥ã‚Œã‚µãƒ¼',t:'n', cat:'srv', desc:'å¨åŠ›0ã€‚ãƒŸã‚¹ç‡0%(çµ¶å¯¾ã«å…¥ã‚‹)'}
];

const S_NAMES = ["ä½è—¤","éˆ´æœ¨","é«˜æ©‹","ç”°ä¸­","ä¼Šè—¤","æ¸¡è¾º","å±±æœ¬","ä¸­æ‘","å°æ—","åŠ è—¤","å‰ç”°","å±±ç”°","å±±å£","æ¾æœ¬","äº•ä¸Š","æœ¨æ‘","æ—","æ¸…æ°´","å±±å´","æ± ç”°","é˜¿éƒ¨","æ©‹æœ¬","å±±ä¸‹","æ£®","çŸ³å·","ä¸­å³¶","å‰ç”°","è—¤ç”°","å°å·","å¾Œè—¤","æ‘ä¸Š","è¿‘è—¤","çŸ³äº•","æ–‰è—¤","å‚æœ¬","é è—¤","é’æœ¨","è—¤äº•","è¥¿æ‘","ç¦ç”°"];
const F_NAMES = ["è“®","å¤§ç¿”","æ‚ çœŸ","é™½ç¿”","æ¹Š","ä¸€æ¨¹","æ‹“æµ·","ç¿”å¤ª","å¥å¤ª","ç¿¼","é™¸","å¥å¤ª","æœé™½","è‹±å¯¿","ç¿”å¹³","å¤§å’Œ","æ¨¹","é™½å¤ª","é¢¯å¤ª","æ‚ äºº","é™¸æ–—","çµç¿”","æ˜¥é¦¬","å„ª","å‹‡æ°—","èª ","é¾äºŒ","ç¥ä»‹","å¥å¸","é›…äºº","æ™ºä¹Ÿ","å’Œä¹Ÿ","é”ä¹Ÿ","éš¼äºº","ç›´äºº","å¤§è¼","å…‰","è¼","ä¿®å¹³","æ¶¼å¤ª"];
const LOGS = {
  atk: ["ã‚¹ãƒ‘ã‚¤ã‚¯ç‚¸è£‚ï¼","ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸Šã‹ã‚‰å©ã„ãŸï¼","ã‚³ãƒ¼ã‚¹ã‚®ãƒªã‚®ãƒªï¼","è±ªå¿«ãªä¸€æ’ƒï¼","æŠ€ã‚ã‚Šãƒ•ã‚§ã‚¤ãƒ³ãƒˆï¼"], 
  quick: ["é®®ã‚„ã‹ãªé€Ÿæ”»ï¼","ç›¸æ‰‹ã‚’ç½®ãå»ã‚Šã«ã—ãŸï¼","Cã‚¯ã‚¤ãƒƒã‚¯ï¼","ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚·ãƒ§ãƒ³æŠœç¾¤ï¼"], 
  blk: ["ãƒ‰ã‚·ãƒ£ãƒƒãƒˆï¼","æ­¢ã‚ãŸï¼","å£ã¨ãªã£ãŸï¼","ãƒ¯ãƒ³ã‚¿ãƒƒãƒï¼"],
  ace: ["ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¹ï¼","ãƒãƒ¼ã‚¿ãƒƒãƒï¼","ç›¸æ‰‹ã‚’å´©ã—ãŸï¼"], 
  miss: ["ç—›æ¨ã®ãƒŸã‚¹...","ã‚¢ã‚¦ãƒˆ...","ãƒãƒƒãƒˆã«ã‹ã‹ã£ãŸ..."], 
  nice_toss: ["çµ¶å¦™ãªãƒˆã‚¹ï¼","ã‚»ãƒƒã‚¿ãƒ¼ã®å®Œç’§ãªçµ„ã¿ç«‹ã¦ï¼","ãƒˆã‚¹ãƒ¯ãƒ¼ã‚¯ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŒ¯ã£ãŸï¼"], 
  blk_2: ["2æšãƒ–ãƒ­ãƒƒã‚¯ã§æ­¢ã‚ãŸï¼","MBãŒè¿½ã„ã¤ã„ãŸï¼","å£ãŒé«˜ã„ï¼"], 
  blk_late_h: ["é…ã‚ŒãŸãŒé«˜ã•ã§ã‚«ãƒãƒ¼ï¼","é•·ã„è…•ãŒæ®‹ã£ãŸï¼","è„…å¨ã®ãƒªãƒ¼ãƒï¼"], 
  blk_late: ["ãƒ–ãƒ­ãƒƒã‚¯ãŒå‰²ã‚ŒãŸ...","MBãŒé–“ã«åˆã‚ãªã„...","1æšãƒ–ãƒ­ãƒƒã‚¯..."],
  rec_nice: ["ãƒŠã‚¤ã‚¹ãƒ¬ã‚·ãƒ¼ãƒ–ï¼","ã‚ˆãä¸Šã’ãŸï¼","ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‡ã‚£ã‚°ï¼"], 
  rec_fail: ["å¼·çƒˆãªã‚¹ãƒ‘ã‚¤ã‚¯...","ãƒ¬ã‚·ãƒ¼ãƒ–å¼¾ã‹ã‚ŒãŸ...","åå¿œã§ããªã„..."], 
  rebound: ["ãƒ–ãƒ­ãƒƒã‚¯ã«å½“ã¦ã¦æ‹¾ã£ãŸï¼","ãƒªãƒã‚¦ãƒ³ãƒ‰æˆåŠŸï¼","ãƒŠã‚¤ã‚¹ãƒ•ã‚©ãƒ­ãƒ¼ï¼"], 
  toss_miss: ["ãƒˆã‚¹ãŒä¹±ã‚ŒãŸ...","ãƒ‰ãƒªãƒ–ãƒ«...","ã‚³ãƒ³ãƒ“ãŒåˆã‚ãªã„..."], 
  rec_pop: ["ãƒ¬ã‚·ãƒ¼ãƒ–ãŒå¤§ãã™ããŸ...","ãŠè¦‹åˆã„...","å¼¾ã„ã¦ã—ã¾ã£ãŸ..."], 
  pancake: ["ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­ã§æ‹¾ã£ãŸï¼","åŸ·å¿µã®ãƒ¬ã‚·ãƒ¼ãƒ–ï¼"], 
  mathoa: ["ã‚¦ã‚ªãƒ¼ãƒ«ãƒ»ãƒã‚½ã‚¢ç™ºå‹•ï¼","å£ãŒç«‹ã¡ã¯ã ã‹ã‚‹ï¼"]
};
const COND = [{n:'ğŸ˜«', v:0.8}, {n:'ğŸ˜', v:0.9}, {n:'ğŸ˜', v:1.0}, {n:'ğŸ™‚', v:1.05}, {n:'ğŸ˜', v:1.1}, {n:'ğŸ¤¡', v:0}];

function Pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function GetCondVal(p) { return p.cond === 5 ? (Math.random() < 0.5 ? 1.5 : 0.5) : COND[p.cond].v; }
function HasSkill(p, id) { return p.skills && p.skills.includes(id); }

let G = { 
  team: [], starters: [null,null,null,null,null,null], libero: null, 
  date: { m:4, d:1, y:1 }, lv: 1, 
  match: { active: false, my:0, opp:0, pow:0, name:"", round:0, isNat:false, flow:0, to:2, auto:false, isMyServe:false }, 
  pracMonth: 0,
  scouted: [], 
  scoutDone: false,
  unlockedSkills: [] // v70.1 Restored Note System
};
let tempOrder = [];

// Enemy Generator
const E_PRE = ["åŒ—","å—","æ±","è¥¿","ä¸­å¤®","å¸","ç‹","é¾","æ¡œ","ç™½","é»’","é’","èµ¤","å…‰","é—‡","æ˜Ÿ","æµ·","å±±","å·","ç©º","é¢¨","é›·","ç«","æ°´","åœŸ","é‡‘","æœ¨"];
const E_SUF = ["å·¥æ¥­","å•†æ¥­","å®Ÿæ¥­","å­¦åœ’","å­¦é™¢","é«˜æ ¡","å¤§é™„å±","åŒ—","å—","æ±","è¥¿","ç¬¬ä¸€","ç¬¬äºŒ","ç¬¬ä¸‰"];
const E_TYPE = [
  {n:"ãƒãƒ©ãƒ³ã‚¹", atk:1.1, def:1.1}, 
  {n:"æ”»æ’ƒç‰¹åŒ–", atk:1.5, def:0.8}, 
  {n:"é‰„å£", atk:0.9, def:1.6}, 
  {n:"æŠ€å·§æ´¾", atk:1.3, def:1.3}, 
  {n:"ç‹è€…", atk:1.4, def:1.4} 
];

function GenerateEnemy(round, isNat) {
  const name = E_PRE[Math.floor(Math.random()*E_PRE.length)] + E_SUF[Math.floor(Math.random()*E_SUF.length)];
  const type = E_TYPE[Math.floor(Math.random()*E_TYPE.length)];
  
  // Year 1 Penalty
  const yearPenalty = (G.date.y === 1) ? 1.1 : 1.0;

  let diffMult = 1.0;
  if(!isNat) {
    if(round <= 2) diffMult = 1.0; 
    else if(round <= 4) diffMult = 1.3; 
    else diffMult = 1.6; 
  } else {
    if(round <= 4) diffMult = 1.8; 
    else diffMult = 2.0; 
  }
  
  const myTotal = G.starters.reduce((a,b)=>a+(Object.values(b.stats).reduce((x,y)=>x+y,0)/8),0)/6;
  const basePow = myTotal * diffMult * yearPenalty;
  
  const fluctuation = Math.random() < 0.2 ? basePow * 0.2 : (Math.random()*10 - 5);
  const pow = Math.floor(basePow + fluctuation);
  
  return { name: name, type: type, pow: pow };
}

window.onload = function() {
  window.onerror = function(msg) {
    const p = document.getElementById("m-cmd");
    if(p) { 
      p.innerHTML = `<div style="color:red; grid-column:span 2;">ERR: ${msg}</div>`; 
      document.getElementById("btn-force").style.display = "block"; 
    }
  };
  try {
    const save = localStorage.getItem("EIKAN_V71_0_ULTIMATE");
    if (save) {
      const d = JSON.parse(save); 
      d.team.forEach(p => {
        if (typeof p.hNow === 'undefined') { 
          let hBase = 180 + (Math.random() - 0.5) * 20; hBase = Math.max(160, Math.min(200, hBase)); 
          p.hInit = Math.floor(hBase*10)/10; p.hNow = p.hInit; p.gType = 1; p.gMax = 5; p.gCur = 0; 
        }
        if (!Array.isArray(p.skills)) p.skills = [];
        if (typeof p.cond === 'undefined') p.cond = 2;
        if (!p.hist) p.hist = { score:0, atk:0 };
      });
      G = {...G, ...d};
      if(!G.scouted) G.scouted = []; 
      if(typeof G.scoutDone === 'undefined') G.scoutDone = false; 
      if(typeof G.match.isMyServe === 'undefined') G.match.isMyServe = false;
      if(!G.unlockedSkills) G.unlockedSkills = []; // v70.1 Restore
      
      if(d.sIds) G.starters = d.sIds.map(id => G.team.find(p=>p.id===id)||null);
      if(d.lId) G.libero = G.team.find(p=>p.id===d.lId)||null;
      G.match.active = false; ChangeView('v-main'); UpdateUI(); Sound.init(); Sound.playBGM('daily');
    } else { InitGame(); }
  } catch(e) { InitGame(); }
};

function HardReset() { 
  if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) { 
    localStorage.removeItem("EIKAN_V71_0_ULTIMATE"); 
    location.reload(); 
  } 
}

// v70.2: Reload Update Check
function CheckUpdate() {
  if(confirm("æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\n(ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™)")) {
    location.reload();
  }
}

function ShowConfig() { document.getElementById('ui-config').style.display = 'flex'; }
function CloseConfig() { document.getElementById('ui-config').style.display = 'none'; }

function ShowSkillNote() {
  document.getElementById('ui-skill-note').style.display = 'flex';
  SwitchSkillTab('atk', document.querySelector('.tab-btn'));
}
function CloseSkillNote() { document.getElementById('ui-skill-note').style.display = 'none'; }

function SwitchSkillTab(cat, btn) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  
  const list = document.getElementById('skill-list');
  list.innerHTML = "";
  
  const skills = SKILLS.filter(s => s.cat === cat);
  skills.forEach(s => {
    const isUnlocked = G.unlockedSkills.includes(s.id);
    const div = document.createElement('div');
    div.className = `sk-item ${isUnlocked ? 'unlocked' : ''}`;
    div.innerHTML = `
      <div class="sk-head">
        <span class="sk-n-txt" style="color:${s.t==='p'?'var(--c-oh)':'var(--lose)'}">${s.n}</span>
        ${isUnlocked ? '<span class="badge li">è§£æ˜æ¸ˆ</span>' : ''}
      </div>
      <div class="sk-desc">${isUnlocked ? s.desc : 'ï¼Ÿï¼Ÿï¼Ÿï¼ˆè©¦åˆã«å‹åˆ©ã—ã¦åŠ¹æœã‚’è§£æ˜ã›ã‚ˆï¼‰'}</div>
    `;
    list.appendChild(div);
  });
}

function InitGame() { 
  G.team = []; G.date = { m:4, d:1, y:1 }; G.lv = 1; G.pracMonth = 0; G.scouted = []; G.scoutDone = false;
  G.unlockedSkills = []; // v70.1 Restore
  for(let i=0; i<3; i++) G.team.push(MakePlayer(2)); 
  for(let i=0; i<3; i++) G.team.push(MakePlayer(3)); 
  ChangeView('v-prologue'); 
  RenderScout(); 
}

function StartGame() { 
  Sound.init(); 
  ChangeView('v-scout'); 
  Sound.playBGM('daily'); 
}

function ChangeView(id) { 
  document.querySelectorAll('.view').forEach(e => e.classList.remove('active')); 
  document.getElementById(id).classList.add('active'); 
  if(id!=='v-prologue') document.getElementById('v-prologue').classList.remove('active'); 
}

function GetRank(v) { 
  if(v>=100) return 'SS'; if(v>=90) return 'S'; if(v>=80) return 'A'; 
  if(v>=70) return 'B'; if(v>=60) return 'C'; if(v>=50) return 'D'; 
  if(v>=40) return 'E'; if(v>=20) return 'F'; return 'G'; 
}

function MakePlayer(grade) {
  const lvBonus = Math.min(15, Math.floor(G.lv / 5));
  const isGenius = Math.random() < 0.05; 
  const bonus = isGenius ? 40 : (Math.random() < 0.05 ? 20 : 0);
  let persName = ""; let persMod = 1.0;
  if (isGenius) { persName = "â˜…æ€ªç‰©"; persMod = 1.52; } 
  else if (bonus === 20) { persName = "æ‰èƒ½ã®å¡Š"; persMod = 1.52; } 
  else {
      const pList = [{n:"ç†±è¡€",m:1.18},{n:"å†·é™",m:1.18},{n:"æ™®é€š",m:1.06},{n:"é™°æ°—",m:0.92}];
      const picked = pList[Math.floor(Math.random()*4)];
      persName = picked.n; persMod = picked.m;
  }
  const stats = {};
  const base = isGenius ? 50 : (15 + (grade-1)*5 + lvBonus); 
  STATS.forEach(s => { stats[s.id] = Math.min(100, Math.max(10, Math.floor(base + Math.random()*12 + bonus))); });
  const pos = POS[Math.floor(Math.random()*4)]; 
  const apt = {OH:0, MB:0, S:0, L:0}; apt[pos] = 100;
  let hBase = 180 + (Math.random() + Math.random() + Math.random() - 1.5) * 20; hBase = Math.max(160, Math.min(200, hBase));
  if(isGenius) hBase += 10; 
  const hInit = Math.floor(hBase * 10) / 10; const hNow = hInit;
  const skills = []; SKILLS.forEach(sk => { if(Math.random() < (isGenius?0.2:0.05)) skills.push(sk.id); });
  const gType = 1; let gMax = 5; if(Math.random()<0.02) {gMax=10;}
  return { id: "p"+Date.now()+Math.random(), name: S_NAMES[Math.floor(Math.random()*S_NAMES.length)] + " " + F_NAMES[Math.floor(Math.random()*F_NAMES.length)], grade: grade, pos: pos, stats: stats, apt: apt, pers: {n: persName, m: persMod}, menu: null, hist: { score:0, atk:0 }, hInit: hInit, hNow: hNow, gType: gType, gMax: gMax, gCur: 0, cond: 2, skills: skills };
}

function RenderScout() { 
  const el = document.getElementById('list-scout'); el.innerHTML = ""; document.getElementById('cnt-mem').innerText = G.team.length; 
  window.tmpScouts = []; 
  if(G.scouted && G.scouted.length > 0) { G.scouted.forEach(p => { p.grade = 1; window.tmpScouts.push(p); }); G.scouted = []; }
  const needed = Math.max(0, 8 - window.tmpScouts.length);
  for(let i=0; i<needed; i++) window.tmpScouts.push(MakePlayer(1));
  window.tmpScouts.forEach(p => RenderCard(p, el, true)); 
}
function CommitEnlist() { window.tmpScouts.forEach(p => p.menu = 'spike'); G.team = G.team.concat(window.tmpScouts); window.tmpScouts = null; AutoOrder(); ChangeView('v-main'); UpdateUI(); Save(); }

function AutoOrder() { 
  const list = [...G.team].sort((a,b) => Object.values(b.stats).reduce((s,v)=>s+v,0) - Object.values(a.stats).reduce((s,v)=>s+v,0)); 
  let l = list.find(p=>p.pos==='L') || null; 
  G.libero = l; 
  const others = list.filter(p => p.pos !== 'L'); 
  let s = others.find(p=>p.pos==='S') || others[0]; 
  const atks = others.filter(p=>p.id!==s.id); 
  G.starters = [atks[0]||null, atks[1]||null, atks[2]||null, s||null, atks[3]||null, atks[4]||null]; 
}

function RenderCard(p, parent, simple=false) {
  const div = document.createElement('div'); div.className = 'card'; div.setAttribute('data-pos', p.pos);
  const isS = G.starters.some(s => s && s.id === p.id); const isL = G.libero && G.libero.id === p.id;
  const badge = isS ? `<span class="badge st">ã‚¹ã‚¿ãƒ¡ãƒ³</span>` : (isL ? `<span class="badge li">L</span>` : "");
  const total = Math.floor(Object.values(p.stats).reduce((a,b)=>a+b,0));
  const m = MENU.find(x=>x.id===p.menu);
  const hNowVal = (p.hNow || 170); const hInitVal = (p.hInit || 170); const grown = (hNowVal - hInitVal).toFixed(1);
  const score = p.hist && p.hist.score ? p.hist.score : 0; const atkCnt = p.hist && p.hist.atk ? p.hist.atk : 0; const rate = atkCnt > 0 ? Math.floor((score / atkCnt) * 100) : 0;

  let html = `
    <div class="c-head"><div class="c-name">${p.name} <span style="font-size:0.8em; font-weight:normal;">(${p.pos})</span> ${COND[p.cond].n}</div><div class="c-ovr">â˜…${total}</div></div>
    <div class="c-meta"><span>${p.grade}å¹´</span><span>${p.pers.n}</span><span>${hNowVal.toFixed(1)}cm <small style="color:#aaa;">(+${grown})</small></span><span style="color:var(--main);font-weight:bold;margin-left:4px;">${score}ç‚¹ ${rate}%</span>${badge}</div>
    <div class="stats">${STATS.map(s => { const v = Math.floor(p.stats[s.id]); let arr = ""; if(!simple && m && m.s.includes(s.id)) { if(m.s.length===1) arr = ` <span class="up-3">â†‘â†‘â†‘</span>`; else if(m.s.length<=3) arr = ` <span class="up-2">â†‘â†‘</span>`; else arr = ` <span class="up-1">â†‘</span>`; } return `<div class="s-row"><span>${s.n}${arr}</span><span><span class="rnk r-${GetRank(v)}">${GetRank(v)}</span>${v}</span></div>`; }).join('')}</div>
    <div class="c-apt">${POS.map(po => `<span class="apt-item">${po}:<span class="apt-val ${p.apt[po]>=80?'high':''}">${Math.floor(p.apt[po])}%</span></span>`).join('')}</div>
    <div class="c-skills">${(p.skills||[]).map(sid => { const sk = SKILLS.find(k=>k.id===sid); return sk ? `<span class="sk-tag sk-${sk.t}">${sk.n}</span>` : ''; }).join('')}</div>
  `;
  if(!simple) { 
    html += `<div class="c-btm">${MENU.map(mn => `<div onclick="SetM('${p.id}','${mn.id}')" class="c-menu-btn ${p.menu===mn.id?'active':''}">${mn.n}</div>`).join('')}</div>
      <div class="c-btm" style="grid-template-columns:repeat(4,1fr);">${POS.map(po => `<div onclick="SetP('${p.id}','${po}')" class="c-pos-btn ${p.pos===po?'active':''}">${po}</div>`).join('')}</div>`; 
  }
  div.innerHTML = html; parent.appendChild(div);
}
function SetM(id, m) { G.team.find(p=>p.id===id).menu = m; UpdateUI(); Save(); }
function SetP(id, po) { G.team.find(p=>p.id===id).pos = po; UpdateUI(); Save(); }

function RenderScoutCard(p, parent) {
  const div = document.createElement('div'); div.className = 'card'; div.setAttribute('data-pos', p.pos); div.id = `sc-${p.id}`;
  let html = `
    <div class="c-head"><div class="c-name">${p.name} <span style="font-size:0.8em; font-weight:normal;">(${p.pos})</span></div><div class="c-ovr">è©•ä¾¡: ${GetRank(Object.values(p.stats).reduce((a,b)=>a+b,0)/8 + (Math.random()*10-5))}</div></div>
    <div class="c-meta"><span>ä¸­å­¦3å¹´ç”Ÿ</span><span>${p.pers.n}</span><span>${(p.hInit + (Math.random()*2-1)).toFixed(1)}cm?</span></div>
    <div class="stats">${STATS.map(s => { const fuzz = p.stats[s.id] + (Math.random() * 10 - 5); return `<div class="s-row"><span>${s.n}</span><span class="rnk r-${GetRank(fuzz)}">${GetRank(fuzz)}</span></div>`; }).join('')}</div>
    <div class="c-apt">${POS.map(po => `<span class="apt-item">${po}:<span class="apt-val ${p.apt[po]>=80?'high':''}">${p.apt[po]>=80?'A':'C'}</span></span>`).join('')}</div>
    <div class="c-skills">${(p.skills||[]).map(sid => { const sk = SKILLS.find(k=>k.id===sid); return sk ? `<span class="sk-tag sk-${sk.t}">${sk.n}</span>` : ''; }).join('')}</div>
    <button class="btn btn-m" onclick="DoScout('${p.id}')">ã“ã®é¸æ‰‹ã‚’ã‚¹ã‚«ã‚¦ãƒˆã™ã‚‹</button>
  `;
  div.innerHTML = html; parent.appendChild(div);
}

function UpdateUI() { 
  document.getElementById('txt-d').innerText = `${G.date.y}å¹´ ${G.date.m}æœˆ ${G.date.d}æ—¥`; 
  document.getElementById('txt-msg').innerText = `è©•åˆ¤Lv:${G.lv} - ` + (G.match.next ? `æ¬¡æˆ¦:${G.match.next.m}/${G.match.next.d}` : "ç·´ç¿’æœŸé–“"); 
  document.getElementById('txt-m').innerText = G.date.m + 'æœˆ'; 
  const cal = document.getElementById('cal-days'); cal.innerHTML = ""; 
  for(let i=1; i<=30; i++) { 
    const d = document.createElement('div'); d.className = "day" + (i===G.date.d ? " today" : "") + (G.match.next && G.match.next.m===G.date.m && G.match.next.d===i ? " match" : ""); 
    let mk = ""; if(G.date.m===5&&i===10) mk="IH"; if(G.date.m===10&&i===13) mk="æ˜¥"; if(G.date.m===1&&i===10) mk="æ–°"; 
    d.innerHTML = i + (mk?`<div class="mark">${mk}</div>`:""); cal.appendChild(d); 
  } 
  const btn = document.getElementById('btn-act'); 
  if(G.match.played) { btn.innerText = "è©¦åˆçµ‚äº† (ç¿Œæ—¥ã¸)"; btn.className = "btn btn-m"; } 
  else if(IsMatchDay()) { btn.innerText = "è©¦åˆä¼šå ´ã¸ç§»å‹• (é–‹å§‹)"; btn.className = "btn btn-r"; } 
  else { const days = GetDaysToNext(); btn.innerText = (days>0 && days<=3) ? `æ±ºæˆ¦ã¾ã§ã‚ã¨${days}æ—¥ (èª¿æ•´)` : "3æ—¥é–“ æŒ‡å°ã‚’é€²ã‚ã‚‹"; btn.className = (days>0 && days<=3) ? "btn btn-m" : "btn btn-g"; } 
  const list = document.getElementById('list-team'); list.innerHTML = ""; [...G.team].sort((a,b)=>b.grade - a.grade).forEach(p => RenderCard(p, list)); 
}
function GetGrowthMod(currentVal) { if (currentVal < 50) return 1.0; if (currentVal < 70) return 0.7; if (currentVal < 85) return 0.4; if (currentVal < 95) return 0.15; return 0.05; }
function GetEv(m, d) { if(m===5 && d===10) return "IHäºˆé¸"; if(m===10 && d===13) return "æ˜¥é«˜äºˆé¸"; if(m===1 && d===10) return "æ–°äººæˆ¦"; return null; }
function IsMatchDay() { if(G.match.played) return false; const ev = GetEv(G.date.m, G.date.d); if(ev) return !(ev==="æ–°äººæˆ¦" && G.match.winSpr); const n = G.match.next; return (n && n.m===G.date.m && n.d===G.date.d); }
function GetDaysToNext() { const n = G.match.next; if(n && n.m===G.date.m) return n.d - G.date.d; if(G.date.m===5 && G.date.d<10) return 10 - G.date.d; if(G.date.m===10 && G.date.d<13) return 13 - G.date.d; if(G.date.m===1 && G.date.d<10 && !G.match.winSpr) return 10 - G.date.d; return 99; }

function NextDay() {
  if(IsMatchDay()) { const ev = GetEv(G.date.m, G.date.d); if(ev) StartMatch(ev, 1, false); else if(G.match.next) StartMatch(G.match.next.name, G.match.next.round, G.match.next.isNat); return; }
  if(G.date.m === 11 && G.date.d === 1 && !G.scoutDone) { StartScoutEvent(); return; }
  
  G.team.forEach(p => {
    if(Math.random() < 0.3) { if(Math.random() < 0.5 && p.cond < 4) p.cond++; else if(p.cond > 0) p.cond--; }
    if(Math.random() < 0.01) p.cond = 5; 
    const m = MENU.find(x=>x.id===p.menu)||MENU[0]; const efficiency = 0.6 + (G.lv * 0.008); let baseGain = 0.45; if(m.s.length===1) baseGain=1.0; if(m.s.length===2) baseGain=0.6; if(m.s.length>=7) baseGain=0.15;
    STATS.forEach(s => { let g = 0.05; if(m.s.includes(s.id)) g = baseGain; g *= p.pers.m * efficiency * GetGrowthMod(p.stats[s.id]); p.stats[s.id] = Math.min(100, p.stats[s.id]+g); });
    p.apt[p.pos] = Math.min(100, p.apt[p.pos]+(p.menu==='pos'?12:0.3));
    if(p.gCur < p.gMax && Math.random()<0.4) { let grow = Math.random()*0.2; if(p.gCur+grow>p.gMax) grow=p.gMax-p.gCur; p.gCur+=grow; if(!p.hNow) p.hNow=170; p.hNow+=grow; }
  });
  let add = 3; const days = GetDaysToNext(); if(days>0 && days<=3) add = days; 
  G.date.d += add; G.match.played = false; if(G.date.d > 30) { G.date.d=1; G.date.m++; }
  if(G.date.m > 12) { G.date.m=1; G.date.y++; G.match.winSpr = false; G.match.next = null; G.pracMonth=0; G.scoutDone=false; G.team.forEach(p=>p.grade++); G.team = G.team.filter(p=>p.grade<=3); for(let i=0;i<6;i++) if(G.starters[i]&&G.starters[i].grade>3) G.starters[i]=null; if(G.libero&&G.libero.grade>3) G.libero=null; }
  if(G.date.m===4 && G.date.d===1) { ChangeView('v-scout'); RenderScout(); } else { UpdateUI(); } Save();
}

function StartScoutEvent() {
  G.scoutDone = true; window.scoutCandidates = []; 
  let candNum = 4; if(G.lv >= 30) candNum = 6; if(G.lv >= 60) candNum = 8;
  for(let i=0; i<candNum; i++) window.scoutCandidates.push(MakePlayer(1));
  let slot = 1; if(G.lv>=20) slot=2; if(G.lv>=50) slot=3; if(G.lv>=80) slot=4; window.scoutSlot = slot;
  ChangeView('v-scout-select'); DrawScoutList();
}
function DrawScoutList() { document.getElementById('sc-lv').innerText = G.lv; document.getElementById('sc-slot').innerText = window.scoutSlot; const el = document.getElementById('list-scout-cand'); el.innerHTML = ""; window.scoutCandidates.forEach(p => RenderScoutCard(p, el)); }
function DoScout(id) {
  if(window.scoutSlot <= 0) return alert("ã‚¹ã‚«ã‚¦ãƒˆæ ãŒã‚ã‚Šã¾ã›ã‚“ï¼"); const p = window.scoutCandidates.find(x => x.id === id); if(!p) return;
  if(confirm(`è©•ä¾¡: ${GetRank(Object.values(p.stats).reduce((a,b)=>a+b,0)/8)}\n${p.name} (${p.pos})\nã“ã®é¸æ‰‹ã‚’ã‚¹ã‚«ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ(å¿…ãšæˆåŠŸã—ã¾ã™)`)) {
    G.scouted.push(p); window.scoutSlot--; window.scoutCandidates = window.scoutCandidates.filter(x => x.id !== id); DrawScoutList(); alert("ã‚¹ã‚«ã‚¦ãƒˆæˆåŠŸï¼æ¥å¹´4æœˆã«å…¥éƒ¨ã—ã¾ã™ã€‚");
  }
}
function FinishScout() { if(window.scoutSlot > 0) { if(!confirm(`ã¾ã ${window.scoutSlot}äººã‚¹ã‚«ã‚¦ãƒˆã§ãã¾ã™ãŒã€çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ`)) return; } window.scoutCandidates = null; ChangeView('v-main'); UpdateUI(); Save(); }

function PracticeM() { if(G.match.played) return alert("è©¦åˆçµ‚äº†æ¸ˆã¿ã§ã™"); if(G.pracMonth === G.date.m) return alert("ç·´ç¿’è©¦åˆã¯æœˆ1å›ã¾ã§ã§ã™"); if(confirm("ç·´ç¿’è©¦åˆã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ")) { G.pracMonth = G.date.m; StartMatch("ç·´ç¿’è©¦åˆ", 1, false); } }

// v69.0: Briefing
function StartMatch(name, round, isNat) {
  if(!G.starters.every(s=>s)) { AutoOrder(); if(!G.starters.every(s=>s)) return alert("ã‚¹ã‚¿ãƒ¡ãƒ³ä¸è¶³ã§ã™ã€‚"); }
  
  let enemyData = null;
  if (name === "ç·´ç¿’è©¦åˆ") {
      enemyData = { name: "è¿‘æ‰€ã®é«˜æ ¡", type: {n:"ç·´ç¿’ç›¸æ‰‹", atk:0.8, def:0.8}, pow: Math.floor(20 + G.lv * 0.5) };
  } else {
      enemyData = GenerateEnemy(round, isNat);
  }
  
  G.match.active = true; G.match.name = name; G.match.round = round; G.match.isNat = isNat; 
  G.match.pow = enemyData.pow; G.match.enemyType = enemyData.type;
  G.match.my=0; G.match.opp=0; G.match.court=[...G.starters]; G.match.mbBench=null; 
  G.match.isMyServe = Math.random() < 0.5; G.match.flow = 0; G.match.to = 2; G.match.auto = false;
  
  document.getElementById('ui-match-brief').style.display = 'flex';
  document.getElementById('brief-info').innerText = `${name} ${isNat?'å…¨å›½':''} ${round}å›æˆ¦`;
  document.getElementById('brief-power').innerText = `ç›¸æ‰‹: ${enemyData.name} (æˆ¦åŠ›:${enemyData.pow})`;
}

function RealStartMatch() {
  document.getElementById('ui-match-brief').style.display = 'none';
  document.getElementById('ui-match').style.display = 'block'; 
  UpdateTOBtn();
  const mInfo = document.getElementById('m-info');
  mInfo.innerHTML = `${G.match.name} ${G.match.isNat?'å…¨å›½':''} ${G.match.round}å›æˆ¦<br><span style="color:var(--lose); font-size:1.2em;">ç·åˆåŠ›:${G.match.pow}</span>`;
  document.getElementById('m-log').innerHTML = ""; document.getElementById('m-end').style.display='none'; document.getElementById('btn-next-rd').style.display='none'; document.getElementById('btn-force').style.display='none';
  
  Sound.playSE('whistle'); 
  let bgmType = 'match'; if (G.match.round === 5) { bgmType = 'finals'; Log("ğŸ”¥ æ±ºå‹æˆ¦ï¼ç›¸æ‰‹ã¯æ ¼ä¸Šã ï¼", "var(--accent)", true); }
  Sound.playBGM(bgmType);
  
  CheckLibero(); DrawMatch(); 
  if(G.match.isMyServe) { Log("å‘³æ–¹ã®ã‚µãƒ¼ãƒ–ã§ã™ã€‚", "cyan"); NextCmd(); } else { Log("ç›¸æ‰‹ã®ã‚µãƒ¼ãƒ–ã§ã™ã€‚", "var(--lose)"); AutoAction(); }
}

function CheckLibero() { 
  if(!G.libero) return; 
  const c = G.match.court; 
  [0, 1, 2].forEach(i => { if(c[i].id === G.libero.id && G.match.mbBench) { c[i] = G.match.mbBench; G.match.mbBench = null; } });
  [4, 5].forEach(i => { if(c[i].pos === 'MB' && c[i].id !== G.libero.id) { G.match.mbBench = c[i]; c[i] = G.libero; } });
}
function Rotate() { 
  if(G.match.mbBench) { const c = G.match.court; const idx = c.findIndex(p => p.id === G.libero.id); if(idx !== -1) { c[idx] = G.match.mbBench; G.match.mbBench = null; } }
  const c = G.match.court; c.unshift(c.pop()); CheckLibero(); 
}

function DrawMatch() { 
  document.getElementById('s-my').innerText = G.match.my; document.getElementById('s-opp').innerText = G.match.opp; 
  const el = document.getElementById('m-court'); el.innerHTML = ""; 
  [0,1,2].forEach(i=>{ const p=G.match.court[i]; el.innerHTML+=`<div class="pos" onclick="ShowDetail('${p.id}')">${p.name.split(' ')[0]}<br>${p.pos}</div>`; }); 
  [5,4,3].forEach(i=>{ const p=G.match.court[i]; el.innerHTML+=`<div class="pos back" onclick="ShowDetail('${p.id}')">${p.name.split(' ')[0]}<br>${p.pos}${i===3?' (S)':''}</div>`; }); 
  const courtEl = document.getElementById('m-court'); courtEl.classList.remove('good-flow', 'bad-flow');
  if(G.match.flow >= 2) courtEl.classList.add('good-flow'); if(G.match.flow <= -2) courtEl.classList.add('bad-flow');
}
function ShowDetail(pid) { const p = G.team.find(x => x.id === pid); if(!p) return; const box = document.getElementById('detail-card'); box.innerHTML = ""; RenderCard(p, box, true); document.getElementById('ui-detail').style.display = 'flex'; }
function CloseDetail() { document.getElementById('ui-detail').style.display = 'none'; }
function ShowHelp() { 
  document.getElementById('ui-help').style.display = 'flex'; 
  SwitchHelpTab('basic', document.querySelector('#ui-help .tab-btn'));
}
function CloseHelp() { document.getElementById('ui-help').style.display = 'none'; }

function TimeOut() {
  if(!G.match.active) return; if(G.match.to <= 0) return alert("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ã‚‚ã†ä½¿ãˆã¾ã›ã‚“"); if(G.match.flow >= 0) return alert("ä»Šã¯ç›¸æ‰‹ã®æµã‚Œã§ã¯ã‚ã‚Šã¾ã›ã‚“");
  G.match.to--; G.match.flow = 0; Effect('flash'); Sound.playSE('whistle'); Log("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å–ã‚Šã¾ã—ãŸã€‚ç›¸æ‰‹ã®æµã‚Œã‚’æ–­ã¡åˆ‡ã£ãŸï¼", "white"); UpdateTOBtn(); DrawMatch();
}
function ToggleAuto() {
  G.match.auto = !G.match.auto;
  const btn = document.getElementById('btn-auto');
  if(G.match.auto) { btn.classList.add('active'); btn.innerText = "â–  åœæ­¢"; 
    if(G.match.isMyServe) NextCmd(); else AutoAction(); 
  } else { btn.classList.remove('active'); btn.innerText = "â–¶ ãŠã¾ã‹ã›"; }
}
function UpdateTOBtn() {
  const btn = document.getElementById('btn-to'); btn.innerText = `âœ‹ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (æ®‹${G.match.to})`;
  btn.style.opacity = (G.match.to > 0 && G.match.flow < 0) ? 1 : 0.5; btn.disabled = !(G.match.to > 0 && G.match.flow < 0);
  const aBtn = document.getElementById('btn-auto'); if(G.match.auto) { aBtn.classList.add('active'); aBtn.innerText = "â–  åœæ­¢"; } else { aBtn.classList.remove('active'); aBtn.innerText = "â–¶ ãŠã¾ã‹ã›"; }
}
function Effect(type) {
  if(type==='shake') { document.body.classList.add('shake'); setTimeout(()=>document.body.classList.remove('shake'), 500); }
  if(type==='flash') { const el = document.getElementById('flash-layer'); el.classList.add('flash-fx'); setTimeout(()=>el.classList.remove('flash-fx'), 300); }
}

function NextCmd() {
  const box = document.getElementById('m-cmd'); box.innerHTML = ""; document.getElementById('m-state').innerText = "Command Phase";
  if(G.match.auto) {
    box.innerHTML = `<div style="grid-column:span 2; text-align:center; color:#f1c40f;">Auto Playing...</div>`;
    setTimeout(() => {
      if(!G.match.active) return;
      if(G.match.isMyServe) {
        const c = G.match.court; const candidates = []; [0,1,2].forEach(i => { if(c[i]) candidates.push(c[i].id); });
        const ba = c[5]; if(ba && ba.pos==='OH') candidates.push(ba.id);
        const sId = candidates[Math.floor(Math.random() * candidates.length)];
        Action(sId, 50); 
      } else { AutoAction(); }
    }, 600);
    return; 
  }
  const c = G.match.court; let s = [c[3],c[4],c[5],c[0],c[1],c[2]].find(p=>p && p.pos==='S') || c[1];
  const flowBonus = Math.max(0, G.match.flow * 0.1); 
  [0,1,2].forEach(i => {
    const p = c[i]; if(!p) return;
    let type='spike', lbl='æ”»æ’ƒ'; if(p.pos==='MB') {type='quick'; lbl='ã‚¯ã‚¤ãƒƒã‚¯';} else if(p.id===s.id) {if(Math.random()>0.3) return; type='quick'; lbl='ãƒ„ãƒ¼';} else if(i===1) {type='quick'; lbl='æ™‚é–“å·®';} else if(i===2) {type='spike'; lbl='ãƒ©ã‚¤ãƒˆ';} else {type='spike'; lbl='ãƒ¬ãƒ•ãƒˆ';}
    const apt = (p.apt[p.pos]||0)/100; const condMod = GetCondVal(p); const rate = (0.6 + (0.4 * apt)) * condMod; const hBonus = ((p.hNow||170) - 170) * 0.5;
    let sTos = s.stats.tos * GetCondVal(s); if(HasSkill(s,'brain')) sTos += 10; if(HasSkill(s,'monotone')) sTos -= 10; if(HasSkill(s,'longbad') && (type==='spike')) sTos -= 8;
    let pow = p.stats.pow, tec = p.stats.tec, jmp = p.stats.jmp, spd = p.stats.spd;
    if(HasSkill(p,'muscle')) pow+=10; if(HasSkill(p,'straight')) { tec+=5; pow+=5; } if(HasSkill(p,'inner')) tec+=10; 
    if(HasSkill(p,'backswing')) jmp+=10; if(HasSkill(p,'wrist')) { pow-=5; tec+=10; jmp+=10; } if(HasSkill(p,'turn')) { jmp+=5; tec+=8; } 
    if(HasSkill(p,'circular')) pow+=10; if(HasSkill(p,'yakult')) jmp-=20; if(HasSkill(p,'fukashi')) pow+=5; 
    if(HasSkill(p,'trust') && G.match.my < G.match.opp) { pow+=10; tec+=10; jmp+=10; spd+=10; }
    if(HasSkill(p,'dump') && lbl==='ãƒ„ãƒ¼') { pow+=7; tec+=7; } if(HasSkill(p,'feint')) tec+=8;
    const basePower = ((pow+tec+jmp+spd)/4)*condMod * (1.0 + flowBonus); 
    let enemyDef = G.match.pow * 0.9;
    if(G.match.enemyType && G.match.enemyType.def) enemyDef *= G.match.enemyType.def;
    if(HasSkill(p,'blockout')) enemyDef *= 0.9; if(HasSkill(p,'circular')) enemyDef -= 10;
    let est = Math.floor(Math.min(99, Math.max(5, (20 + (basePower*1.2+hBonus)*(sTos/100)*0.8 - (enemyDef * 0.5)) * rate)));
    if(HasSkill(p,'feint')) est += 8; if(G.match.last===p.id) est-=15;
    const btn = document.createElement('button'); btn.className = "cmd"; 
    btn.innerHTML = `<b>${lbl}: ${p.name.split(' ')[0]}</b><span>ç¢ºç‡${est}%</span>`; 
    btn.onclick = () => Action(p.id, est); box.appendChild(btn);
  });
  const ba = c[5];
  if(ba && ba.pos==='OH' && ba.id!==s.id) {
    let est = 30 * GetCondVal(ba);
    if(HasSkill(ba,'backtoss') && (ba.pos==='OP'||c[2].id===s.id)) est+=10; if(G.match.last===ba.id) est-=15;
    const btn = document.createElement('button'); btn.className = "cmd"; 
    btn.innerHTML = `<b>ãƒãƒƒã‚¯: ${ba.name.split(' ')[0]}</b><span>ç¢ºç‡${Math.floor(est)}%</span>`; 
    btn.onclick = () => Action(ba.id, Math.max(5, Math.floor(est))); box.appendChild(btn);
  }
}
function ForceNext() { AutoAction(); }

function Action(id, est) {
  document.getElementById('m-cmd').innerHTML = ""; document.getElementById('m-state').innerText = "Rally..."; G.match.last = id;
  const srv = G.match.court[3]; 
  
  if(G.match.isMyServe) {
      let srvS = srv.stats.srv, srvP = srv.stats.pow, srvT = srv.stats.tec;
      if(HasSkill(srv,'spksrv')) { srvS+=10; srvP+=10; srvT+=10; } if(HasSkill(srv,'jmpfloat')) { srvS+=5; srvP+=5; srvT+=5; } if(HasSkill(srv,'float')) srvS+=5; 
      if(HasSkill(srv,'nospin')) srvP+=5; if(HasSkill(srv,'pressbad')) { srvS-=10; srvP-=10; srvT-=10; } if(HasSkill(srv,'justin')) srvP=0;
      let srvChance = ((srvS*0.7+srvP*0.15+srvT*0.15)*GetCondVal(srv)/100*0.05);
      if(HasSkill(srv,'spksrv')) srvChance += 0.02; if(HasSkill(srv,'netmid')) srvChance -= 0.05;
      let srvMiss = 0.05; if(HasSkill(srv,'spksrv')) srvMiss += 0.10; if(HasSkill(srv,'netmid')) srvMiss += 0.10; if(HasSkill(srv,'justin')) srvMiss = 0;
      if(Math.random() < srvMiss) { Log(`${srv.name}: ${Pick(LOGS.miss)} (ã‚µãƒ¼ãƒ–ãƒŸã‚¹)`, "var(--lose)"); Score(false,true); return; }
      if(Math.random() < srvChance) { 
        Log(`${srv.name}: ${Pick(LOGS.ace)}`, "gold", true); 
        Sound.playSE('whistle'); 
        Effect('shake'); // Ace: Keep shake
        srv.hist.score++; Score(true,true); return; 
      }
  }
  
  const s = [G.match.court[3],G.match.court[4],G.match.court[5],G.match.court[0],G.match.court[1],G.match.court[2]].find(p=>p.pos==='S') || G.match.court[1];
  if(s) {
    let sMiss = 0.15 - ((s.stats.tec+s.stats.tos)*GetCondVal(s)/2000);
    if(HasSkill(s,'soft')) { s.stats.tos+=8; sMiss -= 0.05; } if(HasSkill(s,'dribble')) sMiss += 0.05;
    if(Math.random() < Math.max(0.01, sMiss)) { Log(`${s.name.split(' ')[0]}: ${Pick(LOGS.toss_miss)}`, "var(--lose)"); Score(false,true); return; }
  }
  const p = G.match.court.find(x=>x.id===id);
  if(p) {
    let missRate = 0.20-((p.stats.tec+p.stats.iq)*GetCondVal(p)*0.0008)-(p.pers.n==='å†·é™'?0.01:0);
    if(HasSkill(p,'fukashi')) missRate += 0.1; if(HasSkill(p,'under')) missRate += 0.05;
    if(Math.random() < Math.max(0.02, missRate)) { Log(`${p.name}: ${Pick(LOGS.miss)}`, "var(--lose)"); Score(false,true); return; }
  }
  if(Math.random()*100 < est) {
    if(s && HasSkill(s,'onehand') && Math.random()<0.05) G.match.pow -= 5;
    const type = p && p.pos==='MB' ? 'quick' : 'atk';
    Log(`${p?p.name:"å‘³æ–¹"}: ${Pick(LOGS[type])}`, "var(--main)", true); 
    Sound.playSE('spike'); 
    // Effect('shake'); // v69.1: Remove shake on spike
    if(p){ p.hist.score++; p.hist.atk++; } Score(true,true);
  } else {
    let rebC = p ? ((p.stats.tec+p.stats.iq)*GetCondVal(p))/200 : 0.3; if(p && HasSkill(p,'rebound')) rebC += 0.1;
    if(Math.random() < rebC) { Log(Pick(LOGS.rebound), "var(--ok)"); Sound.playSE('recv'); setTimeout(NextCmd,800); return; }
    Log(`ç›¸æ‰‹: ${Pick(LOGS.blk)}`, "var(--lose)"); if(p) p.hist.atk++; Score(false,true);
  }
}

function AutoAction() {
  document.getElementById('m-cmd').innerHTML = "";
  const zone = Math.floor(Math.random() * 3);
  const flowBonus = Math.max(0, G.match.flow * -0.1); 
  
  let typeMod = G.match.enemyType && G.match.enemyType.atk ? G.match.enemyType.atk : 1.0;
  let enP = G.match.pow * typeMod * (0.9 + Math.random()*0.3) * (1.0 + flowBonus);
  
  if(!G.match.isMyServe) {
      let aceRate = 0.1;
      if(typeMod > 1.1) aceRate = 0.15; 
      if(Math.random() < aceRate) { Log("ç›¸æ‰‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¹...", "var(--lose)"); Score(false, false); return; }
      if(Math.random() < 0.1) { Log("ç›¸æ‰‹ã®ã‚µãƒ¼ãƒ–ãƒŸã‚¹ï¼", "var(--ok)"); Score(true, false); return; }
  }

  const blk = G.match.court[zone]; const mb = G.match.court[1]; 
  const bM = GetCondVal(blk); const mbM = GetCondVal(mb);
  let bJ=blk.stats.jmp, bP=blk.stats.pow, bI=blk.stats.iq, bSp=blk.stats.spd;
  if(HasSkill(blk,'commit')) bI+=10; if(HasSkill(blk,'step')) bSp+=10; if(HasSkill(blk,'lead')) bSp+=10; 
  if(HasSkill(blk,'laststand')) { bJ+=5;bP+=5;bI+=5;bSp+=5; } if(HasSkill(blk,'handbad')) { bJ-=5;bP-=5;bI-=5;bSp-=5; }
  if(HasSkill(blk,'mathoa')) enP *= 0.9;
  let mbJ=mb.stats.jmp, mbP=mb.stats.pow, mbI=mb.stats.iq, mbSp=mb.stats.spd; if(HasSkill(mb,'step')) mbSp+=10;
  let blkS = 0; let is2 = false;
  if(zone !== 1) {
    if(HasSkill(mb,'blkskip') && Math.random()<0.1) { } 
    else if(Math.random() < ((mbSp+mbI)*mbM)/200) { is2 = true; blkS = (bJ*bM + bP*bM + bI*bM) + (mbJ*mbM + mbP*mbM + mbI*mbM); blkS /= 1.5; } 
    else {
      if((mb.hNow||170)+(mbJ*mbM) > 220+(Math.random()*20)) { blkS = (bJ*bM + bP*bM + bI*bM) + ((mbJ+mbP)*mbM*0.7); blkS /= 1.5; Log(Pick(LOGS.blk_late_h), "var(--sub)"); } 
      else { Log(Pick(LOGS.blk_late), "var(--sub)"); blkS = (bJ*bM + bP*bM + bI*bM); }
    }
  } else { blkS = (mbJ*mbM + mbP*mbM + mbI*mbM); }
  
  blkS += ((blk.hNow||170) - 175) * 1.0; 
  if(Math.random() < 0.1) blkS *= 0.9;
  if(blkS > enP * 2.5) { 
    Log(HasSkill(blk,'mathoa')?LOGS.mathoa[0]:(is2?Pick(LOGS.blk_2):Pick(LOGS.blk)), "var(--ok)", true); 
    Effect('shake'); // Block: Keep shake
    Score(true,false); return; 
  } 
  
  if(HasSkill(blk,'onetouch') || HasSkill(mb,'onetouch')) { if(blkS > enP*0.8) enP*=0.5; } 
  else if(blkS > enP) enP *= 0.65; 
  else enP -= (blkS * 0.1); 
  
  if(enP<5) enP=5;
  let pool=[]; [3,4,5].forEach(i=>{pool.push(i); if(G.match.court[i].pos==='L'){pool.push(i);pool.push(i);pool.push(i);}});
  const rec = G.match.court[pool[Math.floor(Math.random()*pool.length)]];
  const rM = GetCondVal(rec);
  let rR=rec.stats.rec, rS=rec.stats.spd, rI=rec.stats.iq;
  if(HasSkill(rec,'dig')) { rR+=5; rS+=5; rI+=5; } if(HasSkill(rec,'readspk')) rR+=10; if(HasSkill(rec,'firststep')) rS+=5; 
  if(HasSkill(rec,'flying')) { rS+=3;rR+=3; } if(HasSkill(rec,'reflex')) rS+=10; if(HasSkill(rec,'libero') && rec.pos==='L') { rR+=5;rS+=5;rI+=5; } 
  if(HasSkill(rec,'swingarm')) { rR-=5;rS-=5;rI-=5; } if(HasSkill(rec,'immobile')) rS-=10; if(HasSkill(rec,'overcut')) rR+=10;
  const recS = (rR+rS+rI)*rM;
  if(HasSkill(rec,'recskip') && Math.random()<0.05) { Log(`${rec.name.split(' ')[0]}: ã•ã¼ã£ãŸ...`, "var(--lose)"); Score(false,false); return; }
  const s = [G.match.court[3],G.match.court[4],G.match.court[5],G.match.court[0],G.match.court[1],G.match.court[2]].find(p=>p.pos==='S') || G.match.court[1];
  if(HasSkill(s,'cover')) enP -= 5;
  if(Math.random() < Math.max(0.1, Math.min(0.95, 0.4+(recS-enP)*0.01))) {
    Log(`${rec.name.split(' ')[0]}: ${Pick(LOGS.rec_nice)}`, "var(--ok)"); Sound.playSE('recv'); Score(true,false);
  } else {
    if(HasSkill(rec,'pancake') && Math.random()<0.05) { Log(`${rec.name.split(' ')[0]}: ${LOGS.pancake[0]}`, "var(--ok)", true); Score(true,false); return; }
    if(HasSkill(rec,'overcut') && Math.random()<0.05) { Log(`${rec.name.split(' ')[0]}: è¬ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆï¼`, "var(--ok)"); Score(true,false); return; }
    Log(`${rec.name.split(' ')[0]}: ${rec.stats.rec<30?Pick(LOGS.rec_pop):Pick(LOGS.rec_fail)}`, "var(--lose)"); Score(false,false);
  }
}

function Save() { const d = { team: G.team, date: G.date, lv: G.lv, next: G.match.next, winSpr: G.match.winSpr, played: G.match.played, sIds: G.starters.map(p=>p?p.id:null), lId: G.libero?G.libero.id:null, pracMonth: G.pracMonth, scouted: G.scouted, scoutDone: G.scoutDone, isMyServe: G.match.isMyServe, unlockedSkills: G.unlockedSkills }; localStorage.setItem("EIKAN_V71_0_ULTIMATE", JSON.stringify(d)); }

function Log(msg, color, big=false) { 
  const div = document.createElement('div'); div.className = 'l-row' + (big?' log-big':''); 
  div.style.color = color; div.innerText = msg; 
  const el = document.getElementById('m-log'); el.insertBefore(div, el.firstChild); 
}

// v69.1 Tuned: Exp Boost & Fix
function FinishMatch() { 
  const win = G.match.my > G.match.opp; Log(`è©¦åˆçµ‚äº† ${G.match.my}-${G.match.opp}`, win?"gold":"#ccc", true); G.match.played = true; 
  const myP = G.starters.reduce((a,b)=>a+(Object.values(b.stats).reduce((x,y)=>x+y,0)/8),0)/6; 
  if(win) { 
      if(G.lv<100) G.lv++; 
      // Unlock Logic (v70.0)
      const locked = SKILLS.filter(s => !G.unlockedSkills.includes(s.id));
      if (locked.length > 0) {
          const newSk = Pick(locked);
          G.unlockedSkills.push(newSk.id);
          Log(`ã€ç ”ç©¶ã€‘ã€${newSk.n}ã€ã®åŠ¹æœãŒåˆ¤æ˜ã—ã¾ã—ãŸï¼`, "cyan");
      }
  } else { 
      if(G.match.pow<myP-10) {G.lv=Math.max(1,G.lv-3); Log("æ ¼ä¸‹ã«æ•—åŒ—...","var(--lose)");} else if(G.match.pow<=myP+10) {G.lv=Math.max(1,G.lv-1);} 
  } 
  
  let sB = 1.0; 
  if(G.match.name!=="ç·´ç¿’è©¦åˆ") sB = G.match.isNat ? 1.8 : 1.2; 
  
  const eB = G.match.pow / 50; 
  G.team.forEach(p => { 
    if(G.starters.some(s=>s.id===p.id) && Math.random() < 0.1) { 
      let perf = 0; if(p.pos==='OH'||p.pos==='MB') perf = p.hist.score*10 - (p.hist.atk - p.hist.score)*2; else if(p.pos==='S') perf = G.match.my - (HasSkill(p,'dribble')?20:0); else if(p.pos==='L') perf = (25 - G.match.opp)*2; 
      const isBad = !win && perf < 10; const isGood = win || perf > 30; 
      if(isGood) { 
        const neg = (p.skills||[]).find(sid => SKILLS.find(k=>k.id===sid).t === 'n'); 
        if(neg) { p.skills = p.skills.filter(s => s !== neg); Log(`${p.name}ãŒå¼±ç‚¹ã‚’å…‹æœï¼`, "cyan"); } 
        else { const cand = SKILLS.filter(k=>k.t==='p' && !(p.skills||[]).includes(k.id)); if(cand.length>0) { const newSk = Pick(cand); if(!p.skills) p.skills=[]; p.skills.push(newSk.id); Log(`${p.name}ãŒã€Œ${newSk.n}ã€ã«è¦šé†’ï¼`, "cyan"); } } 
      } else if(isBad) { 
        const cand = SKILLS.filter(k=>k.t==='n' && !(p.skills||[]).includes(k.id)); if(cand.length>0 && Math.random()<0.3) { const newSk = Pick(cand); if(!p.skills) p.skills=[]; p.skills.push(newSk.id); Log(`${p.name}ãŒã€Œ${newSk.n}ã€ã«ãªã£ã¦ã—ã¾ã£ãŸ...`, "magenta"); } 
      } 
    } 
    const isSt = G.starters.some(s=>s&&s.id===p.id); const m = MENU.find(x=>x.id===p.menu)||MENU[0]; 
    let bG = 2.0; let tM = 0.45; if(m.s.length===1) tM=1.0; if(m.s.length===2) tM=0.6; if(m.s.length>=7) tM=0.15; 
    const part = isSt ? 1.0 : 0.25; 
    STATS.forEach(s => { let g = 0.05; if(m.s.includes(s.id)) g = bG*tM*sB*eB*part; g *= GetGrowthMod(p.stats[s.id]); p.stats[s.id] = Math.min(100, p.stats[s.id]+g); }); 
  }); 
  Log("éƒ¨å“¡ãŸã¡ãŒçµŒé¨“å€¤ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚", "var(--text)");
  Sound.playSE('whistle');
  document.getElementById('m-end').style.display='block'; 
  if(win) { 
    if(G.match.name!=="ç·´ç¿’è©¦åˆ" && G.match.round<5) { 
      let nm=G.date.m, nd=G.date.d+7; if(nd>30){nm++; nd-=30;} if(nm>12)nm=1; 
      G.match.next = {m:nm, d:nd, name:G.match.name, round:G.match.round+1, isNat:G.match.isNat}; document.getElementById('btn-next-rd').style.display='block'; 
    } else { 
      if(G.match.name!=="ç·´ç¿’è©¦åˆ") { 
        if(!G.match.isNat && (G.match.name.includes("IH")||G.match.name.includes("æ˜¥"))) { let nm=G.date.m+1; if(nm>12)nm=1; let nd=10; G.match.next = {m:nm, d:nd, name:G.match.name.replace("äºˆé¸",""), round:1, isNat:true}; document.getElementById('btn-next-rd').style.display='block'; Log("ğŸ† äºˆé¸çªç ´ï¼å…¨å›½å¤§ä¼šã¸ï¼","gold",true); } 
        else { Log("ğŸ† å…¨å›½åˆ¶è¦‡ï¼","gold",true); if(G.match.name.includes("æ˜¥")) G.match.winSpr=true; G.match.next=null; } 
      } else G.match.next=null; 
    } 
  } else { Log("æ•—é€€...","#aaa"); G.match.next=null; } 
  Save(); 
}
function EndMatchUI() { document.getElementById('ui-match').style.display='none'; UpdateUI(); Sound.playBGM('daily'); }

function ShowOrder() { 
  tempOrder = [...G.starters]; 
  const list = document.getElementById('ord-court'); list.innerHTML = ""; const mapIdx = [0, 1, 2, 5, 4, 3]; 
  for(let i=0; i<6; i++) { 
    const idx = mapIdx[i]; const isBack = i >= 3; const div = document.createElement('div'); div.className = "pos-edit" + (isBack ? " back" : ""); 
    let posLbl = ""; if(idx===0) posLbl="å‰å·¦(4)"; else if(idx===1) posLbl="å‰ä¸­(3)"; else if(idx===2) posLbl="å‰å³(2)"; else if(idx===5) posLbl="å¾Œå·¦(5)"; else if(idx===4) posLbl="å¾Œä¸­(6)"; else if(idx===3) posLbl="å¾Œå³(1)SRV"; 
    div.innerHTML = `<label>${posLbl}</label>`; 
    const sel = document.createElement('select'); 
    sel.innerHTML = `<option value="">---</option>` + G.team.filter(p=>p.pos!=='L').map(p=>{
      const tot = Math.floor(Object.values(p.stats).reduce((a,b)=>a+b,0));
      const condI = COND[p.cond].n;
      const selStr = (tempOrder[idx]&&tempOrder[idx].id===p.id)?'selected':'';
      return `<option value="${p.id}" ${selStr}>${p.name} (${p.pos}) ${condI} â˜…${tot}</option>`;
    }).join(''); 
    sel.onchange = function() { const nid = this.value; if(nid) { const dup = tempOrder.findIndex((p, x) => x!==idx && p && p.id===nid); if(dup !== -1) { const old = tempOrder[idx]; tempOrder[idx] = G.team.find(p=>p.id===nid); tempOrder[dup] = old; ShowOrder(); return; } tempOrder[idx] = G.team.find(p=>p.id===nid); } else { tempOrder[idx] = null; } }; div.appendChild(sel); list.appendChild(div); 
  } 
  const lsel = document.getElementById('sel-lib'); 
  lsel.innerHTML = `<option value="">ãªã—</option>` + G.team.filter(p=>p.pos==='L').map(p => {
      const tot = Math.floor(Object.values(p.stats).reduce((a,b)=>a+b,0));
      return `<option value="${p.id}" ${G.libero&&G.libero.id===p.id?'selected':''}>${p.name} ${COND[p.cond].n} â˜…${tot}</option>`;
  }).join(''); 
  document.getElementById('ui-order').style.display='flex'; 
}

function CommitOrder() { G.starters = [...tempOrder]; const lid = document.getElementById('sel-lib').value; G.libero = lid ? G.team.find(p=>p.id===lid) : null; document.getElementById('ui-order').style.display='none'; UpdateUI(); Save(); }
function CloseOrder() { CommitOrder(); }

function SwitchHelpTab(cat, btn) {
  // Tab UI
  document.querySelectorAll('#ui-help .tab-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  
  const content = document.getElementById('help-content');
  let html = "";
  
  if (cat === 'basic') {
    html = `
      <div style="margin-bottom:10px;">
        <h4>ğŸ† ã‚²ãƒ¼ãƒ ã®ç›®çš„</h4>
        <p>ã‚ãªãŸã¯é«˜æ ¡ãƒãƒ¬ãƒ¼éƒ¨ã®ç›£ç£ã§ã™ã€‚æ—¥ã€…ã®ç·´ç¿’ã§é¸æ‰‹ã‚’è‚²ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒã‚¤ã¨æ˜¥é«˜ãƒãƒ¬ãƒ¼ã§ã®å…¨å›½åˆ¶è¦‡ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚</p>
        <p><b>å‹åˆ©æ¡ä»¶</b>: å…¨å›½å¤§ä¼šã®æ±ºå‹æˆ¦ã«å‹åˆ©ã™ã‚‹ã€‚<br><b>æ•—åŒ—æ¡ä»¶</b>: ç‰¹ã«ãªã—(ç¿Œå¹´ã«ç¶šã)ã€‚</p>
      </div>
      <div style="margin-bottom:10px;">
        <h4>ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨å¤§ä¼š</h4>
        <p><b>4æœˆ</b>: å…¥å­¦å¼ (æ–°å…¥ç”ŸåŠ å…¥)<br><b>5æœˆ</b>: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒã‚¤äºˆé¸<br><b>8æœˆ</b>: å¤åˆå®¿ (æˆé•·å¤§)<br><b>10æœˆ</b>: æ˜¥é«˜ãƒãƒ¬ãƒ¼äºˆé¸<br><b>11æœˆ</b>: ã‚¹ã‚«ã‚¦ãƒˆæ´»å‹• (æœ‰æœ›æ ªç²å¾—)<br><b>1æœˆ</b>: æ–°äººæˆ¦</p>
      </div>
      <div style="margin-bottom:10px;">
        <h4>â­ è©•åˆ¤Lv (ãƒ¬ãƒ™ãƒ«)</h4>
        <p>è©¦åˆã«å‹ã¤ã¨ä¸ŠãŒã‚Šã¾ã™ã€‚LvãŒé«˜ã„ã»ã©ç·´ç¿’åŠ¹ç‡ãŒä¸ŠãŒã‚Šã€ã‚¹ã‚«ã‚¦ãƒˆã§ã‚ˆã‚Šå¤šãã®é¸æ‰‹ã‚’ç²å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</p>
      </div>
    `;
  } else if (cat === 'pos') {
    html = `
      <h4>ğŸ“ ãƒã‚¸ã‚·ãƒ§ãƒ³ã¨é©æ­£</h4>
      <p>é¸æ‰‹ã«ã¯ã€Œé©æ­£ãƒã‚¸ã‚·ãƒ§ãƒ³ã€ãŒã‚ã‚Šã¾ã™ã€‚é©æ­£ãŒä½ã„ãƒã‚¸ã‚·ãƒ§ãƒ³ã«å°±ãã¨ã€è©¦åˆä¸­ã®èƒ½åŠ›ãŒ<b>æ¿€æ¸›</b>ã—ã¾ã™ã€‚</p>
      <table class="help-tbl">
        <tr><th>Pos</th><th>å½¹å‰²</th><th>é‡è¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th></tr>
        <tr><td><b>OH</b><br>ã‚¢ã‚¦ãƒˆã‚µã‚¤ãƒ‰</td><td>æ”»æ’ƒã®è¦ã€‚<br>ãƒ¬ãƒ•ãƒˆ/ãƒ©ã‚¤ãƒˆ</td><td><b>ãƒ‘ãƒ¯ãƒ¼ãƒ»æŠ€å·§</b><br>ã‚¸ãƒ£ãƒ³ãƒ—</td></tr>
        <tr><td><b>MB</b><br>ãƒŸãƒ‰ãƒ«</td><td>å®ˆå‚™ã®å£ã€‚<br>é€Ÿæ”»ãƒ»ãƒ–ãƒ­ãƒƒã‚¯</td><td><b>ãƒãƒãƒ»ãƒ‘ãƒ¯ãƒ¼</b><br>æ€è€ƒ</td></tr>
        <tr><td><b>S</b><br>ã‚»ãƒƒã‚¿ãƒ¼</td><td>å¸ä»¤å¡”ã€‚<br>æ”»æ’ƒã‚’æ“ã‚‹</td><td><b>æ€è€ƒãƒ»ãƒˆã‚¹</b><br>æŠ€å·§</td></tr>
        <tr><td><b>L</b><br>ãƒªãƒ™ãƒ­</td><td>å®ˆå‚™å°‚é–€ã€‚<br>å¾Œè¡›ã®ã¿</td><td><b>å®ˆå‚™ãƒ»ç¬ç™º</b><br>æ€è€ƒ</td></tr>
      </table>
      <p style="font-size:0.8rem; color:#e67e22;">â€»é©æ­£ã¯ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œãƒã‚¸ã‚·ãƒ§ãƒ³ã€ã§ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
    `;
  } else if (cat === 'train') {
    html = `
      <h4>ğŸ’ª ç·´ç¿’ã¨æˆé•·</h4>
      <p>3æ—¥ã”ã¨ã«ç·´ç¿’ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æŒ‡ç¤ºã—ã¾ã™ã€‚ã€ŒãŠã¾ã‹ã›ã€ã‚„ã€Œé‡ç‚¹å¼·åŒ–ã€ãªã©ã€é¸æ‰‹ã®ã‚¿ã‚¤ãƒ—ã«åˆã‚ã›ã¦é¸ã³ã¾ã—ã‚‡ã†ã€‚</p>
      <ul>
        <li><b>èƒ½åŠ›90ã®å£</b>: 90ã‚’è¶…ãˆã‚‹ã¨æˆé•·ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒéˆåŒ–ã—ã¾ã™ã€‚</li>
        <li><b>ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</b>: èª¿å­ãŒè‰¯ã„(ğŸ˜)ã¨è©¦åˆã§èƒ½åŠ›1.1å€ã€æ‚ªã„(ğŸ˜«)ã¨0.8å€ã«ãªã‚Šã¾ã™ã€‚</li>
      </ul>
      <h4>ğŸ” ã‚¹ã‚«ã‚¦ãƒˆ (11æœˆ)</h4>
      <p>æ¥å¹´ã®æ–°å…¥ç”Ÿã‚’å‹§èª˜ã—ã¾ã™ã€‚ãƒªã‚¹ãƒˆã®ä¸­ã‹ã‚‰æ¬²ã—ã„é¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚<br><b>LvãŒé«˜ã„ã»ã©ã€ãƒªã‚¹ãƒˆã®äººæ•°ã¨ç²å¾—æ ãŒå¢—ãˆã¾ã™ã€‚</b></p>
    `;
  } else if (cat === 'match') {
    html = `
      <h4>ğŸ è©¦åˆã®ãƒ«ãƒ¼ãƒ«</h4>
      <p>25ç‚¹ãƒãƒƒãƒã®ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«ã§ã™ã€‚</p>
      <dl>
        <dt>ã‚µã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆåˆ¶ (ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)</dt>
        <dd>ã€Œç›¸æ‰‹ã®ã‚µãƒ¼ãƒ–æ¨©ã€ã®æ™‚ã«å¾—ç‚¹ã™ã‚‹ã¨ã€ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³(æ™‚è¨ˆå›ã‚Š)ãŒç™ºç”Ÿã—ã€ã‚µãƒ¼ãƒ–æ¨©ã‚’å¾—ã¾ã™ã€‚</dd>
        <dt>ãƒªãƒ™ãƒ­äº¤ä»£</dt>
        <dd>å¾Œè¡›ã«å›ã£ãŸMB(ãƒŸãƒ‰ãƒ«ãƒ–ãƒ­ãƒƒã‚«ãƒ¼)ã¨è‡ªå‹•çš„ã«äº¤ä»£ã—ã¾ã™ã€‚</dd>
        <dt>æµã‚Œ (Flow)</dt>
        <dd>é€£ç¶šå¾—ç‚¹ã™ã‚‹ã¨ã€Œæµã‚Œã€ã«ä¹—ã‚Šã€èƒ½åŠ›ãŒãƒ–ãƒ¼ã‚¹ãƒˆã•ã‚Œã¾ã™ã€‚é€†ã«ç›¸æ‰‹ã®æµã‚Œã®æ™‚ã¯<b>ã€Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€</b>ã‚’ä½¿ã£ã¦æ–­ã¡åˆ‡ã‚Šã¾ã—ã‚‡ã†ã€‚</dd>
      </dl>
    `;
  }
  
  content.innerHTML = html;
}

function Score(isMy, isAtk) {
Â  if(isMy) {Â 
Â  Â  G.match.my++; G.match.flow = Math.max(0, G.match.flow) + 1; Effect('flash');Â 
Â  Â  if (!G.match.isMyServe) { Rotate(); G.match.isMyServe = true; }
Â  } else {Â 
Â  Â  G.match.opp++; G.match.flow = Math.min(0, G.match.flow) - 1; G.match.isMyServe = false;Â 
Â  }
Â  UpdateTOBtn(); DrawMatch();
Â  document.getElementById('s-my').innerText = G.match.my; document.getElementById('s-opp').innerText = G.match.opp;
Â  if(G.match.my>=25 && G.match.my-G.match.opp>=2) { FinishMatch(); return; }
Â  if(G.match.opp>=25 && G.match.opp-G.match.my>=2) { FinishMatch(); return; }
Â  if (G.match.isMyServe) { if (isMy) { setTimeout(NextCmd, 800); } else { setTimeout(AutoAction, 800); } } else { setTimeout(AutoAction, 800); }
}
</script>
</body>
</html>
