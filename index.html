<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ã‚ªãƒ¬ã‚ªãƒ¬">
<title>ä¿ºã®ã‚ªãƒ¬ãƒ³ã‚¸ã‚³ãƒ¼ãƒˆ - v56.0 Absolute Full</title>
<script>
  // === ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ (SVG Data URI) ===
  const ICON_SVG = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23e67e22%22/><path d=%22M50 0 C50 0 80 20 80 50 C80 80 50 100 50 100 M0 50 C0 50 20 20 50 20 C80 20 100 50 100 50 M0 50 C0 50 20 80 50 80 C80 80 100 50 100 50%22 stroke=%22white%22 stroke-width=%224%22 fill=%22none%22/></svg>`;
  
  const link1 = document.createElement('link');
  link1.rel = 'icon';
  link1.href = ICON_SVG;
  document.head.appendChild(link1);

  const link2 = document.createElement('link');
  link2.rel = 'apple-touch-icon';
  link2.href = ICON_SVG;
  document.head.appendChild(link2);
</script>
<style>
  /* === UI Design === */
  :root {
    --bg: #f4f6f9;
    --text: #2c3e50;
    --sub: #7f8c8d;
    --card: #ffffff;
    --border: #dcdde1;
    --shadow: rgba(0, 0, 0, 0.1);
    --main: #3498db;
    --accent: #e67e22; 
    --win: #f1c40f;
    --lose: #e74c3c;
    --ok: #27ae60;
    
    /* ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚«ãƒ©ãƒ¼ */
    --c-oh: #3498db;
    --c-mb: #27ae60;
    --c-s: #f1c40f;
    --c-l: #e67e22;
    
    /* ã‚¹ã‚­ãƒ«ã‚«ãƒ©ãƒ¼ */
    --sk-pos: #3498db;
    --sk-neg: #e74c3c;
  }

  body {
    font-family: "Helvetica Neue", Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 10px;
    padding-bottom: 120px;
    user-select: none;
    line-height: 1.5;
    -webkit-tap-highlight-color: transparent;
  }
  
  button {
    cursor: pointer;
    font-family: inherit;
    font-weight: bold;
    border: none;
    touch-action: manipulation;
    transition: opacity 0.2s;
  }
  
  button:active {
    opacity: 0.7;
  }
  
  .view {
    display: none;
    animation: fade 0.3s;
  }
  
  .active {
    display: block;
  }
  
  @keyframes fade {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .btn {
    width: 100%;
    padding: 14px;
    border-radius: 8px;
    color: #fff;
    font-size: 1rem;
    margin-top: 10px;
    box-shadow: 0 2px 5px var(--shadow);
  }
  
  .btn-m { background: var(--main); }
  .btn-g { background: var(--ok); }
  .btn-r { background: var(--lose); }
  .btn-y { background: var(--accent); }

  .header {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    border: 1px solid var(--border);
    text-align: center;
    box-shadow: 0 2px 8px var(--shadow);
    position: relative;
  }
  
  .cal {
    background: #ecf0f1;
    padding: 5px;
    border-radius: 6px;
    margin: 10px 0;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    border: 1px solid var(--border);
  }
  
  .day {
    padding: 6px 0;
    font-size: 0.75rem;
    color: #bdc3c7;
    position: relative;
    border-radius: 3px;
    background: #fff;
    text-align: center;
  }
  
  .day.today {
    background: var(--main);
    color: #fff;
    font-weight: bold;
  }
  
  .day.match {
    background: var(--lose);
    color: #fff;
    font-weight: bold;
  }
  
  .mark {
    font-size: 0.5rem;
    line-height: 1;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    opacity: 0.8;
  }

  /* === ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ === */
  .card {
    background: var(--card);
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 15px;
    border-left: 6px solid var(--main);
    position: relative;
    box-shadow: 0 2px 5px var(--shadow);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .card[data-pos="OH"] { border-left-color: var(--c-oh); }
  .card[data-pos="MB"] { border-left-color: var(--c-mb); }
  .card[data-pos="S"] { border-left-color: var(--c-s); }
  .card[data-pos="L"] { border-left-color: var(--c-l); }

  .c-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }
  
  .c-name {
    font-size: 1.15rem;
    font-weight: bold;
    color: var(--text);
  }
  
  .c-meta {
    font-size: 0.8rem;
    color: var(--sub);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
    color: #fff;
    vertical-align: middle;
  }
  
  .st { background: var(--accent); }
  .li { background: var(--ok); }
  
  .c-ovr {
    background: #ecf0f1;
    color: var(--text);
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
    border: 1px solid var(--border);
  }

  .stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 12px;
    background: #f7f9fa;
    padding: 8px;
    border-radius: 6px;
    margin: 6px 0;
    border: 1px solid #eee;
  }
  
  .s-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    align-items: center;
    border-bottom: 1px dashed #e0e0e0;
    padding-bottom: 2px;
  }
  
  .rnk {
    display: inline-block;
    width: 22px;
    text-align: center;
    border-radius: 3px;
    font-size: 0.75rem;
    margin-right: 6px;
    color: #fff;
    font-weight: bold;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
  }
  
  .r-SS { background: linear-gradient(45deg, #d35400, #f1c40f); } 
  .r-S { background: #f1c40f; color: #000; text-shadow: none; } 
  .r-A { background: #e67e22; }
  .r-B { background: #e74c3c; }
  .r-C { background: #3498db; }
  .r-D { background: #2ecc71; }
  .r-E { background: #1abc9c; }
  .r-F { background: #95a5a6; }
  .r-G { background: #bdc3c7; }

  .up-3 { color: #e67e22; font-weight: bold; font-size: 0.8rem; }
  .up-2 { color: #27ae60; font-weight: bold; font-size: 0.8rem; }
  .up-1 { color: #3498db; font-size: 0.7rem; }

  .c-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding-top: 4px;
  }
  
  .sk-tag {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .sk-p { background: var(--sk-pos); }
  .sk-n { background: var(--sk-neg); }

  .c-btm {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    margin-top: 4px;
  }
  
  .c-menu-btn {
    font-size: 0.7rem;
    padding: 8px 2px;
    background: #ecf0f1;
    color: var(--text);
    border-radius: 4px;
    text-align: center;
  }
  
  .c-menu-btn.active {
    background: var(--accent);
    color: #fff;
  }
  
  .c-pos-btn {
    flex: 1;
    font-size: 0.7rem;
    padding: 6px;
    background: #ecf0f1;
    border-radius: 4px;
    text-align: center;
  }
  
  .c-pos-btn.active {
    background: var(--main);
    color: #fff;
  }

  /* è©¦åˆç”»é¢ */
  #ui-match {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    overflow-y: auto;
    padding: 10px;
    backdrop-filter: blur(5px);
  }
  
  .m-container {
    max-width: 600px;
    margin: 0 auto;
  }
  
  .court {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    background: #34495e;
    padding: 8px;
    border-radius: 8px;
    border: 2px solid #fff;
    margin-bottom: 10px;
  }
  
  .pos {
    cursor: pointer;
    background: rgba(255,255,255,0.95);
    color: #2c3e50;
    padding: 8px 2px;
    text-align: center;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 2px 2px rgba(0,0,0,0.2);
  }
  
  .pos.back {
    background: rgba(236,240,241,0.9);
    color: #7f8c8d;
  }
  
  .score {
    text-align: center;
    font-size: 3.5rem;
    font-weight: 800;
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-bottom: 5px;
    color: #fff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  
  .sc-my { color: #3498db; }
  .sc-opp { color: #e74c3c; }
  
  .log {
    height: 150px;
    overflow-y: auto;
    background: rgba(0,0,0,0.6);
    border: 1px solid #555;
    padding: 8px;
    font-size: 0.85rem;
    font-family: monospace;
    margin-bottom: 10px;
    border-radius: 6px;
    color: #fff;
  }
  
  .l-row {
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding: 3px 0;
  }
  
  .cmds {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  
  .cmd {
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    color: var(--text);
    text-align: left;
    border: none;
    box-shadow: 0 3px 0 #bdc3c7;
  }
  
  .cmd:active {
    transform: translateY(2px);
    box-shadow: none;
    background: #ecf0f1;
  }
  
  .cmd b {
    display: block;
    font-size: 1rem;
    color: var(--main);
  }
  
  .cmd span {
    font-size: 0.75rem;
    color: var(--sub);
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    backdrop-filter: blur(2px);
  }
  
  .modal-content {
    background: #fff;
    width: 100%;
    max-width: 500px;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    max-height: 80vh;
    overflow-y: auto;
  }
  
  select {
    width: 100%;
    padding: 12px;
    background: #f4f6f9;
    color: var(--text);
    border: 1px solid var(--border);
    margin-top: 5px;
    border-radius: 6px;
    font-size: 1rem;
  }
  
  .court-edit {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    background: #2c3e50;
    padding: 10px;
    border-radius: 8px;
    border: 2px solid #fff;
    margin-bottom: 15px;
  }
  
  .pos-edit {
    background: rgba(255,255,255,0.95);
    padding: 5px;
    border-radius: 4px;
    text-align: center;
    font-size: 0.75rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 70px;
  }
  
  .pos-edit label {
    font-weight: bold;
    color: #7f8c8d;
    font-size: 0.7rem;
    margin-bottom: 2px;
    display: block;
  }
  
  .pos-edit select {
    width: 100%;
    font-size: 0.8rem;
    padding: 4px;
    margin-top: 0;
  }
  
  .pos-edit.back {
    background: rgba(236,240,241,0.9);
  }

  #v-prologue {
    background: #1a1a1a;
    color: #fff;
    text-align: center;
    padding: 20px;
    line-height: 2.2;
    font-family: "Yu Mincho", serif;
    display: none;
    position: fixed;
    inset: 0;
    z-index: 5000;
  }
  
  #v-prologue.active {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  
  .prologue-text {
    opacity: 0;
    animation: fadeIn 3s forwards;
    font-size: 0.95rem;
  }
  
  .p-sub {
    color: #7f8c8d;
    font-size: 0.7rem;
    margin-top: 30px;
    opacity: 0;
    animation: fadeIn 3s 2s forwards;
  }
  
  .p-title {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-top: 40px;
    opacity: 0;
    animation: fadeIn 3s 4s forwards;
    letter-spacing: 0.1em;
    text-shadow: 0 0 10px rgba(230,126,34,0.5);
  }
  
  .p-start {
    margin-top: 20px;
    font-size: 0.9rem;
    color: #fff;
    border-bottom: 1px solid #fff;
    cursor: pointer;
    opacity: 0;
    animation: fadeIn 1s 5s forwards;
  }
  
  @keyframes fadeIn {
    to { opacity: 1; }
  }
  
  .help-sec {
    margin-bottom: 12px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  
  .help-sec h4 {
    margin: 0 0 4px 0;
    color: var(--main);
    font-size: 0.95rem;
    border-left: 4px solid var(--accent);
    padding-left: 6px;
  }
  
  .help-sec p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text);
    line-height: 1.5;
  }
</style>
</head>
<body>

<div class="container">
  <button onclick="HardReset()" style="position:fixed; top:5px; right:5px; z-index:9999; font-size:10px; background:var(--lose); color:white; opacity:0.8; padding:6px 10px; border-radius:20px;">RESET DATA</button>

  <div id="v-prologue" class="view" onclick="StartGame()">
    <div class="prologue-text">
      ã•ã‚ã€è¡Œã“ã†ã€‚<br>
      ã‚ªãƒ¬ãƒ³ã‚¸ã‚³ãƒ¼ãƒˆã¯é ããªã„ã€‚<br>
      ã“ã®ä¸€è©¦åˆã€ã“ã®ä¸€æœ¬ã®å…ˆã«ã‚ã‚‹ã€‚<br><br>
      è¿·ã†ãªã€ä¸‹ã‚’å‘ããªã€ä¸Šã‚’è¦‹ã‚ã€‚<br>
      ã‚³ãƒ¼ãƒˆã«ç«‹ã¤ã®ã¯ã€<br>
      ä»Šæ—¥ã€æœ€å¾Œã¾ã§æˆ¦ã„æŠœã„ãŸä¿ºãŸã¡ã ã€‚<br>
      æ˜¥é«˜ã¸ã€è¡Œããã€‚<br>
    </div>
    <div class="p-sub">âˆ’ã“ã‚Œã¯ã€ã‚ã‚‹1äººã®ç›£ç£ã®è‹¦ã—ãã¦ã€çœ©ã—ã„ç‰©èªâˆ’</div>
    <div class="p-title">ä¿ºã®ã‚ªãƒ¬ãƒ³ã‚¸ã‚³ãƒ¼ãƒˆ</div>
    <div class="p-start">TAP TO START</div>
  </div>

  <div id="v-scout" class="view">
    <div class="header">
      <h1 style="margin:0; color:var(--text);">ğŸŒ¸ ãƒãƒ¬ãƒ¼éƒ¨ å…¥å­¦å¼</h1>
      <p style="color:var(--sub);">æ–°å…¥éƒ¨å“¡7åãŒå…¥éƒ¨ã‚’å¸Œæœ›ã—ã¦ã„ã¾ã™</p>
      <div style="font-size:0.9rem; margin:10px 0; font-weight:bold;">ç¾åœ¨ã®éƒ¨å“¡æ•°: <span id="cnt-mem">0</span>å</div>
      <button class="btn btn-m" onclick="CommitEnlist()">å…¥éƒ¨ã‚’æ‰¿èªã—ã¦é–‹å§‹</button>
    </div>
    <div id="list-scout"></div>
  </div>

  <div id="v-main" class="view">
    <div class="header">
      <button id="btn-help" onclick="ShowHelp()" style="position:absolute; top:10px; right:10px; width:30px; height:30px; border-radius:50%; background:#95a5a6; color:#fff; font-weight:bold;">?</button>
      <div id="txt-msg" style="color:var(--accent); font-weight:bold; min-height:1.2em; font-size:1.1rem; padding-right:30px;"></div>
      <div class="cal">
        <div style="grid-column:span 7; display:flex; justify-content:space-between; font-size:0.75rem; color:#95a5a6; font-weight:bold; margin-bottom:5px;">
          <span id="txt-m">4æœˆ</span> <span>IH(5/10) æ˜¥(10/13) æ–°(1/10)</span>
        </div>
        <div id="cal-days" style="display:contents;"></div>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
        <div id="txt-d" style="font-size:1.4rem; font-weight:bold; color:var(--text);"></div>
        <div style="display:flex; gap:8px;">
          <button onclick="ShowOrder()" style="padding:8px 16px; background:var(--main); border-radius:6px; color:#fff; font-size:0.9rem;">ã‚ªãƒ¼ãƒ€ãƒ¼</button>
          <button onclick="PracticeM()" style="padding:8px 16px; background:var(--accent); border-radius:6px; color:#fff; font-size:0.9rem;">ç·´ç¿’è©¦åˆ</button>
        </div>
      </div>
      <button id="btn-act" class="btn btn-g" onclick="NextDay()">3æ—¥é–“ æŒ‡å°ã‚’é€²ã‚ã‚‹</button>
    </div>
    <div id="list-team"></div>
  </div>

  <div id="ui-match">
    <div class="m-container">
      <div id="m-info" style="text-align:center; color:#fff; font-size:0.9rem; margin-bottom:10px; font-weight:bold;"></div>
      <div id="m-court" class="court"></div>
      <div style="text-align:center;color:#ccc;font-size:0.7rem;">â€»é¸æ‰‹ã‚¿ãƒƒãƒ—ã§è©³ç´°è¡¨ç¤º</div>
      <div class="score">
        <span class="sc-my" id="s-my">0</span>-
        <span class="sc-opp" id="s-opp">0</span>
      </div>
      <div id="m-state" style="text-align:center; color:#f1c40f; height:1.2em; font-size:0.9rem; font-weight:bold; margin-bottom:5px;"></div>
      <div id="m-log" class="log"></div>
      <div id="m-cmd" class="cmds"></div>
      <button id="btn-force" class="btn btn-r" style="display:none;" onclick="ForceNext()">âš  å¼·åˆ¶é€²è¡Œ</button>
      <div id="m-end" style="display:none;">
        <button id="btn-next-rd" class="btn btn-m" onclick="EndMatchUI()">æ¬¡ã®å›æˆ¦ã¸ (1é€±é–“å¾Œ)</button>
        <button class="btn btn-g" onclick="EndMatchUI()">ç·´ç¿’ã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="ui-order" class="modal">
    <div class="modal-content" style="max-width:600px;">
      <h3 style="text-align:center; color:var(--text); margin-top:0;">ã‚¹ã‚¿ãƒ¡ãƒ³ç·¨æˆ</h3>
      <div id="ord-court" class="court-edit"></div>
      <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
        <label style="color:var(--text); font-weight:bold;">ãƒªãƒ™ãƒ­ (å®ˆå‚™å°‚é–€)</label>
        <select id="sel-lib"></select>
      </div>
      <button class="btn btn-g" onclick="CloseOrder()">æ±ºå®šã—ã¦æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="ui-detail" class="modal" onclick="CloseDetail()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div id="detail-card"></div>
      <button class="btn btn-m" onclick="CloseDetail()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="ui-help" class="modal" onclick="CloseHelp()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <h3 style="text-align:center;color:var(--text);margin-top:0;border-bottom:2px solid var(--border);padding-bottom:10px;">ğŸ ç›£ç£ã®æ‰‹å¼•ã</h3>
      <div class="help-sec">
        <h4>1. è‚²æˆã¨å£</h4>
        <p><b>è©•åˆ¤(Lv)</b>ãŒé«˜ã„ã»ã©ç·´ç¿’åŠ¹ç‡UPã€‚èƒ½åŠ›90ä»¥ä¸Šã¯æˆé•·ã®å£ã‚ã‚Šã€‚çŸ¢å°(â†‘â†‘â†‘)ã®å¤šã„ç·´ç¿’ã‚’é¸ã‚“ã§ç‰¹åŒ–ã•ã›ã‚‹ã®ãŒã‚³ãƒ„ã§ã™ã€‚</p>
      </div>
      <div class="help-sec">
        <h4>2. ã‚¹ã‚­ãƒ«ã¨èª¿å­</h4>
        <p>è©¦åˆæ´»èºã§<span class="sk-tag sk-p">ç‰¹æ®Šã‚¹ã‚­ãƒ«</span>ç¿’å¾—ã‚„<span class="sk-tag sk-n">èµ¤ç‰¹</span>å…‹æœã€‚ğŸ¤¡ã¯ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã€‚</p>
      </div>
      <div class="help-sec">
        <h4>3. è©¦åˆ</h4>
        <p>ç·´ç¿’è©¦åˆã¯æœˆ1å›ã€‚å…¨å›½å¤§ä¼šã‚„å¼·è±ªæˆ¦ã¯çµŒé¨“å€¤ãƒœãƒ¼ãƒŠã‚¹å¤§ã€‚</p>
      </div>
      <button class="btn btn-g" onclick="CloseHelp()">ç†è§£ã—ãŸ</button>
    </div>
  </div>

</div>

<script>
// ==========================================
// å®šæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿å®šç¾©
// ==========================================
const POS = ['OH', 'MB', 'S', 'L'];
const STATS = [
  {id:'pow', n:'ãƒ‘ãƒ¯ãƒ¼'}, {id:'jmp', n:'ãƒãƒ'}, {id:'spd', n:'ç¬ç™º'}, 
  {id:'tec', n:'æŠ€å·§'}, {id:'iq', n:'æ€è€ƒ'}, {id:'srv', n:'ã‚µãƒ¼ãƒ–'}, 
  {id:'rec', n:'å®ˆå‚™'}, {id:'tos', n:'ãƒˆã‚¹'}
];
const MENU = [
  {id:'spike', n:'ã‚¹ãƒ‘ã‚¤ã‚¯', s:['pow','jmp','tec']}, 
  {id:'def', n:'ãƒ¬ã‚·ãƒ¼ãƒ–', s:['rec','spd','iq']}, 
  {id:'serve', n:'ã‚µãƒ¼ãƒ–', s:['srv','pow','tec']}, 
  {id:'toss', n:'ãƒˆã‚¹', s:['tos','iq','tec']}, 
  {id:'study', n:'åº§å­¦', s:['iq','tos']}, 
  {id:'block', n:'ãƒ–ãƒ­ãƒƒã‚¯', s:['jmp','pow','iq']}, 
  {id:'tact', n:'æˆ¦è¡“', s:['iq','rec']}, 
  {id:'muscle', n:'ç­‹åŠ›', s:['pow']}, 
  {id:'condi', n:'èª¿æ•´', s:['pow','jmp','spd','srv','rec','tos','tec','iq']}, 
  {id:'pos', n:'é©æ­£', s:[]}
];

// â˜…ä¿®æ­£: ç›£ç£æŒ‡å®šã®ã‚¹ã‚­ãƒ«ãƒªã‚¹ãƒˆï¼ˆåŠ¹æœå®šç¾©ã¯ãƒ­ã‚¸ãƒƒã‚¯ã§å®Ÿè£…ï¼‰
const SKILLS = [
  {id:'muscle',n:'è„³ç­‹',t:'p'}, 
  {id:'blockout',n:'ãƒ–ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã€‡',t:'p'}, 
  {id:'feint',n:'ãƒ•ã‚§ã‚¤ãƒ³ãƒˆã€‡',t:'p'}, 
  {id:'rebound',n:'ãƒªãƒã‚¦ãƒ³ãƒ‰ã€‡',t:'p'}, 
  {id:'trust',n:'åœ§å€’çš„ä¿¡é ¼',t:'p'}, 
  {id:'straight',n:'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆæ‰“ã¡',t:'p'}, 
  {id:'inner',n:'ã‚¤ãƒ³ãƒŠãƒ¼æ‰“ã¡',t:'p'}, 
  {id:'backswing',n:'å¤§ããªãƒãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã‚°',t:'p'}, 
  {id:'wrist',n:'æ‰‹é¦–æ‰“ã¡',t:'p'}, 
  {id:'turn',n:'ã‚¿ãƒ¼ãƒ³æ‰“ã¡',t:'p'}, 
  {id:'circular',n:'ã‚µãƒ¼ã‚­ãƒ¥ãƒ©ãƒ¼',t:'p'},
  {id:'yakult',n:'ãƒ¤ã‚¯ãƒ«ãƒˆã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼',t:'n'}, 
  {id:'fukashi',n:'ãƒ•ã‚«ã—ç™–',t:'n'}, 
  {id:'under',n:'ä¸‹ã«æ‰“ã¡ã™ã',t:'n'},
  {id:'commit',n:'ã‚³ãƒŸãƒƒãƒˆãƒ–ãƒ­ãƒƒã‚¯',t:'p'}, 
  {id:'step',n:'å¤§ããªä¸€æ­©',t:'p'}, 
  {id:'lead',n:'ãƒªãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯',t:'p'}, 
  {id:'laststand',n:'æœ€å¾Œã®è¸ã‚“å¼µã‚Š',t:'p'}, 
  {id:'onetouch',n:'ãƒ¯ãƒ³ã‚¿ãƒƒãƒã€‡',t:'p'}, 
  {id:'mathoa',n:'ã‚¦ã‚ªãƒ¼ãƒ«ãƒ»ãƒã‚½ã‚¢',t:'p'},
  {id:'handbad',n:'æ‰‹ã®å‡ºã—æ–¹Ã—',t:'n'}, 
  {id:'blkskip',n:'ãƒ–ãƒ­ãƒƒã‚¯ã•ã¼ã‚Šç™–',t:'n'},
  {id:'srvrec',n:'ã‚µãƒ¼ãƒ–ãƒ¬ã‚·ãƒ¼ãƒ–ã€‡',t:'p'}, 
  {id:'dig',n:'ãƒ‡ã‚£ã‚°ã€‡',t:'p'}, 
  {id:'overcut',n:'ãªã‚“ã‹ä¸ŠãŒã‚‹ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆ',t:'p'}, 
  {id:'readspk',n:'ã‚¹ãƒ‘ã‚¤ã‚¯ã‚³ãƒ¼ã‚¹èª­ã¿ã€‡',t:'p'}, 
  {id:'firststep',n:'ç´ æ—©ã„ä¸€æ­©ç›®',t:'p'}, 
  {id:'flying',n:'ãƒ•ãƒ©ã‚¤ãƒ³ã‚°ãƒ¬ã‚·ãƒ¼ãƒ–',t:'p'}, 
  {id:'pancake',n:'ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­',t:'p'}, 
  {id:'reflex',n:'å…‰ã®åå°„é€Ÿåº¦',t:'p'},
  {id:'libero',n:'å°ã•ãã¦å¤§ããªå­˜åœ¨',t:'p'}, 
  {id:'swingarm',n:'è…•ãµã‚Šãƒ¬ã‚·ãƒ¼ãƒ–',t:'n'}, 
  {id:'immobile',n:'å‹•ã‹ãªã„è„š',t:'n'}, 
  {id:'recskip',n:'ãƒ¬ã‚·ãƒ¼ãƒ–ã•ã¼ã‚Šç™–',t:'n'},
  {id:'soft',n:'ãµã‚“ã‚ã‚Šã‚¿ãƒƒãƒ',t:'p'}, 
  {id:'onehand',n:'ãƒ¯ãƒ³ãƒãƒ³ãƒ‰ãƒˆã‚¹',t:'p'}, 
  {id:'brain',n:'ãƒãƒ¼ãƒ ã®è„³',t:'p'}, 
  {id:'cover',n:'ä¸Šã«ã‚ã’ã‚Œã°ã‚«ãƒãƒ¼ã™ã‚‹',t:'p'}, 
  {id:'dump',n:'ãƒ„ãƒ¼ã€‡',t:'p'}, 
  {id:'backtoss',n:'ãƒãƒƒã‚¯ãƒˆã‚¹ã€‡',t:'p'},
  {id:'dribble',n:'ãƒ‰ãƒªãƒ–ãƒ«ç™–',t:'n'}, 
  {id:'monotone',n:'å˜èª¿ã™ãã‚‹ãƒˆã‚¹',t:'n'}, 
  {id:'longbad',n:'é•·ã‚ã®ãƒˆã‚¹Ã—',t:'n'},
  {id:'spksrv',n:'ã‚¹ãƒ‘ã‚¤ã‚¯ã‚µãƒ¼ãƒ–',t:'p'}, 
  {id:'jmpfloat',n:'ã‚¸ãƒ£ãƒ³ãƒ—ãƒ•ãƒ­ãƒ¼ã‚¿ãƒ¼ã‚µãƒ¼ãƒ–',t:'p'}, 
  {id:'float',n:'ãƒ•ãƒ­ãƒ¼ã‚¿ãƒ¼ã‚µãƒ¼ãƒ–',t:'p'}, 
  {id:'nospin',n:'ç„¡å›è»¢ã‚µãƒ¼ãƒ–',t:'p'},
  {id:'netmid',n:'ãƒãƒƒãƒˆä¸­è…¹ã‚µãƒ¼ãƒ–',t:'n'}, 
  {id:'pressbad',n:'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼Ã—',t:'n'}, 
  {id:'justin',n:'æ¥µç«¯ãªå…¥ã‚Œã‚µãƒ¼',t:'n'}
];

const S_NAMES = ["ä½è—¤","éˆ´æœ¨","é«˜æ©‹","ç”°ä¸­","ä¼Šè—¤","æ¸¡è¾º","å±±æœ¬","ä¸­æ‘","å°æ—","åŠ è—¤","å‰ç”°","å±±ç”°","å±±å£","æ¾æœ¬","äº•ä¸Š","æœ¨æ‘","æ—","æ¸…æ°´","å±±å´","æ± ç”°","é˜¿éƒ¨","æ©‹æœ¬","å±±ä¸‹","æ£®","çŸ³å·","ä¸­å³¶","å‰ç”°","è—¤ç”°","å°å·","å¾Œè—¤","æ‘ä¸Š","è¿‘è—¤","çŸ³äº•","æ–‰è—¤","å‚æœ¬","é è—¤","é’æœ¨","è—¤äº•","è¥¿æ‘","ç¦ç”°"];
const F_NAMES = ["è“®","å¤§ç¿”","æ‚ çœŸ","é™½ç¿”","æ¹Š","ä¸€æ¨¹","æ‹“æµ·","ç¿”å¤ª","å¥å¤ª","ç¿¼","é™¸","å¥å¤ª","æœé™½","è‹±å¯¿","ç¿”å¹³","å¤§å’Œ","æ¨¹","é™½å¤ª","é¢¯å¤ª","æ‚ äºº","é™¸æ–—","çµç¿”","æ˜¥é¦¬","å„ª","å‹‡æ°—","èª ","é¾äºŒ","ç¥ä»‹","å¥å¸","é›…äºº","æ™ºä¹Ÿ","å’Œä¹Ÿ","é”ä¹Ÿ","éš¼äºº","ç›´äºº","å¤§è¼","å…‰","è¼","ä¿®å¹³","æ¶¼å¤ª"];
const LOGS = {
  atk: ["ã‚¹ãƒ‘ã‚¤ã‚¯ç‚¸è£‚ï¼","ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸Šã‹ã‚‰å©ã„ãŸï¼","ã‚³ãƒ¼ã‚¹ã‚®ãƒªã‚®ãƒªï¼","è±ªå¿«ãªä¸€æ’ƒï¼","æŠ€ã‚ã‚Šãƒ•ã‚§ã‚¤ãƒ³ãƒˆï¼"], 
  quick: ["é®®ã‚„ã‹ãªé€Ÿæ”»ï¼","ç›¸æ‰‹ã‚’ç½®ãå»ã‚Šã«ã—ãŸï¼","Cã‚¯ã‚¤ãƒƒã‚¯ï¼","ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚·ãƒ§ãƒ³æŠœç¾¤ï¼"], 
  blk: ["ãƒ‰ã‚·ãƒ£ãƒƒãƒˆï¼","æ­¢ã‚ãŸï¼","å£ã¨ãªã£ãŸï¼","ãƒ¯ãƒ³ã‚¿ãƒƒãƒï¼"],
  ace: ["ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ¼ã‚¹ï¼","ãƒãƒ¼ã‚¿ãƒƒãƒï¼","ç›¸æ‰‹ã‚’å´©ã—ãŸï¼"], 
  miss: ["ç—›æ¨ã®ãƒŸã‚¹...","ã‚¢ã‚¦ãƒˆ...","ãƒãƒƒãƒˆã«ã‹ã‹ã£ãŸ..."], 
  nice_toss: ["çµ¶å¦™ãªãƒˆã‚¹ï¼","ã‚»ãƒƒã‚¿ãƒ¼ã®å®Œç’§ãªçµ„ã¿ç«‹ã¦ï¼","ãƒˆã‚¹ãƒ¯ãƒ¼ã‚¯ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŒ¯ã£ãŸï¼"], 
  blk_2: ["2æšãƒ–ãƒ­ãƒƒã‚¯ã§æ­¢ã‚ãŸï¼","MBãŒè¿½ã„ã¤ã„ãŸï¼","å£ãŒé«˜ã„ï¼"], 
  blk_late_h: ["é…ã‚ŒãŸãŒé«˜ã•ã§ã‚«ãƒãƒ¼ï¼","é•·ã„è…•ãŒæ®‹ã£ãŸï¼","è„…å¨ã®ãƒªãƒ¼ãƒï¼"], 
  blk_late: ["ãƒ–ãƒ­ãƒƒã‚¯ãŒå‰²ã‚ŒãŸ...","MBãŒé–“ã«åˆã‚ãªã„...","1æšãƒ–ãƒ­ãƒƒã‚¯..."],
  rec_nice: ["ãƒŠã‚¤ã‚¹ãƒ¬ã‚·ãƒ¼ãƒ–ï¼","ã‚ˆãä¸Šã’ãŸï¼","ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‡ã‚£ã‚°ï¼"], 
  rec_fail: ["å¼·çƒˆãªã‚¹ãƒ‘ã‚¤ã‚¯...","ãƒ¬ã‚·ãƒ¼ãƒ–å¼¾ã‹ã‚ŒãŸ...","åå¿œã§ããªã„..."], 
  rebound: ["ãƒ–ãƒ­ãƒƒã‚¯ã«å½“ã¦ã¦æ‹¾ã£ãŸï¼","ãƒªãƒã‚¦ãƒ³ãƒ‰æˆåŠŸï¼","ãƒŠã‚¤ã‚¹ãƒ•ã‚©ãƒ­ãƒ¼ï¼"], 
  toss_miss: ["ãƒˆã‚¹ãŒä¹±ã‚ŒãŸ...","ãƒ‰ãƒªãƒ–ãƒ«...","ã‚³ãƒ³ãƒ“ãŒåˆã‚ãªã„..."], 
  rec_pop: ["ãƒ¬ã‚·ãƒ¼ãƒ–ãŒå¤§ãã™ããŸ...","ãŠè¦‹åˆã„...","å¼¾ã„ã¦ã—ã¾ã£ãŸ..."], 
  pancake: ["ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­ã§æ‹¾ã£ãŸï¼","åŸ·å¿µã®ãƒ¬ã‚·ãƒ¼ãƒ–ï¼"], 
  mathoa: ["ã‚¦ã‚ªãƒ¼ãƒ«ãƒ»ãƒã‚½ã‚¢ç™ºå‹•ï¼","å£ãŒç«‹ã¡ã¯ã ã‹ã‚‹ï¼"]
};
const COND = [{n:'ğŸ˜«', v:0.8}, {n:'ğŸ˜', v:0.9}, {n:'ğŸ˜', v:1.0}, {n:'ğŸ™‚', v:1.05}, {n:'ğŸ˜', v:1.1}, {n:'ğŸ¤¡', v:0}];

function Pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function GetCondVal(p) { return p.cond === 5 ? (Math.random() < 0.5 ? 1.5 : 0.5) : COND[p.cond].v; }
function HasSkill(p, id) { return p.skills && p.skills.includes(id); }

let G = { 
  team: [], starters: [null,null,null,null,null,null], libero: null, 
  date: { m:4, d:1, y:1 }, lv: 1, 
  match: { active: false, my:0, opp:0, pow:0, name:"", round:0, isNat:false }, 
  pracMonth: 0 
};
let tempOrder = [];

window.onload = function() {
  window.onerror = function(msg) {
    const p = document.getElementById("m-cmd");
    if(p) { 
      p.innerHTML = `<div style="color:red; grid-column:span 2;">ERR: ${msg}</div>`; 
      document.getElementById("btn-force").style.display = "block"; 
    }
  };
  try {
    const save = localStorage.getItem("EIKAN_V56_0_FINAL");
    if (save) {
      const d = JSON.parse(save); 
      d.team.forEach(p => {
        if (typeof p.hNow === 'undefined') { 
          let hBase = 180 + (Math.random() - 0.5) * 20; 
          hBase = Math.max(160, Math.min(200, hBase)); 
          p.hInit = Math.floor(hBase*10)/10; 
          p.hNow = p.hInit; 
          p.gType = 1; p.gMax = 5; p.gCur = 0; 
        }
        if (!Array.isArray(p.skills)) p.skills = [];
        if (typeof p.cond === 'undefined') p.cond = 2;
        // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: å±¥æ­´ãŒãªã„å ´åˆã®åˆæœŸåŒ–
        if (!p.hist) p.hist = { score:0, atk:0 };
      });
      G = {...G, ...d};
      if(d.sIds) G.starters = d.sIds.map(id => G.team.find(p=>p.id===id)||null);
      if(d.lId) G.libero = G.team.find(p=>p.id===d.lId)||null;
      G.match.active = false; ChangeView('v-main'); UpdateUI();
    } else { InitGame(); }
  } catch(e) { InitGame(); }
};

function HardReset() { 
  if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) { 
    localStorage.removeItem("EIKAN_V56_0_FINAL"); 
    location.reload(); 
  } 
}

function InitGame() { 
  G.team = []; 
  G.date = { m:4, d:1, y:1 }; 
  G.lv = 1; 
  G.pracMonth = 0; 
  for(let i=0; i<3; i++) G.team.push(MakePlayer(2)); 
  for(let i=0; i<3; i++) G.team.push(MakePlayer(3)); 
  ChangeView('v-prologue'); 
  RenderScout(); 
}

function StartGame() { ChangeView('v-scout'); }

function ChangeView(id) { 
  document.querySelectorAll('.view').forEach(e => e.classList.remove('active')); 
  document.getElementById(id).classList.add('active'); 
  if(id!=='v-prologue') document.getElementById('v-prologue').classList.remove('active'); 
}

function GetRank(v) { 
  if(v>=100) return 'SS'; if(v>=90) return 'S'; if(v>=80) return 'A'; 
  if(v>=70) return 'B'; if(v>=60) return 'C'; if(v>=50) return 'D'; 
  if(v>=40) return 'E'; if(v>=20) return 'F'; return 'G'; 
}

function MakePlayer(grade) {
  const lvBonus = Math.min(15, Math.floor(G.lv / 5));
  const isTalent = Math.random() < 0.05;
  const bonus = isTalent ? 20 : 0;
  const pers = isTalent ? {n:"æ‰èƒ½ã®å¡Š", m:1.52} : [{n:"ç†±è¡€",m:1.18},{n:"å†·é™",m:1.18},{n:"æ™®é€š",m:1.06},{n:"é™°æ°—",m:0.92}][Math.floor(Math.random()*4)];
  const stats = {};
  const base = 15 + (grade-1)*5 + lvBonus; 
  STATS.forEach(s => { stats[s.id] = Math.min(100, Math.max(10, Math.floor(base + Math.random()*12 + bonus))); });
  const pos = POS[Math.floor(Math.random()*4)]; 
  const apt = {OH:0, MB:0, S:0, L:0}; apt[pos] = 100;
  let hBase = 180 + (Math.random() + Math.random() + Math.random() - 1.5) * 20; 
  hBase = Math.max(160, Math.min(200, hBase));
  const hInit = Math.floor(hBase * 10) / 10; 
  const hNow = hInit;
  // â˜…ä¿®æ­£: 5%ã®ç¢ºç‡ã§ã‚¹ã‚­ãƒ«ä»˜ä¸
  const skills = []; SKILLS.forEach(sk => { if(Math.random() < 0.05) skills.push(sk.id); });
  const gType = 1; let gMax = 5; if(Math.random()<0.02) {gMax=10;}
  
  return { 
    id: "p"+Date.now()+Math.random(), 
    name: S_NAMES[Math.floor(Math.random()*S_NAMES.length)] + " " + F_NAMES[Math.floor(Math.random()*F_NAMES.length)], 
    grade: grade, pos: pos, stats: stats, apt: apt, pers: pers, menu: null, 
    hist: { score:0, atk:0 }, 
    hInit: hInit, hNow: hNow, gType: gType, gMax: gMax, gCur: 0, cond: 2, skills: skills 
  };
}

function RenderScout() { 
  const el = document.getElementById('list-scout'); el.innerHTML = ""; 
  document.getElementById('cnt-mem').innerText = G.team.length; 
  window.tmpScouts = []; 
  for(let i=0; i<7; i++) window.tmpScouts.push(MakePlayer(1)); 
  window.tmpScouts.forEach(p => RenderCard(p, el, true)); 
}

function CommitEnlist() { 
  window.tmpScouts.forEach(p => p.menu = 'spike'); 
  G.team = G.team.concat(window.tmpScouts); 
  window.tmpScouts = null; 
  AutoOrder(); ChangeView('v-main'); UpdateUI(); Save(); 
}

function AutoOrder() { 
  const list = [...G.team].sort((a,b) => Object.values(b.stats).reduce((s,v)=>s+v,0) - Object.values(a.stats).reduce((s,v)=>s+v,0)); 
  let l = list.find(p=>p.pos==='L') || list[list.length-1]; 
  G.libero = l; 
  const others = list.filter(p=>p.id!==l.id); 
  let s = others.find(p=>p.pos==='S') || others[0]; 
  const atks = others.filter(p=>p.id!==s.id); 
  G.starters = [atks[0]||null, atks[1]||null, atks[2]||null, s||null, atks[3]||null, atks[4]||null]; 
}

// â˜…ä¿®æ­£: æˆ¦ç¸¾è¡¨ç¤ºã®è¿½åŠ 
function RenderCard(p, parent, simple=false) {
  const div = document.createElement('div'); 
  div.className = 'card'; 
  div.setAttribute('data-pos', p.pos);
  const isS = G.starters.some(s => s && s.id === p.id); 
  const isL = G.libero && G.libero.id === p.id;
  const badge = isS ? `<span class="badge st">ã‚¹ã‚¿ãƒ¡ãƒ³</span>` : (isL ? `<span class="badge li">L</span>` : "");
  const total = Math.floor(Object.values(p.stats).reduce((a,b)=>a+b,0));
  const m = MENU.find(x=>x.id===p.menu);
  const hNowVal = (p.hNow || 170); 
  const hInitVal = (p.hInit || 170); 
  const grown = (hNowVal - hInitVal).toFixed(1);
  // å¾—ç‚¹ã¨æ±ºå®šç‡ã®è¨ˆç®—
  const score = p.hist && p.hist.score ? p.hist.score : 0;
  const atkCnt = p.hist && p.hist.atk ? p.hist.atk : 0;
  const rate = atkCnt > 0 ? Math.floor((score / atkCnt) * 100) : 0;

  let html = `
    <div class="c-head">
      <div class="c-name">${p.name} <span style="font-size:0.8em; font-weight:normal;">(${p.pos})</span> ${COND[p.cond].n}</div>
      <div class="c-ovr">â˜…${total}</div>
    </div>
    <div class="c-meta">
      <span>${p.grade}å¹´</span>
      <span>${p.pers.n}</span>
      <span>${hNowVal.toFixed(1)}cm <small style="color:#aaa;">(+${grown})</small></span>
      <span style="color:var(--main);font-weight:bold;margin-left:4px;">${score}ç‚¹ ${rate}%</span>
      ${badge}
    </div>
    <div class="stats">
      ${STATS.map(s => { 
        const v = Math.floor(p.stats[s.id]); 
        let arr = ""; 
        if(!simple && m && m.s.includes(s.id)) { 
          if(m.s.length===1) arr = ` <span class="up-3">â†‘â†‘â†‘</span>`; 
          else if(m.s.length<=3) arr = ` <span class="up-2">â†‘â†‘</span>`; 
          else arr = ` <span class="up-1">â†‘</span>`; 
        } 
        return `<div class="s-row"><span>${s.n}${arr}</span><span><span class="rnk r-${GetRank(v)}">${GetRank(v)}</span>${v}</span></div>`; 
      }).join('')}
    </div>
    <div class="c-skills">
      ${(p.skills||[]).map(sid => { 
        const sk = SKILLS.find(k=>k.id===sid); 
        return sk ? `<span class="sk-tag sk-${sk.t}">${sk.n}</span>` : ''; 
      }).join('')}
    </div>
  `;
  if(!simple) { 
    html += `
      <div class="c-btm">
        ${MENU.map(mn => `<div onclick="SetM('${p.id}','${mn.id}')" class="c-menu-btn ${p.menu===mn.id?'active':''}">${mn.n}</div>`).join('')}
      </div>
      <div class="c-btm" style="grid-template-columns:repeat(4,1fr);">
        ${POS.map(po => `<div onclick="SetP('${p.id}','${po}')" class="c-pos-btn ${p.pos===po?'active':''}">${po}</div>`).join('')}
      </div>
    `; 
  }
  div.innerHTML = html; parent.appendChild(div);
}

function SetM(id, m) { G.team.find(p=>p.id===id).menu = m; UpdateUI(); Save(); }
function SetP(id, po) { G.team.find(p=>p.id===id).pos = po; UpdateUI(); Save(); }

function UpdateUI() { 
  document.getElementById('txt-d').innerText = `${G.date.y}å¹´ ${G.date.m}æœˆ ${G.date.d}æ—¥`; 
  document.getElementById('txt-msg').innerText = `è©•åˆ¤Lv:${G.lv} - ` + (G.match.next ? `æ¬¡æˆ¦:${G.match.next.m}/${G.match.next.d}` : "ç·´ç¿’æœŸé–“"); 
  document.getElementById('txt-m').innerText = G.date.m + 'æœˆ'; 
  const cal = document.getElementById('cal-days'); cal.innerHTML = ""; 
  for(let i=1; i<=30; i++) { 
    const d = document.createElement('div'); 
    d.className = "day" + (i===G.date.d ? " today" : "") + (G.match.next && G.match.next.m===G.date.m && G.match.next.d===i ? " match" : ""); 
    let mk = ""; 
    if(G.date.m===5&&i===10) mk="IH"; 
    if(G.date.m===10&&i===13) mk="æ˜¥"; 
    if(G.date.m===1&&i===10) mk="æ–°"; 
    d.innerHTML = i + (mk?`<div class="mark">${mk}</div>`:""); 
    cal.appendChild(d); 
  } 
  const btn = document.getElementById('btn-act'); 
  if(G.match.played) { 
    btn.innerText = "è©¦åˆçµ‚äº† (ç¿Œæ—¥ã¸)"; btn.className = "btn btn-m"; 
  } else if(IsMatchDay()) { 
    btn.innerText = "è©¦åˆä¼šå ´ã¸ç§»å‹• (é–‹å§‹)"; btn.className = "btn btn-r"; 
  } else { 
    const days = GetDaysToNext(); 
    btn.innerText = (days>0 && days<=3) ? `æ±ºæˆ¦ã¾ã§ã‚ã¨${days}æ—¥ (èª¿æ•´)` : "3æ—¥é–“ æŒ‡å°ã‚’é€²ã‚ã‚‹"; 
    btn.className = (days>0 && days<=3) ? "btn btn-m" : "btn btn-g"; 
  } 
  const list = document.getElementById('list-team'); 
  list.innerHTML = ""; 
  [...G.team].sort((a,b)=>b.grade - a.grade).forEach(p => RenderCard(p, list)); 
}

function GetGrowthMod(currentVal) { 
  if (currentVal < 50) return 1.0; 
  if (currentVal < 70) return 0.7; 
  if (currentVal < 85) return 0.4; 
  if (currentVal < 95) return 0.15; 
  return 0.05; 
}

function GetEv(m, d) { 
  if(m===5 && d===10) return "IHäºˆé¸"; 
  if(m===10 && d===13) return "æ˜¥é«˜äºˆé¸"; 
  if(m===1 && d===10) return "æ–°äººæˆ¦"; 
  return null; 
}

function IsMatchDay() { 
  if(G.match.played) return false; 
  const ev = GetEv(G.date.m, G.date.d); 
  if(ev) return !(ev==="æ–°äººæˆ¦" && G.match.winSpr); 
  const n = G.match.next; 
  return (n && n.m===G.date.m && n.d===G.date.d); 
}

function GetDaysToNext() { 
  const n = G.match.next; 
  if(n && n.m===G.date.m) return n.d - G.date.d; 
  if(G.date.m===5 && G.date.d<10) return 10 - G.date.d; 
  if(G.date.m===10 && G.date.d<13) return 13 - G.date.d; 
  if(G.date.m===1 && G.date.d<10 && !G.match.winSpr) return 10 - G.date.d; 
  return 99; 
}

function NextDay() {
  if(IsMatchDay()) { 
    const ev = GetEv(G.date.m, G.date.d); 
    if(ev) StartMatch(ev, 1, false); 
    else if(G.match.next) StartMatch(G.match.next.name, G.match.next.round, G.match.next.isNat); 
    return; 
  }
  
  G.team.forEach(p => {
    if(Math.random() < 0.3) { 
      if(Math.random() < 0.5 && p.cond < 4) p.cond++; 
      else if(p.cond > 0) p.cond--; 
    }
    if(Math.random() < 0.01) p.cond = 5; 

    const m = MENU.find(x=>x.id===p.menu)||MENU[0]; 
    const efficiency = 0.6 + (G.lv * 0.008);
    let baseGain = 0.45; 
    if(m.s.length===1) baseGain=1.0; 
    if(m.s.length===2) baseGain=0.6; 
    if(m.s.length>=7) baseGain=0.15;
    
    STATS.forEach(s => { 
      let g = 0.05; 
      if(m.s.includes(s.id)) g = baseGain; 
      g *= p.pers.m * efficiency * GetGrowthMod(p.stats[s.id]); 
      p.stats[s.id] = Math.min(100, p.stats[s.id]+g); 
    });
    
    p.apt[p.pos] = Math.min(100, p.apt[p.pos]+(p.menu==='pos'?12:0.3));
    
    if(p.gCur < p.gMax && Math.random()<0.4) { 
      let grow = Math.random()*0.2; 
      if(p.gCur+grow>p.gMax) grow=p.gMax-p.gCur; 
      p.gCur+=grow; 
      if(!p.hNow) p.hNow=170; 
      p.hNow+=grow; 
    }
  });
  
  let add = 3; 
  const days = GetDaysToNext(); 
  if(days>0 && days<=3) add = days; 
  
  G.date.d += add; G.match.played = false;
  if(G.date.d > 30) { G.date.d=1; G.date.m++; }
  if(G.date.m > 12) { 
    G.date.m=1; G.date.y++; 
    G.match.winSpr = false; 
    G.match.next = null; 
    G.pracMonth=0; 
    G.team.forEach(p=>p.grade++); 
    G.team = G.team.filter(p=>p.grade<=3); 
    for(let i=0;i<6;i++) if(G.starters[i]&&G.starters[i].grade>3) G.starters[i]=null; 
    if(G.libero&&G.libero.grade>3) G.libero=null; 
  }
  
  if(G.date.m===4 && G.date.d===1) { ChangeView('v-scout'); RenderScout(); } 
  else { UpdateUI(); } 
  Save();
}

function PracticeM() { 
  if(G.match.played) return alert("è©¦åˆçµ‚äº†æ¸ˆã¿ã§ã™"); 
  if(G.pracMonth === G.date.m) return alert("ç·´ç¿’è©¦åˆã¯æœˆ1å›ã¾ã§ã§ã™"); 
  if(confirm("ç·´ç¿’è©¦åˆã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ")) { 
    G.pracMonth = G.date.m; 
    StartMatch("ç·´ç¿’è©¦åˆ", 1, false); 
  } 
}

function StartMatch(name, round, isNat) {
  if(!G.starters.every(s=>s)) { 
    AutoOrder(); 
    if(!G.starters.every(s=>s)) return alert("ã‚¹ã‚¿ãƒ¡ãƒ³ä¸è¶³ã§ã™ã€‚"); 
  }
  G.match.active = true; G.match.name = name; G.match.round = round; G.match.isNat = isNat; 
  G.match.my=0; G.match.opp=0; G.match.court=[...G.starters]; G.match.mbBench=null; G.match.srv=Math.random()<0.5;
  const totalStats = G.starters.reduce((a,b)=>a+(Object.values(b.stats).reduce((x,y)=>x+y,0)/8),0)/6;
  let floor = 20; let mod = -10+Math.random()*20; 
  if(name!=="ç·´ç¿’è©¦åˆ") { 
    if(round>=3 && !isNat) floor = 45 + round*5; 
    else if(!isNat) floor = 25+round*5; 
    if(isNat) floor = 75 + round*5; 
    mod = (round-1)*10 - 5 + (isNat?40:0); 
  }
  G.match.pow = Math.max(floor, totalStats + mod + (Math.random()*6-3));
  document.getElementById('ui-match').style.display = 'block'; 
  document.getElementById('m-info').innerText = `${name} ${isNat?'å…¨å›½':''} ${round}å›æˆ¦ (æ•µ:${Math.floor(G.match.pow)})`;
  document.getElementById('m-log').innerHTML = ""; 
  document.getElementById('m-end').style.display='none'; 
  document.getElementById('btn-next-rd').style.display='none'; 
  document.getElementById('btn-force').style.display='none';
  CheckLibero(); DrawMatch(); NextCmd();
}

function CheckLibero() { 
  if(!G.libero) return; 
  const c = G.match.court; 
  let lid = c.findIndex(p=>p.id===G.libero.id); 
  if(lid>=0 && lid<3) { 
    if(G.match.mbBench) { c[lid]=G.match.mbBench; G.match.mbBench=null; } 
  } 
  lid = c.findIndex(p=>p.id===G.libero.id); 
  if(lid===-1) { 
    for(let i=3; i<6; i++) { 
      if(c[i].pos==='MB' && c[i].id!==G.libero.id) { 
        G.match.mbBench=c[i]; c[i]=G.libero; break; 
      } 
    } 
  } 
}

function Rotate() { 
  const c = G.match.court; 
  c.unshift(c.pop()); 
  const tmp=c[0]; c[0]=c[1]; c[1]=tmp; 
  CheckLibero(); 
}

function DrawMatch() { 
  document.getElementById('s-my').innerText = G.match.my; 
  document.getElementById('s-opp').innerText = G.match.opp; 
  const el = document.getElementById('m-court'); 
  el.innerHTML = ""; 
  [0,1,2].forEach(i=>{
    const p=G.match.court[i]; 
    el.innerHTML+=`<div class="pos" onclick="ShowDetail('${p.id}')">${p.name.split(' ')[0]}<br>${p.pos}</div>`;
  }); 
  [5,4,3].forEach(i=>{
    const p=G.match.court[i]; 
    el.innerHTML+=`<div class="pos back" onclick="ShowDetail('${p.id}')">${p.name.split(' ')[0]}<br>${p.pos}</div>`;
  }); 
}

function ShowDetail(pid) { 
  const p = G.team.find(x => x.id === pid); 
  if(!p) return; 
  const box = document.getElementById('detail-card'); 
  box.innerHTML = ""; 
  RenderCard(p, box, true); 
  document.getElementById('ui-detail').style.display = 'flex'; 
}
function CloseDetail() { document.getElementById('ui-detail').style.display = 'none'; }
function ShowHelp() { document.getElementById('ui-help').style.display = 'flex'; }
function CloseHelp() { document.getElementById('ui-help').style.display = 'none'; }

// ç¬¬16æ¡: ã‚¹ã‚­ãƒ«åŠ¹æœã®å³æ ¼ãªå®Ÿè£…
function NextCmd() {
  const box = document.getElementById('m-cmd'); box.innerHTML = ""; document.getElementById('m-state').innerText = "Command Phase";
  const c = G.match.court; let s = [c[3],c[4],c[5],c[0],c[1],c[2]].find(p=>p && p.pos==='S') || c[1];
  [0,1,2].forEach(i => {
    const p = c[i]; if(!p) return;
    let type='spike', lbl='æ”»æ’ƒ'; if(p.pos==='MB') {type='quick'; lbl='ã‚¯ã‚¤ãƒƒã‚¯';} else if(p.id===s.id) {if(Math.random()>0.3)return; type='quick'; lbl='ãƒ„ãƒ¼';} else if(i===1) {type='quick'; lbl='æ™‚é–“å·®';} else if(i===2) {type='spike'; lbl='ãƒ©ã‚¤ãƒˆ';} else {type='spike'; lbl='ãƒ¬ãƒ•ãƒˆ';}
    const apt = (p.apt[p.pos]||0)/100; const condMod = GetCondVal(p); const rate = (0.6 + (0.4 * apt)) * condMod; const hBonus = ((p.hNow||170) - 170) * 0.5;
    
    // ã‚»ãƒƒã‚¿ãƒ¼è£œæ­£
    let sTos = s.stats.tos * GetCondVal(s);
    if(HasSkill(s,'brain')) { sTos += 10; }
    if(HasSkill(s,'monotone')) { sTos -= 10; }
    if(HasSkill(s,'longbad') && (type==='spike')) { sTos -= 8; }

    let pow = p.stats.pow, tec = p.stats.tec, jmp = p.stats.jmp, spd = p.stats.spd;
    
    // æ”»æ’ƒã‚¹ã‚­ãƒ«
    if(HasSkill(p,'muscle')) { pow+=10; }
    if(HasSkill(p,'straight')) { tec+=5; pow+=5; }
    if(HasSkill(p,'inner')) { tec+=10; }
    if(HasSkill(p,'backswing')) { jmp+=10; }
    if(HasSkill(p,'wrist')) { pow-=5; tec+=10; jmp+=10; }
    if(HasSkill(p,'turn')) { jmp+=5; tec+=8; }
    if(HasSkill(p,'circular')) { pow+=10; }
    if(HasSkill(p,'yakult')) { jmp-=20; }
    if(HasSkill(p,'fukashi')) { pow+=5; }
    if(HasSkill(p,'trust') && G.match.my < G.match.opp) { 
      pow+=10; tec+=10; jmp+=10; spd+=10; 
    }
    if(HasSkill(p,'dump') && lbl==='ãƒ„ãƒ¼') { pow+=7; tec+=7; }
    if(HasSkill(p,'feint')) { tec+=8; }

    const basePower = ((pow+tec+jmp+spd)/4)*condMod;
    let enemyDef = G.match.pow * 0.9;
    
    // æ•µé˜²å¾¡ãƒ‡ãƒãƒ•
    if(HasSkill(p,'blockout')) { enemyDef *= 0.9; }
    if(HasSkill(p,'circular')) { enemyDef -= 10; }
    
    let est = Math.floor(Math.min(99, Math.max(5, (20 + (basePower*1.2+hBonus)*(sTos/100)*0.8 - (enemyDef * 0.5)) * rate)));
    if(HasSkill(p,'feint')) { est += 8; }
    if(G.match.last===p.id) { est-=15; }
    
    const btn = document.createElement('button'); 
    btn.className = "cmd"; 
    btn.innerHTML = `<b>${lbl}: ${p.name.split(' ')[0]}</b><span>ç¢ºç‡${est}%</span>`; 
    btn.onclick = () => Action(p.id, est); 
    box.appendChild(btn);
  });
  
  const ba = c[5];
  if(ba && ba.pos==='OH' && ba.id!==s.id) {
    let est = 30 * GetCondVal(ba);
    if(HasSkill(ba,'backtoss') && (ba.pos==='OP'||c[2].id===s.id)) { est+=10; }
    if(G.match.last===ba.id) { est-=15; }
    
    const btn = document.createElement('button'); 
    btn.className = "cmd"; 
    btn.innerHTML = `<b>ãƒãƒƒã‚¯: ${ba.name.split(' ')[0]}</b><span>ç¢ºç‡${Math.floor(est)}%</span>`; 
    btn.onclick = () => Action(ba.id, Math.max(5, Math.floor(est))); 
    box.appendChild(btn);
  }
}

function ForceNext() { AutoAction(); }

function Action(id, est) {
  document.getElementById('m-cmd').innerHTML = ""; 
  document.getElementById('m-state').innerText = "Rally..."; 
  G.match.last = id;
  
  const srv = G.match.court[3];
  let srvS = srv.stats.srv, srvP = srv.stats.pow, srvT = srv.stats.tec;
  
  // ã‚µãƒ¼ãƒ–ã‚¹ã‚­ãƒ«è£œæ­£
  if(HasSkill(srv,'spksrv')) { srvS+=10; srvP+=10; srvT+=10; }
  if(HasSkill(srv,'jmpfloat')) { srvS+=5; srvP+=5; srvT+=5; }
  if(HasSkill(srv,'float')) { srvS+=5; }
  if(HasSkill(srv,'nospin')) { srvP+=5; }
  if(HasSkill(srv,'pressbad')) { srvS-=10; srvP-=10; srvT-=10; }
  if(HasSkill(srv,'justin')) { srvP=0; }

  let srvChance = ((srvS*0.7+srvP*0.15+srvT*0.15)*GetCondVal(srv)/100*0.05);
  if(HasSkill(srv,'spksrv')) { srvChance += 0.02; }
  if(HasSkill(srv,'netmid')) { srvChance -= 0.05; }
  
  // ã‚µãƒ¼ãƒ–ãƒŸã‚¹åˆ¤å®š
  let srvMiss = 0.05;
  if(HasSkill(srv,'spksrv')) { srvMiss += 0.10; }
  if(HasSkill(srv,'netmid')) { srvMiss += 0.10; }
  if(HasSkill(srv,'justin')) { srvMiss = 0; }

  if(Math.random() < srvMiss) {
     Log(`${srv.name}: ${Pick(LOGS.miss)} (ã‚µãƒ¼ãƒ–ãƒŸã‚¹)`, "var(--lose)"); 
     Score(false,true); 
     return;
  }

  if(Math.random() < srvChance) { 
    Log(`${srv.name}: ${Pick(LOGS.ace)}`, "gold"); 
    srv.hist.score++; 
    Score(true,true); 
    return; 
  }
  
  const s = [G.match.court[3],G.match.court[4],G.match.court[5],G.match.court[0],G.match.court[1],G.match.court[2]].find(p=>p.pos==='S') || G.match.court[1];
  if(s) {
    let sMiss = 0.15 - ((s.stats.tec+s.stats.tos)*GetCondVal(s)/2000);
    if(HasSkill(s,'soft')) { s.stats.tos+=8; sMiss -= 0.05; }
    if(HasSkill(s,'dribble')) { sMiss += 0.05; }
    
    if(Math.random() < Math.max(0.01, sMiss)) { 
      Log(`${s.name.split(' ')[0]}: ${Pick(LOGS.toss_miss)}`, "var(--lose)"); 
      Score(false,true); 
      return; 
    }
  }
  
  const p = G.match.court.find(x=>x.id===id);
  if(p) {
    let missRate = 0.20-((p.stats.tec+p.stats.iq)*GetCondVal(p)*0.0008)-(p.pers.n==='å†·é™'?0.01:0);
    if(HasSkill(p,'fukashi')) { missRate += 0.1; }
    if(HasSkill(p,'under')) { missRate += 0.05; }
    
    if(Math.random() < Math.max(0.02, missRate)) { 
      Log(`${p.name}: ${Pick(LOGS.miss)}`, "var(--lose)"); 
      Score(false,true); 
      return; 
    }
  }
  
  if(Math.random()*100 < est) {
    if(s && HasSkill(s,'onehand') && Math.random()<0.05) { G.match.pow -= 5; }
    const type = p && p.pos==='MB' ? 'quick' : 'atk';
    Log(`${p?p.name:"å‘³æ–¹"}: ${Pick(LOGS[type])}`, "var(--main)");
    if(p){ p.hist.score++; p.hist.atk++; }
    Score(true,true);
  } else {
    let rebC = p ? ((p.stats.tec+p.stats.iq)*GetCondVal(p))/200 : 0.3;
    if(p && HasSkill(p,'rebound')) { rebC += 0.1; }
    
    if(Math.random() < rebC) {
      Log(Pick(LOGS.rebound), "var(--ok)"); 
      setTimeout(NextCmd,800); 
      return; 
    }
    Log(`ç›¸æ‰‹: ${Pick(LOGS.blk)}`, "var(--lose)"); 
    if(p) { p.hist.atk++; }
    Score(false,true);
  }
}

function AutoAction() {
  document.getElementById('m-cmd').innerHTML = "";
  const zone = Math.floor(Math.random() * 3); 
  let enP = G.match.pow * (0.9 + Math.random()*0.3);
  const blk = G.match.court[zone]; 
  const mb = G.match.court[1]; 
  const bM = GetCondVal(blk); 
  const mbM = GetCondVal(mb);
  
  let bJ=blk.stats.jmp, bP=blk.stats.pow, bI=blk.stats.iq, bSp=blk.stats.spd;
  // ãƒ–ãƒ­ãƒƒã‚¯ç³»ã‚¹ã‚­ãƒ«
  if(HasSkill(blk,'commit')) { bI+=10; }
  if(HasSkill(blk,'step')) { bSp+=10; }
  if(HasSkill(blk,'lead')) { bSp+=10; }
  if(HasSkill(blk,'laststand')) { bJ+=5;bP+=5;bI+=5;bSp+=5; }
  if(HasSkill(blk,'handbad')) { bJ-=5;bP-=5;bI-=5;bSp-=5; }
  if(HasSkill(blk,'mathoa')) { enP *= 0.9; }

  let mbJ=mb.stats.jmp, mbP=mb.stats.pow, mbI=mb.stats.iq, mbSp=mb.stats.spd;
  if(HasSkill(mb,'step')) { mbSp+=10; }

  let blkS = 0; let is2 = false;
  if(zone !== 1) {
    if(HasSkill(mb,'blkskip') && Math.random()<0.1) { 
      // ã‚µãƒœã‚Š
    } else if(Math.random() < ((mbSp+mbI)*mbM)/200) {
      is2 = true; 
      blkS = (bJ*bM + bP*bM + bI*bM) + (mbJ*mbM + mbP*mbM + mbI*mbM); 
      blkS /= 1.5;
    } else {
      if((mb.hNow||170)+(mbJ*mbM) > 220+(Math.random()*20)) {
        blkS = (bJ*bM + bP*bM + bI*bM) + ((mbJ+mbP)*mbM*0.7); 
        blkS /= 1.5; 
        Log(Pick(LOGS.blk_late_h), "var(--sub)");
      } else {
        Log(Pick(LOGS.blk_late), "var(--sub)"); 
        blkS = (bJ*bM + bP*bM + bI*bM);
      }
    }
  } else { 
    blkS = (mbJ*mbM + mbP*mbM + mbI*mbM); 
  }
  
  blkS += ((blk.hNow||170) - 175) * 2;
  if(Math.random() < 0.1) { blkS *= 0.9; }
  
  if(blkS > enP * 2.0) {
    Log(HasSkill(blk,'mathoa')?LOGS.mathoa[0]:(is2?Pick(LOGS.blk_2):Pick(LOGS.blk)), "var(--ok)"); 
    Score(true,false); 
    return;
  }
  
  if(HasSkill(blk,'onetouch') || HasSkill(mb,'onetouch')) { 
    if(blkS > enP*0.8) { enP*=0.5; } 
  } else if(blkS > enP) { 
    enP *= 0.5; 
  } else { 
    enP -= (blkS * 0.2); 
  }
  
  if(enP<5) { enP=5; }

  let pool=[]; [3,4,5].forEach(i=>{pool.push(i); if(G.match.court[i].pos==='L'){pool.push(i);pool.push(i);pool.push(i);}});
  const rec = G.match.court[pool[Math.floor(Math.random()*pool.length)]];
  const rM = GetCondVal(rec);
  
  let rR=rec.stats.rec, rS=rec.stats.spd, rI=rec.stats.iq;
  // ãƒ¬ã‚·ãƒ¼ãƒ–ç³»ã‚¹ã‚­ãƒ«
  if(HasSkill(rec,'dig')) { rR+=5; rS+=5; rI+=5; }
  if(HasSkill(rec,'readspk')) { rR+=10; }
  if(HasSkill(rec,'firststep')) { rS+=5; }
  if(HasSkill(rec,'flying')) { rS+=3;rR+=3; }
  if(HasSkill(rec,'reflex')) { rS+=10; }
  if(HasSkill(rec,'libero') && rec.pos==='L') { rR+=5;rS+=5;rI+=5; }
  if(HasSkill(rec,'swingarm')) { rR-=5;rS-=5;rI-=5; }
  if(HasSkill(rec,'immobile')) { rS-=10; }
  if(HasSkill(rec,'overcut')) { rR+=10; }

  const recS = (rR+rS+rI)*rM;
  if(HasSkill(rec,'recskip') && Math.random()<0.05) { 
    Log(`${rec.name.split(' ')[0]}: ã•ã¼ã£ãŸ...`, "var(--lose)"); 
    Score(false,false); 
    return; 
  }
  
  const s = [G.match.court[3],G.match.court[4],G.match.court[5],G.match.court[0],G.match.court[1],G.match.court[2]].find(p=>p.pos==='S') || G.match.court[1];
  if(HasSkill(s,'cover')) { enP -= 5; }

  if(Math.random() < Math.max(0.1, Math.min(0.95, 0.4+(recS-enP)*0.01))) {
    Log(`${rec.name.split(' ')[0]}: ${Pick(LOGS.rec_nice)}`, "var(--ok)"); 
    Score(true,false);
  } else {
    if(HasSkill(rec,'pancake') && Math.random()<0.05) { 
      Log(`${rec.name.split(' ')[0]}: ${LOGS.pancake[0]}`, "var(--ok)"); 
      Score(true,false); return; 
    }
    if(HasSkill(rec,'overcut') && Math.random()<0.05) { 
      Log(`${rec.name.split(' ')[0]}: è¬ã‚ªãƒ¼ãƒãƒ¼ã‚«ãƒƒãƒˆï¼`, "var(--ok)"); 
      Score(true,false); return; 
    }
    Log(`${rec.name.split(' ')[0]}: ${rec.stats.rec<30?Pick(LOGS.rec_pop):Pick(LOGS.rec_fail)}`, "var(--lose)"); 
    Score(false,false);
  }
}

// ç¬¬18æ¡: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ­ã‚°
function FinishMatch() { 
  const win = G.match.my > G.match.opp; 
  Log(`è©¦åˆçµ‚äº† ${G.match.my}-${G.match.opp}`, win?"gold":"#ccc"); 
  G.match.played = true; 
  const myP = G.starters.reduce((a,b)=>a+(Object.values(b.stats).reduce((x,y)=>x+y,0)/8),0)/6; 
  if(win) { if(G.lv<100) G.lv++; } else { if(G.match.pow<myP-10) {G.lv=Math.max(1,G.lv-3); Log("æ ¼ä¸‹ã«æ•—åŒ—...","var(--lose)");} else if(G.match.pow<=myP+10) {G.lv=Math.max(1,G.lv-1);} } 
  let sB = 1.0; 
  if(G.match.name!=="ç·´ç¿’è©¦åˆ") sB = G.match.isNat ? 1.5 : 1.2; 
  const eB = G.match.pow / 50; 
  
  G.team.forEach(p => { 
    // ã‚¹ã‚­ãƒ«ç¿’å¾— (10%)
    if(G.starters.some(s=>s.id===p.id) && Math.random() < 0.1) { 
      let perf = 0; 
      if(p.pos==='OH'||p.pos==='MB') perf = p.hist.score*10 - (p.hist.atk - p.hist.score)*2; 
      else if(p.pos==='S') perf = G.match.my - (HasSkill(p,'dribble')?20:0); 
      else if(p.pos==='L') perf = (25 - G.match.opp)*2; 
      
      const isBad = !win && perf < 10; 
      const isGood = win || perf > 30; 

      if(isGood) { 
        const neg = (p.skills||[]).find(sid => SKILLS.find(k=>k.id===sid).t === 'n'); 
        if(neg) { 
          p.skills = p.skills.filter(s => s !== neg); 
          Log(`${p.name}ãŒå¼±ç‚¹ã‚’å…‹æœï¼`, "cyan"); 
        } else { 
          const cand = SKILLS.filter(k=>k.t==='p' && !(p.skills||[]).includes(k.id)); 
          if(cand.length>0) { 
            const newSk = Pick(cand); 
            if(!p.skills) p.skills=[]; 
            p.skills.push(newSk.id); 
            Log(`${p.name}ãŒã€Œ${newSk.n}ã€ã«è¦šé†’ï¼`, "cyan"); 
          } 
        } 
      } else if(isBad) { 
        const cand = SKILLS.filter(k=>k.t==='n' && !(p.skills||[]).includes(k.id)); 
        if(cand.length>0 && Math.random()<0.3) { 
          const newSk = Pick(cand); 
          if(!p.skills) p.skills=[]; 
          p.skills.push(newSk.id); 
          Log(`${p.name}ãŒã€Œ${newSk.n}ã€ã«ãªã£ã¦ã—ã¾ã£ãŸ...`, "magenta"); 
        } 
      } 
    } 

    const isSt = G.starters.some(s=>s&&s.id===p.id); 
    const m = MENU.find(x=>x.id===p.menu)||MENU[0]; 
    let bG = 2.0; 
    let tM = 0.45; 
    if(m.s.length===1) tM=1.0; 
    if(m.s.length===2) tM=0.6; 
    if(m.s.length>=7) tM=0.15; 
    
    const part = isSt ? 1.0 : 0.25; 
    STATS.forEach(s => { 
      let g = 0.05; 
      if(m.s.includes(s.id)) g = bG*tM*sB*eB*part; 
      g *= GetGrowthMod(p.stats[s.id]); 
      p.stats[s.id] = Math.min(100, p.stats[s.id]+g); 
    }); 
  }); 
  
  // çµŒé¨“å€¤ãƒ­ã‚°
  Log("éƒ¨å“¡ãŸã¡ãŒçµŒé¨“å€¤ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚", "var(--text)");

  document.getElementById('m-end').style.display='block'; 
  if(win) { 
    if(G.match.name!=="ç·´ç¿’è©¦åˆ" && G.match.round<5) { 
      let nm=G.date.m, nd=G.date.d+7; 
      if(nd>30){nm++; nd-=30;} 
      if(nm>12)nm=1; 
      G.match.next = {m:nm, d:nd, name:G.match.name, round:G.match.round+1, isNat:G.match.isNat}; 
      document.getElementById('btn-next-rd').style.display='block'; 
    } else { 
      if(G.match.name!=="ç·´ç¿’è©¦åˆ") { 
        if(!G.match.isNat && (G.match.name.includes("IH")||G.match.name.includes("æ˜¥"))) { 
          let nm=G.date.m, nd=G.date.d+7; 
          if(nd>30){nm++; nd-=30;} 
          G.match.next = {m:nm, d:nd, name:G.match.name.replace("äºˆé¸",""), round:1, isNat:true}; 
          document.getElementById('btn-next-rd').style.display='block'; 
          Log("å…¨å›½ã¸ï¼","gold"); 
        } else { 
          Log("ğŸ† å„ªå‹ï¼","gold"); 
          if(G.match.name.includes("æ˜¥")) G.match.winSpr=true; 
          G.match.next=null; 
        } 
      } else G.match.next=null; 
    } 
  } else { 
    Log("æ•—é€€...","#aaa"); 
    G.match.next=null; 
  } 
  Save(); 
}
function Log(msg, col) { const d = document.createElement('div'); d.className = 'l-row'; d.style.color = col; d.innerText = msg; const b = document.getElementById('m-log'); b.prepend(d); }
function EndMatchUI() { document.getElementById('ui-match').style.display='none'; UpdateUI(); }
function ShowOrder() { tempOrder = [...G.starters]; const list = document.getElementById('ord-court'); list.innerHTML = ""; const mapIdx = [0, 1, 2, 5, 4, 3]; for(let i=0; i<6; i++) { const idx = mapIdx[i]; const isBack = i >= 3; const div = document.createElement('div'); div.className = "pos-edit" + (isBack ? " back" : ""); let posLbl = ""; if(idx===0) posLbl="å‰å·¦(4)"; else if(idx===1) posLbl="å‰ä¸­(3)"; else if(idx===2) posLbl="å‰å³(2)"; else if(idx===5) posLbl="å¾Œå·¦(5)"; else if(idx===4) posLbl="å¾Œä¸­(6)"; else if(idx===3) posLbl="å¾Œå³(1)SRV"; div.innerHTML = `<label>${posLbl}</label>`; const sel = document.createElement('select'); sel.innerHTML = `<option value="">---</option>` + G.team.filter(p=>p.pos!=='L').map(p=>`<option value="${p.id}" ${tempOrder[idx]&&tempOrder[idx].id===p.id?'selected':''}>${p.name} (${p.pos})</option>`).join(''); sel.onchange = function() { const nid = this.value; if(nid) { const dup = tempOrder.findIndex((p, x) => x!==idx && p && p.id===nid); if(dup !== -1) { const old = tempOrder[idx]; tempOrder[idx] = G.team.find(p=>p.id===nid); tempOrder[dup] = old; ShowOrder(); return; } tempOrder[idx] = G.team.find(p=>p.id===nid); } else { tempOrder[idx] = null; } }; div.appendChild(sel); list.appendChild(div); } const lsel = document.getElementById('sel-lib'); lsel.innerHTML = `<option value="">ãªã—</option>` + G.team.filter(p=>p.pos==='L').map(p => `<option value="${p.id}" ${G.libero&&G.libero.id===p.id?'selected':''}>${p.name}</option>`).join(''); document.getElementById('ui-order').style.display='flex'; }
function CommitOrder() { G.starters = [...tempOrder]; const lid = document.getElementById('sel-lib').value; G.libero = lid ? G.team.find(p=>p.id===lid) : null; document.getElementById('ui-order').style.display='none'; UpdateUI(); Save(); }
function CloseOrder() { CommitOrder(); }
function Save() { const d = { team: G.team, date: G.date, lv: G.lv, next: G.match.next, winSpr: G.match.winSpr, played: G.match.played, sIds: G.starters.map(p=>p?p.id:null), lId: G.libero?G.libero.id:null, pracMonth: G.pracMonth }; localStorage.setItem("EIKAN_V56_0_FINAL", JSON.stringify(d)); }
</script>
</body>
</html>
